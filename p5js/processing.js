<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1561.2">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Courier; -webkit-text-stroke: #000000; min-height: 16.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">/***</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>P R O C E S S I N G . J S - 1.4.1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>a port of the Processing visualization language</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Processing.js is licensed under the MIT License, see LICENSE.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>For a list of copyright holders, please refer to AUTHORS.</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>http://processingjs.org</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">***/</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">(function(window, document, Math, undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var nop = function() {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var debug = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if ("console" in window) return function(msg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>window.console.log("Processing.js: " + msg)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return nop</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var ajax = function(url) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var xhr = new XMLHttpRequest;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>xhr.open("GET", url, false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (xhr.overrideMimeType) xhr.overrideMimeType("text/plain");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>xhr.setRequestHeader("If-Modified-Since", "Fri, 01 Jan 1960 00:00:00 GMT");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>xhr.send(null);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (xhr.status !== 200 &amp;&amp; xhr.status !== 0) throw "XMLHttpRequest failed, status code " + xhr.status;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return xhr.responseText</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var isDOMPresent = "document" in this &amp;&amp; !("fake" in this.document);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>document.head = document.head || document.getElementsByTagName("head")[0];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function setupTypedArray(name, fallback) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (name in window) return window[name];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof window[fallback] === "function") return window[fallback];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return function(obj) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (obj instanceof Array) return obj;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof obj === "number") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arr = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>arr.length = obj;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if (document.documentMode &gt;= 9 &amp;&amp; !document.doctype) throw "The doctype directive is missing. The recommended doctype in Internet Explorer is the HTML5 doctype: &lt;!DOCTYPE html&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var Float32Array = setupTypedArray("Float32Array", "WebGLFloatArray"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Int32Array = setupTypedArray("Int32Array", "WebGLIntArray"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Uint16Array = setupTypedArray("Uint16Array", "WebGLUnsignedShortArray"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Uint8Array = setupTypedArray("Uint8Array", "WebGLUnsignedByteArray");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var PConstants = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>X: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Y: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Z: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>R: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>G: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>B: 5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>A: 6,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>U: 7,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>V: 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NX: 9,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NY: 10,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NZ: 11,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>EDGE: 12,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SR: 13,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SG: 14,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SB: 15,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SA: 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SW: 17,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TX: 18,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TY: 19,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TZ: 20,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>VX: 21,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>VY: 22,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>VZ: 23,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>VW: 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AR: 25,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AG: 26,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AB: 27,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DR: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DG: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DB: 5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DA: 6,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SPR: 28,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SPG: 29,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SPB: 30,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SHINE: 31,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ER: 32,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>EG: 33,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>EB: 34,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BEEN_LIT: 35,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>VERTEX_FIELD_COUNT: 36,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>P2D: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>JAVA2D: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>WEBGL: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>P3D: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>OPENGL: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PDF: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DXF: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>OTHER: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>WINDOWS: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MAXOSX: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>LINUX: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>EPSILON: 1.0E-4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MAX_FLOAT: 3.4028235E38,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MIN_FLOAT: -3.4028235E38,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MAX_INT: 2147483647,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MIN_INT: -2147483648,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PI: Math.PI,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TWO_PI: 2 * Math.PI,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>HALF_PI: Math.PI / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>THIRD_PI: Math.PI / 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>QUARTER_PI: Math.PI / 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DEG_TO_RAD: Math.PI / 180,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>RAD_TO_DEG: 180 / Math.PI,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>WHITESPACE: " \t\n\r\u000c\u00a0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>RGB: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ARGB: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>HSB: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ALPHA: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CMYK: 5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TIFF: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TARGA: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>JPEG: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>GIF: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BLUR: 11,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>GRAY: 12,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>INVERT: 13,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>OPAQUE: 14,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>POSTERIZE: 15,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>THRESHOLD: 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ERODE: 17,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DILATE: 18,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>REPLACE: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BLEND: 1 &lt;&lt; 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ADD: 1 &lt;&lt; 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SUBTRACT: 1 &lt;&lt; 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>LIGHTEST: 1 &lt;&lt; 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DARKEST: 1 &lt;&lt; 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DIFFERENCE: 1 &lt;&lt; 5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>EXCLUSION: 1 &lt;&lt; 6,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MULTIPLY: 1 &lt;&lt; 7,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SCREEN: 1 &lt;&lt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>OVERLAY: 1 &lt;&lt; 9,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>HARD_LIGHT: 1 &lt;&lt; 10,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SOFT_LIGHT: 1 &lt;&lt; 11,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DODGE: 1 &lt;&lt; 12,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BURN: 1 &lt;&lt; 13,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ALPHA_MASK: 4278190080,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>RED_MASK: 16711680,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>GREEN_MASK: 65280,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BLUE_MASK: 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CUSTOM: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ORTHOGRAPHIC: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PERSPECTIVE: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>POINT: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>POINTS: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>LINE: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>LINES: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TRIANGLE: 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TRIANGLES: 9,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TRIANGLE_STRIP: 10,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TRIANGLE_FAN: 11,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>QUAD: 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>QUADS: 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>QUAD_STRIP: 17,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>POLYGON: 20,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PATH: 21,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>RECT: 30,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ELLIPSE: 31,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ARC: 32,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SPHERE: 40,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BOX: 41,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>GROUP: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PRIMITIVE: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>GEOMETRY: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>VERTEX: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BEZIER_VERTEX: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CURVE_VERTEX: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BREAK: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CLOSESHAPE: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>OPEN: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CLOSE: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CORNER: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CORNERS: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>RADIUS: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CENTER_RADIUS: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CENTER: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DIAMETER: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CENTER_DIAMETER: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BASELINE: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TOP: 101,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BOTTOM: 102,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NORMAL: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NORMALIZED: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>IMAGE: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MODEL: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SHAPE: 5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SQUARE: "butt",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ROUND: "round",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PROJECT: "square",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MITER: "miter",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BEVEL: "bevel",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AMBIENT: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DIRECTIONAL: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SPOT: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>BACKSPACE: 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TAB: 9,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENTER: 10,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>RETURN: 13,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ESC: 27,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DELETE: 127,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CODED: 65535,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SHIFT: 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CONTROL: 17,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ALT: 18,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CAPSLK: 20,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PGUP: 33,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PGDN: 34,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>END: 35,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>HOME: 36,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>LEFT: 37,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>UP: 38,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>RIGHT: 39,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DOWN: 40,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F1: 112,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F2: 113,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F3: 114,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F4: 115,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F5: 116,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F6: 117,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F7: 118,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F8: 119,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F9: 120,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F10: 121,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F11: 122,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>F12: 123,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NUMLK: 144,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>META: 157,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>INSERT: 155,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ARROW: "default",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>CROSS: "crosshair",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>HAND: "pointer",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MOVE: "move",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>TEXT: "text",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>WAIT: "wait",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NOCURSOR: "url('data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=='), auto",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DISABLE_OPENGL_2X_SMOOTH: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENABLE_OPENGL_2X_SMOOTH: -1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENABLE_OPENGL_4X_SMOOTH: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENABLE_NATIVE_FONTS: 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DISABLE_DEPTH_TEST: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENABLE_DEPTH_TEST: -4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENABLE_DEPTH_SORT: 5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DISABLE_DEPTH_SORT: -5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DISABLE_OPENGL_ERROR_REPORT: 6,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENABLE_OPENGL_ERROR_REPORT: -6,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ENABLE_ACCURATE_TEXTURES: 7,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DISABLE_ACCURATE_TEXTURES: -7,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>HINT_COUNT: 10,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>SINCOS_LENGTH: 720,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PRECISIONB: 15,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PRECISIONF: 1 &lt;&lt; 15,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PREC_MAXVAL: (1 &lt;&lt; 15) - 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PREC_ALPHA_SHIFT: 24 - 15,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PREC_RED_SHIFT: 16 - 15,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NORMAL_MODE_AUTO: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NORMAL_MODE_SHAPE: 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>NORMAL_MODE_VERTEX: 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>MAX_LIGHTS: 8</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function virtHashCode(obj) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof obj === "string") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var hash = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; obj.length; ++i) hash = hash * 31 + obj.charCodeAt(i) &amp; 4294967295;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return hash</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof obj !== "object") return obj &amp; 4294967295;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (obj.hashCode instanceof Function) return obj.hashCode();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (obj.$id === undef) obj.$id = Math.floor(Math.random() * 65536) - 32768 &lt;&lt; 16 | Math.floor(Math.random() * 65536);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return obj.$id</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function virtEquals(obj, other) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (obj === null || other === null) return obj === null &amp;&amp; other === null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof obj === "string") return obj === other;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof obj !== "object") return obj === other;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (obj.equals instanceof Function) return obj.equals(other);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return obj === other</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var ObjectIterator = function(obj) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (obj.iterator instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Function) return obj.iterator();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (obj instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var index = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.hasNext = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ++index &lt; obj.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.next = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return obj[index]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>} else throw "Unable to iterate: " + obj;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var ArrayList = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function Iterator(array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var index = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.hasNext = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return index &lt; array.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.next = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return array[index++]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.remove = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>array.splice(index, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function ArrayList(a) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var array;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (a instanceof ArrayList) array = a.toArray();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>array = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof a === "number") array.length = a &gt; 0 ? a : 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.get = function(i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return array[i]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.contains = function(item) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.indexOf(item) &gt; -1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.indexOf = function(item) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, len = array.length; i &lt; len; ++i) if (virtEquals(item, array[i])) return i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return -1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.lastIndexOf = function(item) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = array.length - 1; i &gt;= 0; --i) if (virtEquals(item, array[i])) return i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return -1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.add = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) array.push(arguments[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var arg0 = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof arg0 === "number") if (arg0 &gt;= 0 &amp;&amp; arg0 &lt;= array.length) array.splice(arg0, 0, arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else throw arg0 + " is not a valid index";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else throw typeof arg0 + " is not a number";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else throw "Please use the proper number of parameters.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.addAll = function(arg1, arg2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var it;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof arg1 === "number") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (arg1 &lt; 0 || arg1 &gt; array.length) throw "Index out of bounds for addAll: " + arg1 + " greater or equal than " + array.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>it = new ObjectIterator(arg2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (it.hasNext()) array.splice(arg1++, 0, it.next())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>it = new ObjectIterator(arg1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (it.hasNext()) array.push(it.next())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.set = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var arg0 = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof arg0 === "number") if (arg0 &gt;= 0 &amp;&amp; arg0 &lt; array.length) array.splice(arg0, 1, arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else throw arg0 + " is not a valid index.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else throw typeof arg0 + " is not a number";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else throw "Please use the proper number of parameters.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.size = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return array.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.clear = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>array.length = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.remove = function(item) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof item === "number") return array.splice(item, 1)[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>item = this.indexOf(item);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (item &gt; -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>array.splice(item, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.removeAll = function(c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i, x, item, newList = new ArrayList;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>newList.addAll(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.clear();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0, x = 0; i &lt; newList.size(); i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>item = newList.get(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!c.contains(item)) this.add(x++, item)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.size() &lt; newList.size()) return true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.isEmpty = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return !array.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.clone = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new ArrayList(this)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.toArray = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return array.slice(0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.iterator = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new Iterator(array)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return ArrayList</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var HashMap = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function HashMap() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 1 &amp;&amp; arguments[0] instanceof HashMap) return arguments[0].clone();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var initialCapacity = arguments.length &gt; 0 ? arguments[0] : 16;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var loadFactor = arguments.length &gt; 1 ? arguments[1] : 0.75;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var buckets = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>buckets.length = initialCapacity;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var count = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var hashMap = this;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function getBucketIndex(key) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var index = virtHashCode(key) % buckets.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return index &lt; 0 ? buckets.length + index : index</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function ensureLoad() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (count &lt;= loadFactor * buckets.length) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var allEntries = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; buckets.length; ++i) if (buckets[i] !== undef) allEntries = allEntries.concat(buckets[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var newBucketsLength = buckets.length * 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>buckets = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>buckets.length = newBucketsLength;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = 0; j &lt; allEntries.length; ++j) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var index = getBucketIndex(allEntries[j].key);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var bucket = buckets[index];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (bucket === undef) buckets[index] = bucket = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>bucket.push(allEntries[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function Iterator(conversion, removeItem) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bucketIndex = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var itemIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var endOfBuckets = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var currentItem;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function findNext() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (!endOfBuckets) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>++itemIndex;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (bucketIndex &gt;= buckets.length) endOfBuckets = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>else if (buckets[bucketIndex] === undef || itemIndex &gt;= buckets[bucketIndex].length) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>itemIndex = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>++bucketIndex</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.hasNext = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return !endOfBuckets</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.next = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>currentItem = conversion(buckets[bucketIndex][itemIndex]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>findNext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return currentItem</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.remove = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (currentItem !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>removeItem(currentItem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>--itemIndex;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>findNext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>findNext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function Set(conversion, isIn, removeItem) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.clear = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>hashMap.clear()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.contains = function(o) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return isIn(o)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.containsAll = function(o) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var it = o.iterator();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (it.hasNext()) if (!this.contains(it.next())) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.isEmpty = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return hashMap.isEmpty()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.iterator = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return new Iterator(conversion, removeItem)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.remove = function(o) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (this.contains(o)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>removeItem(o);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.removeAll = function(c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var it = c.iterator();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var changed = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (it.hasNext()) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var item = it.next();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (this.contains(item)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>removeItem(item);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>changed = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.retainAll = function(c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var it = this.iterator();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var toRemove = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (it.hasNext()) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var entry = it.next();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!c.contains(entry)) toRemove.push(entry)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (var i = 0; i &lt; toRemove.length; ++i) removeItem(toRemove[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return toRemove.length &gt; 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.size = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return hashMap.size()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.toArray = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var result = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var it = this.iterator();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (it.hasNext()) result.push(it.next());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function Entry(pair) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this._isIn = function(map) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return map === hashMap &amp;&amp; pair.removed === undef</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.equals = function(o) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return virtEquals(pair.key, o.getKey())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.getKey = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return pair.key</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.getValue = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return pair.value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.hashCode = function(o) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return virtHashCode(pair.key)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.setValue = function(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var old = pair.value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pair.value = value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return old</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.clear = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>count = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>buckets = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>buckets.length = initialCapacity</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.clone = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var map = new HashMap;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>map.putAll(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return map</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.containsKey = function(key) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var index = getBucketIndex(key);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bucket = buckets[index];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (bucket === undef) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; bucket.length; ++i) if (virtEquals(bucket[i].key, key)) return true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.containsValue = function(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; buckets.length; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var bucket = buckets[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (bucket === undef) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (var j = 0; j &lt; bucket.length; ++j) if (virtEquals(bucket[j].value, value)) return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.entrySet = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new Set(function(pair) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return new Entry(pair)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function(pair) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return pair instanceof Entry &amp;&amp; pair._isIn(hashMap)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function(pair) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return hashMap.remove(pair.getKey())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.get = function(key) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var index = getBucketIndex(key);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bucket = buckets[index];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (bucket === undef) return null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; bucket.length; ++i) if (virtEquals(bucket[i].key, key)) return bucket[i].value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.isEmpty = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return count === 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.keySet = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new Set(function(pair) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return pair.key</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function(key) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return hashMap.containsKey(key)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function(key) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return hashMap.remove(key)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.values = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new Set(function(pair) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return pair.value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return hashMap.containsValue(value)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return hashMap.removeByValue(value)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.put = function(key, value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var index = getBucketIndex(key);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bucket = buckets[index];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (bucket === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>++count;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>buckets[index] = [{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>key: key,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>value: value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>ensureLoad();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; bucket.length; ++i) if (virtEquals(bucket[i].key, key)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var previous = bucket[i].value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>bucket[i].value = value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return previous</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}++count;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bucket.push({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>key: key,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>value: value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ensureLoad();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.putAll = function(m) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var it = m.entrySet().iterator();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (it.hasNext()) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var entry = it.next();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.put(entry.getKey(), entry.getValue())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.remove = function(key) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var index = getBucketIndex(key);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bucket = buckets[index];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (bucket === undef) return null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; bucket.length; ++i) if (virtEquals(bucket[i].key, key)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>--count;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var previous = bucket[i].value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>bucket[i].removed = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (bucket.length &gt; 1) bucket.splice(i, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else buckets[index] = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return previous</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.removeByValue = function(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bucket, i, ilen, pair;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (bucket in buckets) if (buckets.hasOwnProperty(bucket)) for (i = 0, ilen = buckets[bucket].length; i &lt; ilen; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pair = buckets[bucket][i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (pair.value === value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>buckets[bucket].splice(i, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.size = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return count</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return HashMap</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var PVector = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function PVector(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.x = x || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.y = y || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.z = z || 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PVector.dist = function(v1, v2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return v1.dist(v2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PVector.dot = function(v1, v2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return v1.dot(v2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PVector.cross = function(v1, v2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return v1.cross(v2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PVector.angleBetween = function(v1, v2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return Math.acos(v1.dot(v2) / (v1.mag() * v2.mag()))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PVector.prototype = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>set: function(v, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) this.set(v.x || v[0] || 0, v.y || v[1] || 0, v.z || v[2] || 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x = v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y = y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z = z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>get: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new PVector(this.x, this.y, this.z)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mag: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var x = this.x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = this.y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>z = this.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return Math.sqrt(x * x + y * y + z * z)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>add: function(v, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x += v.x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y += v.y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z += v.z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x += v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y += y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z += z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sub: function(v, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x -= v.x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y -= v.y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z -= v.z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x -= v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y -= y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z -= z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mult: function(v) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof v === "number") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x *= v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y *= v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z *= v</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x *= v.x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y *= v.y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z *= v.z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>div: function(v) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof v === "number") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x /= v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y /= v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z /= v</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.x /= v.x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.y /= v.y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.z /= v.z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>dist: function(v) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var dx = this.x - v.x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>dy = this.y - v.y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>dz = this.z - v.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return Math.sqrt(dx * dx + dy * dy + dz * dz)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>dot: function(v, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) return this.x * v.x + this.y * v.y + this.z * v.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.x * v + this.y * y + this.z * z</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cross: function(v) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var x = this.x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = this.y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>z = this.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new PVector(y * v.z - v.y * z, z * v.x - v.z * x, x * v.y - v.x * y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalize: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var m = this.mag();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (m &gt; 0) this.div(m)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>limit: function(high) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.mag() &gt; high) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.normalize();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.mult(high)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>heading2D: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return -Math.atan2(-this.y, this.x)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>toString: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "[" + this.x + ", " + this.y + ", " + this.z + "]"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>array: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [this.x, this.y, this.z]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function createPVectorMethod(method) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return function(v1, v2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var v = v1.get();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v[method](v2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return v</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (var method in PVector.prototype) if (PVector.prototype.hasOwnProperty(method) &amp;&amp; !PVector.hasOwnProperty(method)) PVector[method] = createPVectorMethod(method);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return PVector</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function DefaultScope() {}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>DefaultScope.prototype = PConstants;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var defaultScope = new DefaultScope;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.ArrayList = ArrayList;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.HashMap = HashMap;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.PVector = PVector;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.ObjectIterator = ObjectIterator;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.PConstants = PConstants;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.defineProperty = function(obj, name, desc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if ("defineProperty" in Object) Object.defineProperty(obj, name, desc);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (desc.hasOwnProperty("get")) obj.__defineGetter__(name, desc.get);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (desc.hasOwnProperty("set")) obj.__defineSetter__(name, desc.set)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function overloadBaseClassFunction(object, name, basefn) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (!object.hasOwnProperty(name) || typeof object[name] !== "function") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>object[name] = basefn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var fn = object[name];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if ("$overloads" in fn) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fn.$defaultOverload = basefn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (! ("$overloads" in basefn) &amp;&amp; fn.length === basefn.length) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var overloads, defaultOverload;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if ("$overloads" in basefn) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>overloads = basefn.$overloads.slice(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>overloads[fn.length] = fn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>defaultOverload = basefn.$defaultOverload</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>overloads = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>overloads[basefn.length] = basefn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>overloads[fn.length] = fn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>defaultOverload = fn</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var hubfn = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fn = hubfn.$overloads[arguments.length] || ("$methodArgsIndex" in hubfn &amp;&amp; arguments.length &gt; hubfn.$methodArgsIndex ? hubfn.$overloads[hubfn.$methodArgsIndex] : null) || hubfn.$defaultOverload;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return fn.apply(this, arguments)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>hubfn.$overloads = overloads;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if ("$methodArgsIndex" in basefn) hubfn.$methodArgsIndex = basefn.$methodArgsIndex;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>hubfn.$defaultOverload = defaultOverload;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>hubfn.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>object[name] = hubfn</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function extendClass(subClass, baseClass) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function extendGetterSetter(propertyName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>defaultScope.defineProperty(subClass, propertyName, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>get: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return baseClass[propertyName]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>set: function(v) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>baseClass[propertyName] = v</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>enumerable: true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var properties = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (var propertyName in baseClass) if (typeof baseClass[propertyName] === "function") overloadBaseClassFunction(subClass, propertyName, baseClass[propertyName]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>else if (propertyName.charAt(0) !== "$" &amp;&amp; !(propertyName in subClass)) properties.push(propertyName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>while (properties.length &gt; 0) extendGetterSetter(properties.shift());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>subClass.$super = baseClass</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.extendClassChain = function(base) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var path = [base];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (var self = base.$upcast; self; self = self.$upcast) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>extendClass(self, base);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>path.push(self);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>base = self</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>while (path.length &gt; 0) path.pop().$self = base</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.extendStaticMembers = function(derived, base) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>extendClass(derived, base)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.extendInterfaceMembers = function(derived, base) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>extendClass(derived, base)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.addMethod = function(object, name, fn, hasMethodArgs) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var existingfn = object[name];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (existingfn || hasMethodArgs) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var args = fn.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if ("$overloads" in existingfn) existingfn.$overloads[args] = fn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var hubfn = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var fn = hubfn.$overloads[arguments.length] || ("$methodArgsIndex" in hubfn &amp;&amp; arguments.length &gt; hubfn.$methodArgsIndex ? hubfn.$overloads[hubfn.$methodArgsIndex] : null) || hubfn.$defaultOverload;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return fn.apply(this, arguments)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var overloads = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (existingfn) overloads[existingfn.length] = existingfn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>overloads[args] = fn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hubfn.$overloads = overloads;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hubfn.$defaultOverload = existingfn || fn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (hasMethodArgs) hubfn.$methodArgsIndex = args;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hubfn.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>object[name] = hubfn</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>} else object[name] = fn</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function isNumericalJavaType(type) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof type !== "string") return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return ["byte", "int", "char", "color", "float", "long", "double"].indexOf(type) !== -1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.createJavaArray = function(type, bounds) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var result = null,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>defaultValue = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof type === "string") if (type === "boolean") defaultValue = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>else if (isNumericalJavaType(type)) defaultValue = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof bounds[0] === "number") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var itemsCount = 0 | bounds[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (bounds.length &lt;= 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result.length = itemsCount;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; itemsCount; ++i) result[i] = defaultValue</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var newBounds = bounds.slice(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = 0; j &lt; itemsCount; ++j) result.push(defaultScope.createJavaArray(type, newBounds))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var colors = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>aliceblue: "#f0f8ff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>antiquewhite: "#faebd7",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>aqua: "#00ffff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>aquamarine: "#7fffd4",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>azure: "#f0ffff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>beige: "#f5f5dc",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>bisque: "#ffe4c4",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>black: "#000000",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blanchedalmond: "#ffebcd",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blue: "#0000ff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blueviolet: "#8a2be2",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>brown: "#a52a2a",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>burlywood: "#deb887",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>cadetblue: "#5f9ea0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>chartreuse: "#7fff00",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>chocolate: "#d2691e",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>coral: "#ff7f50",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>cornflowerblue: "#6495ed",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>cornsilk: "#fff8dc",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>crimson: "#dc143c",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>cyan: "#00ffff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkblue: "#00008b",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkcyan: "#008b8b",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkgoldenrod: "#b8860b",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkgray: "#a9a9a9",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkgreen: "#006400",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkkhaki: "#bdb76b",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkmagenta: "#8b008b",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkolivegreen: "#556b2f",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkorange: "#ff8c00",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkorchid: "#9932cc",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkred: "#8b0000",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darksalmon: "#e9967a",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkseagreen: "#8fbc8f",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkslateblue: "#483d8b",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkslategray: "#2f4f4f",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkturquoise: "#00ced1",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>darkviolet: "#9400d3",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>deeppink: "#ff1493",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>deepskyblue: "#00bfff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>dimgray: "#696969",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>dodgerblue: "#1e90ff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>firebrick: "#b22222",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>floralwhite: "#fffaf0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>forestgreen: "#228b22",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fuchsia: "#ff00ff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>gainsboro: "#dcdcdc",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ghostwhite: "#f8f8ff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>gold: "#ffd700",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>goldenrod: "#daa520",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>gray: "#808080",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>green: "#008000",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>greenyellow: "#adff2f",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>honeydew: "#f0fff0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>hotpink: "#ff69b4",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>indianred: "#cd5c5c",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>indigo: "#4b0082",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ivory: "#fffff0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>khaki: "#f0e68c",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lavender: "#e6e6fa",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lavenderblush: "#fff0f5",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lawngreen: "#7cfc00",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lemonchiffon: "#fffacd",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightblue: "#add8e6",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightcoral: "#f08080",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightcyan: "#e0ffff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightgoldenrodyellow: "#fafad2",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightgrey: "#d3d3d3",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightgreen: "#90ee90",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightpink: "#ffb6c1",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightsalmon: "#ffa07a",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightseagreen: "#20b2aa",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightskyblue: "#87cefa",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightslategray: "#778899",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightsteelblue: "#b0c4de",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lightyellow: "#ffffe0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>lime: "#00ff00",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>limegreen: "#32cd32",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>linen: "#faf0e6",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>magenta: "#ff00ff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>maroon: "#800000",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumaquamarine: "#66cdaa",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumblue: "#0000cd",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumorchid: "#ba55d3",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumpurple: "#9370d8",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumseagreen: "#3cb371",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumslateblue: "#7b68ee",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumspringgreen: "#00fa9a",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumturquoise: "#48d1cc",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mediumvioletred: "#c71585",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>midnightblue: "#191970",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mintcream: "#f5fffa",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>mistyrose: "#ffe4e1",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>moccasin: "#ffe4b5",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>navajowhite: "#ffdead",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>navy: "#000080",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>oldlace: "#fdf5e6",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>olive: "#808000",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>olivedrab: "#6b8e23",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>orange: "#ffa500",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>orangered: "#ff4500",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>orchid: "#da70d6",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>palegoldenrod: "#eee8aa",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>palegreen: "#98fb98",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>paleturquoise: "#afeeee",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>palevioletred: "#d87093",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>papayawhip: "#ffefd5",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>peachpuff: "#ffdab9",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>peru: "#cd853f",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>pink: "#ffc0cb",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>plum: "#dda0dd",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>powderblue: "#b0e0e6",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>purple: "#800080",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>red: "#ff0000",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>rosybrown: "#bc8f8f",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>royalblue: "#4169e1",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>saddlebrown: "#8b4513",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>salmon: "#fa8072",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>sandybrown: "#f4a460",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>seagreen: "#2e8b57",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>seashell: "#fff5ee",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>sienna: "#a0522d",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>silver: "#c0c0c0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>skyblue: "#87ceeb",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>slateblue: "#6a5acd",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>slategray: "#708090",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>snow: "#fffafa",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>springgreen: "#00ff7f",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>steelblue: "#4682b4",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>tan: "#d2b48c",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>teal: "#008080",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>thistle: "#d8bfd8",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>tomato: "#ff6347",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>turquoise: "#40e0d0",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>violet: "#ee82ee",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>wheat: "#f5deb3",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>white: "#ffffff",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>whitesmoke: "#f5f5f5",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>yellow: "#ffff00",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>yellowgreen: "#9acd32"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>(function(Processing) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var unsupportedP5 = ("open() createOutput() createInput() BufferedReader selectFolder() " + "dataPath() createWriter() selectOutput() beginRecord() " + "saveStream() endRecord() selectInput() saveBytes() createReader() " + "beginRaw() endRaw() PrintWriter delay()").split(" "),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>count = unsupportedP5.length,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>prettyName, p5Name;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function createUnsupportedFunc(n) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>throw "Processing.js does not support " + n + ".";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>while (count--) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>prettyName = unsupportedP5[count];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p5Name = prettyName.replace("()", "");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>Processing[p5Name] = createUnsupportedFunc(prettyName)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>})(defaultScope);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.defineProperty(defaultScope, "screenWidth", {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>get: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return window.innerWidth</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.defineProperty(defaultScope, "screenHeight", {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>get: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return window.innerHeight</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.defineProperty(defaultScope, "online", {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>get: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var processingInstances = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var processingInstanceIds = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var removeInstance = function(id) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>processingInstances.splice(processingInstanceIds[id], 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>delete processingInstanceIds[id]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var addInstance = function(processing) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (processing.externals.canvas.id === undef || !processing.externals.canvas.id.length) processing.externals.canvas.id = "__processing" + processingInstances.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>processingInstanceIds[processing.externals.canvas.id] = processingInstances.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>processingInstances.push(processing)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function computeFontMetrics(pfont) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var emQuad = 250,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>correctionFactor = pfont.size / emQuad,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>canvas = document.createElement("canvas");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>canvas.width = 2 * emQuad;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>canvas.height = 2 * emQuad;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>canvas.style.opacity = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var cfmFont = pfont.getCSSDefinition(emQuad + "px", "normal"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ctx = canvas.getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ctx.font = cfmFont;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var protrusions = "dbflkhyjqpg";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>canvas.width = ctx.measureText(protrusions).width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ctx.font = cfmFont;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var leadDiv = document.createElement("div");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>leadDiv.style.position = "absolute";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>leadDiv.style.opacity = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>leadDiv.style.fontFamily = '"' + pfont.name + '"';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>leadDiv.style.fontSize = emQuad + "px";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>leadDiv.innerHTML = protrusions + "&lt;br/&gt;" + protrusions;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>document.body.appendChild(leadDiv);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var w = canvas.width,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>h = canvas.height,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>baseline = h / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ctx.fillStyle = "white";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ctx.fillRect(0, 0, w, h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ctx.fillStyle = "black";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ctx.fillText(protrusions, 0, baseline);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var pixelData = ctx.getImageData(0, 0, w, h).data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var i = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>w4 = w * 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>len = pixelData.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>while (++i &lt; len &amp;&amp; pixelData[i] === 255) nop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var ascent = Math.round(i / w4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>i = len - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>while (--i &gt; 0 &amp;&amp; pixelData[i] === 255) nop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var descent = Math.round(i / w4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>pfont.ascent = correctionFactor * (baseline - ascent);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>pfont.descent = correctionFactor * (descent - baseline);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (document.defaultView.getComputedStyle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var leadDivHeight = document.defaultView.getComputedStyle(leadDiv, null).getPropertyValue("height");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>leadDivHeight = correctionFactor * leadDivHeight.replace("px", "");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (leadDivHeight &gt;= pfont.size * 2) pfont.leading = Math.round(leadDivHeight / 2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>document.body.removeChild(leadDiv);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (pfont.caching) return ctx</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function PFont(name, size) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (name === undef) name = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (size === undef) size = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.size = size;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.glyph = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.ascent = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.descent = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.leading = 1.2 * size;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var illegalIndicator = name.indexOf(" Italic Bold");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (illegalIndicator !== -1) name = name.substring(0, illegalIndicator);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.style = "normal";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var italicsIndicator = name.indexOf(" Italic");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (italicsIndicator !== -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>name = name.substring(0, italicsIndicator);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.style = "italic"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.weight = "normal";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var boldIndicator = name.indexOf(" Bold");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (boldIndicator !== -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>name = name.substring(0, boldIndicator);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.weight = "bold"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.family = "sans-serif";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (name !== undef) switch (name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>case "sans-serif":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>case "serif":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>case "monospace":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>case "fantasy":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>case "cursive":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>default:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = '"' + name + '", sans-serif';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.context2d = computeFontMetrics(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.css = this.getCSSDefinition();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (this.context2d) this.context2d.font = this.css</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.prototype.caching = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.prototype.getCSSDefinition = function(fontSize, lineHeight) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (fontSize === undef) fontSize = this.size + "px";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (lineHeight === undef) lineHeight = this.leading + "px";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var components = [this.style, "normal", this.weight, fontSize + "/" + lineHeight, this.family];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return components.join(" ")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.prototype.measureTextWidth = function(string) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return this.context2d.measureText(string).width</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.prototype.measureTextWidthFallback = function(string) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var canvas = document.createElement("canvas"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ctx = canvas.getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>ctx.font = this.css;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return ctx.measureText(string).width</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.PFontCache = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>length: 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.get = function(fontName, fontSize) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fontSize = (fontSize * 10 + 0.5 | 0) / 10;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var cache = PFont.PFontCache,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>idx = fontName + "/" + fontSize;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (!cache[idx]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cache[idx] = new PFont(fontName, fontSize);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cache.length++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (cache.length === 50) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PFont.prototype.measureTextWidth = PFont.prototype.measureTextWidthFallback;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PFont.prototype.caching = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var entry;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (entry in cache) if (entry !== "length") cache[entry].context2d = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new PFont(fontName, fontSize)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (cache.length === 400) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PFont.PFontCache = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PFont.get = PFont.getFallback;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new PFont(fontName, fontSize)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return cache[idx]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.getFallback = function(fontName, fontSize) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return new PFont(fontName, fontSize)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.list = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return ["sans-serif", "serif", "monospace", "fantasy", "cursive"]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>PFont.preloading = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>template: {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>initialized: false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>initialize: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var generateTinyFont = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var encoded = "#E3KAI2wAgT1MvMg7Eo3VmNtYX7ABi3CxnbHlm" + "7Abw3kaGVhZ7ACs3OGhoZWE7A53CRobXR47AY3" + "AGbG9jYQ7G03Bm1heH7ABC3CBuYW1l7Ae3AgcG" + "9zd7AI3AE#B3AQ2kgTY18PPPUACwAg3ALSRoo3" + "#yld0xg32QAB77#E777773B#E3C#I#Q77773E#" + "Q7777777772CMAIw7AB77732B#M#Q3wAB#g3B#" + "E#E2BB//82BB////w#B7#gAEg3E77x2B32B#E#" + "Q#MTcBAQ32gAe#M#QQJ#E32M#QQJ#I#g32Q77#";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var expand = function(input) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return "AAAAAAAA".substr(~~input ? 7 - input : 6)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return encoded.replace(/[#237]/g, expand)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fontface = document.createElement("style");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fontface.setAttribute("type", "text/css");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fontface.innerHTML = "@font-face {\n" + '<span class="Apple-converted-space">  </span>font-family: "PjsEmptyFont";' + "\n" + "<span class="Apple-converted-space">  </span>src: url('data:application/x-font-ttf;base64," + generateTinyFont() + "')\n" + " <span class="Apple-converted-space">      </span>format('truetype');\n" + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>document.head.appendChild(fontface);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var element = document.createElement("span");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>element.style.cssText = 'position: absolute; top: 0; left: 0; opacity: 0; font-family: "PjsEmptyFont", fantasy;';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>element.innerHTML = "AAAAAAAA";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>document.body.appendChild(element);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.template = element;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.initialized = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>getElementWidth: function(element) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return document.defaultView.getComputedStyle(element, "").getPropertyValue("width")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>timeAttempted: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>pending: function(intervallength) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!this.initialized) this.initialize();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var element, computedWidthFont, computedWidthRef = this.getElementWidth(this.template);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; this.fontList.length; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>element = this.fontList[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>computedWidthFont = this.getElementWidth(element);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.timeAttempted &lt; 4E3 &amp;&amp; computedWidthFont === computedWidthRef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.timeAttempted += intervallength;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>document.body.removeChild(element);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fontList.splice(i--, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.timeAttempted = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.fontList.length === 0) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fontList: [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>addedList: {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>add: function(fontSrc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!this.initialized) this.initialize();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fontName = typeof fontSrc === "object" ? fontSrc.fontFace : fontSrc,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fontUrl = typeof fontSrc === "object" ? fontSrc.url : fontSrc;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.addedList[fontName]) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var style = document.createElement("style");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setAttribute("type", "text/css");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.innerHTML = "@font-face{\n<span class="Apple-converted-space">  </span>font-family: '" + fontName + "';\n<span class="Apple-converted-space">  </span>src:<span class="Apple-converted-space">  </span>url('" + fontUrl + "');\n}\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>document.head.appendChild(style);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.addedList[fontName] = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var element = document.createElement("span");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>element.style.cssText = "position: absolute; top: 0; left: 0; opacity: 0;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>element.style.fontFamily = '"' + fontName + '", "PjsEmptyFont", fantasy';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>element.innerHTML = "AAAAAAAA";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>document.body.appendChild(element);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fontList.push(element)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>defaultScope.PFont = PFont;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var Processing = this.Processing = function(aCanvas, aCode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (! (this instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Processing)) throw "called Processing constructor as if it were a function: missing 'new'.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var curElement, pgraphicsMode = aCanvas === undef &amp;&amp; aCode === undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (pgraphicsMode) curElement = document.createElement("canvas");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>else curElement = typeof aCanvas === "string" ? document.getElementById(aCanvas) : aCanvas;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (! (curElement instanceof HTMLCanvasElement)) throw "called Processing constructor without passing canvas element reference or id.";</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function unimplemented(s) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>Processing.debug("Unimplemented - " + s)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var p = this;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.externals = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>canvas: curElement,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>context: undef,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sketch: undef</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.name = "Processing.js Instance";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.use3DContext = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.focused = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.breakShape = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.glyphTable = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.pmouseX = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.pmouseY = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseX = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseY = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseButton = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseScroll = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseClicked = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseDragged = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseMoved = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mousePressed = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseReleased = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseScrolled = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseOver = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mouseOut = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.touchStart = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.touchEnd = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.touchMove = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.touchCancel = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.key = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.keyCode = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.keyPressed = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.keyReleased = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.keyTyped = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.draw = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.setup = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__mousePressed = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__keyPressed = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__frameRate = 60;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.frameCount = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.width = 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.height = 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var curContext, curSketch, drawing, online = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doFill = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fillStyle = [1, 1, 1, 1],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentFillColor = 4294967295,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isFillDirty = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doStroke = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>strokeStyle = [0, 0, 0, 1],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentStrokeColor = 4278190080,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isStrokeDirty = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lineWidth = 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>loopStarted = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>renderSmooth = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doLoop = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>looping = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curRectMode = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curEllipseMode = 3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalX = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalY = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalZ = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalMode = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curFrameRate = 60,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curMsPerFrame = 1E3 / curFrameRate,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curCursor = 'default',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>oldCursor = curElement.style.cursor,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curShape = 20,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curShapeCount = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curvePoints = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTightness = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveDet = 20,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveInited = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>backgroundObj = -3355444,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>bezDetail = 20,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>colorModeA = 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>colorModeX = 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>colorModeY = 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>colorModeZ = 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pathOpen = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mouseDragging = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pmouseXLastFrame = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pmouseYLastFrame = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curColorMode = 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTint = null,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTint3d = null,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getLoaded = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>start = Date.now(),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>timeSinceLastFPS = start,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>framesSinceLastFPS = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>textcanvas, curveBasisMatrix, curveToBezierMatrix, curveDrawMatrix, bezierDrawMatrix, bezierBasisInverse, bezierBasisMatrix, curContextCache = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>attributes: {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>locations: {}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>programObject3D, programObject2D, programObjectUnlitShape, boxBuffer, boxNormBuffer, boxOutlineBuffer, rectBuffer, rectNormBuffer, sphereBuffer, lineBuffer, fillBuffer, fillColorBuffer, strokeColorBuffer, pointBuffer, shapeTexVBO, canTex, textTex, curTexture = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>width: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>height: 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextureMode = 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>usingTexture = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>textBuffer, textureBuffer, indexBuffer, horizontalTextAlignment = 37,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>verticalTextAlignment = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>textMode = 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curFontName = "Arial",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextSize = 12,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextAscent = 9,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextDescent = 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextLeading = 14,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextFont = PFont.get(curFontName, curTextSize),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>originalContext, proxyContext = null,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isContextReplaced = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setPixelsCached, maxPixelsCached = 1E3,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pressedKeysMap = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lastPressedKeyCode = null,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>codedKeys = [16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>17, 18, 20, 33, 34, 35, 36, 37, 38, 39, 40, 144, 155, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 157];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var stylePaddingLeft, stylePaddingTop, styleBorderLeft, styleBorderTop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (document.defaultView &amp;&amp; document.defaultView.getComputedStyle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>stylePaddingLeft = parseInt(document.defaultView.getComputedStyle(curElement, null)["paddingLeft"], 10) || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>stylePaddingTop = parseInt(document.defaultView.getComputedStyle(curElement, null)["paddingTop"], 10) || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>styleBorderLeft = parseInt(document.defaultView.getComputedStyle(curElement, null)["borderLeftWidth"], 10) || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>styleBorderTop = parseInt(document.defaultView.getComputedStyle(curElement, null)["borderTopWidth"], 10) || 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var lightCount = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var sphereDetailV = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereDetailU = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereX = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereY = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereZ = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sinLUT = new Float32Array(720),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cosLUT = new Float32Array(720),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts, sphereNorms;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var cam, cameraInv, modelView, modelViewInv, userMatrixStack, userReverseMatrixStack, inverseCopy, projection, manipulatingCamera = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>frustumMode = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraFOV = 60 * (Math.PI / 180),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraX = p.width / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraY = p.height / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraZ = cameraY / Math.tan(cameraFOV / 2),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraNear = cameraZ / 10,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraFar = cameraZ * 10,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraAspect = p.width / p.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var vertArray = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertArray = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertCount = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isCurve = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isBezier = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>firstVert = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var curShapeMode = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var styleArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var boxVerts = new Float32Array([0.5, 0.5, -0.5, 0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, 0.5, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5, 0.5, -0.5, 0.5, 0.5, -0.5, -0.5, 0.5, -0.5, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, -0.5, 0.5, 0.5, 0.5, 0.5, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5, -0.5, -0.5, 0.5, 0.5, -0.5, 0.5, -0.5, -0.5, 0.5, -0.5, 0.5, -0.5, -0.5, 0.5, -0.5, -0.5, 0.5, -0.5, -0.5, -0.5, 0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, 0.5, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5, -0.5, 0.5, -0.5, -0.5, -0.5, -0.5, 0.5, 0.5, 0.5, 0.5, 0.5, -0.5, -0.5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>0.5, -0.5, -0.5, 0.5, -0.5, -0.5, 0.5, 0.5, 0.5, 0.5, 0.5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var boxOutlineVerts = new Float32Array([0.5, 0.5, 0.5, 0.5, -0.5, 0.5, 0.5, 0.5, -0.5, 0.5, -0.5, -0.5, -0.5, 0.5, -0.5, -0.5, -0.5, -0.5, -0.5, 0.5, 0.5, -0.5, -0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, -0.5, 0.5, 0.5, -0.5, -0.5, 0.5, -0.5, -0.5, 0.5, -0.5, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, -0.5, 0.5, 0.5, -0.5, -0.5, 0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, 0.5, -0.5, -0.5, 0.5, 0.5, -0.5, 0.5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var boxNorms = new Float32Array([0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, 1, 0, 0, 1, 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var rectVerts = new Float32Array([0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var rectNorms = new Float32Array([0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var vertexShaderSrcUnlitShape = "varying vec4 vFrontColor;" + "attribute vec3 aVertex;" + "attribute vec4 aColor;" + "uniform mat4 uView;" + "uniform mat4 uProjection;" + "uniform float uPointSize;" + "void main(void) {" + "<span class="Apple-converted-space">  </span>vFrontColor = aColor;" + "<span class="Apple-converted-space">  </span>gl_PointSize = uPointSize;" + "<span class="Apple-converted-space">  </span>gl_Position = uProjection * uView * vec4(aVertex, 1.0);" + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var fragmentShaderSrcUnlitShape = "#ifdef GL_ES\n" + "precision highp float;\n" + "#endif\n" + "varying vec4 vFrontColor;" + "uniform bool uSmooth;" + "void main(void){" + "<span class="Apple-converted-space">  </span>if(uSmooth == true){" + "<span class="Apple-converted-space">    </span>float dist = distance(gl_PointCoord, vec2(0.5));" + "<span class="Apple-converted-space">    </span>if(dist &gt; 0.5){" + "<span class="Apple-converted-space">      </span>discard;" + "<span class="Apple-converted-space">    </span>}" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>gl_FragColor = vFrontColor;" + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var vertexShaderSrc2D = "varying vec4 vFrontColor;" + "attribute vec3 aVertex;" + "attribute vec2 aTextureCoord;" + "uniform vec4 uColor;" + "uniform mat4 uModel;" + "uniform mat4 uView;" + "uniform mat4 uProjection;" + "uniform float uPointSize;" + "varying vec2 vTextureCoord;" + "void main(void) {" + "<span class="Apple-converted-space">  </span>gl_PointSize = uPointSize;" + "<span class="Apple-converted-space">  </span>vFrontColor = uColor;" + "<span class="Apple-converted-space">  </span>gl_Position = uProjection * uView * uModel * vec4(aVertex, 1.0);" + "<span class="Apple-converted-space">  </span>vTextureCoord = aTextureCoord;" + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var fragmentShaderSrc2D = "#ifdef GL_ES\n" + "precision highp float;\n" + "#endif\n" + "varying vec4 vFrontColor;" + "varying vec2 vTextureCoord;" + "uniform sampler2D uSampler;" + "uniform int uIsDrawingText;" + "uniform bool uSmooth;" + "void main(void){" + "<span class="Apple-converted-space">  </span>if(uSmooth == true){" + "<span class="Apple-converted-space">    </span>float dist = distance(gl_PointCoord, vec2(0.5));" + "<span class="Apple-converted-space">    </span>if(dist &gt; 0.5){" + "<span class="Apple-converted-space">      </span>discard;" + "<span class="Apple-converted-space">    </span>}" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>if(uIsDrawingText == 1){" + "<span class="Apple-converted-space">    </span>float alpha = texture2D(uSampler, vTextureCoord).a;" + "<span class="Apple-converted-space">    </span>gl_FragColor = vec4(vFrontColor.rgb * alpha, alpha);" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>else{" + "<span class="Apple-converted-space">    </span>gl_FragColor = vFrontColor;" + "<span class="Apple-converted-space">  </span>}" + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var webglMaxTempsWorkaround = /Windows/.test(navigator.userAgent);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var vertexShaderSrc3D = "varying vec4 vFrontColor;" + "attribute vec3 aVertex;" + "attribute vec3 aNormal;" + "attribute vec4 aColor;" + "attribute vec2 aTexture;" + "varying <span class="Apple-converted-space">  </span>vec2 vTexture;" + "uniform vec4 uColor;" + "uniform bool uUsingMat;" + "uniform vec3 uSpecular;" + "uniform vec3 uMaterialEmissive;" + "uniform vec3 uMaterialAmbient;" + "uniform vec3 uMaterialSpecular;" + "uniform float uShininess;" + "uniform mat4 uModel;" + "uniform mat4 uView;" + "uniform mat4 uProjection;" + "uniform mat4 uNormalTransform;" + "uniform int uLightCount;" + "uniform vec3 uFalloff;" + "struct Light {" + "<span class="Apple-converted-space">  </span>int type;" + "<span class="Apple-converted-space">  </span>vec3 color;" + "<span class="Apple-converted-space">  </span>vec3 position;" + "<span class="Apple-converted-space">  </span>vec3 direction;" + "<span class="Apple-converted-space">  </span>float angle;" + "<span class="Apple-converted-space">  </span>vec3 halfVector;" + "<span class="Apple-converted-space">  </span>float concentration;" + "};" + "uniform Light uLights0;" + "uniform Light uLights1;" + "uniform Light uLights2;" + "uniform Light uLights3;" + "uniform Light uLights4;" + "uniform Light uLights5;" + "uniform Light uLights6;" + "uniform Light uLights7;" + "Light getLight(int index){" + "<span class="Apple-converted-space">  </span>if(index == 0) return uLights0;" + "<span class="Apple-converted-space">  </span>if(index == 1) return uLights1;" + "<span class="Apple-converted-space">  </span>if(index == 2) return uLights2;" + "<span class="Apple-converted-space">  </span>if(index == 3) return uLights3;" + "<span class="Apple-converted-space">  </span>if(index == 4) return uLights4;" + "<span class="Apple-converted-space">  </span>if(index == 5) return uLights5;" + "<span class="Apple-converted-space">  </span>if(index == 6) return uLights6;" + "<span class="Apple-converted-space">  </span>return uLights7;" + "}" + "void AmbientLight( inout vec3 totalAmbient, in vec3 ecPos, in Light light ) {" + "<span class="Apple-converted-space">  </span>float d = length( light.position - ecPos );" + "<span class="Apple-converted-space">  </span>float attenuation = 1.0 / ( uFalloff[0] + ( uFalloff[1] * d ) + ( uFalloff[2] * d * d ));" + "<span class="Apple-converted-space">  </span>totalAmbient += light.color * attenuation;" + "}" + "void DirectionalLight( inout vec3 col, inout vec3 spec, in vec3 vertNormal, in vec3 ecPos, in Light light ) {" + "<span class="Apple-converted-space">  </span>float powerFactor = 0.0;" + "<span class="Apple-converted-space">  </span>float nDotVP = max(0.0, dot( vertNormal, normalize(-light.position) ));" + "<span class="Apple-converted-space">  </span>float nDotVH = max(0.0, dot( vertNormal, normalize(-light.position-normalize(ecPos) )));" + "<span class="Apple-converted-space">  </span>if( nDotVP != 0.0 ){" + "<span class="Apple-converted-space">    </span>powerFactor = pow( nDotVH, uShininess );" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>col += light.color * nDotVP;" + "<span class="Apple-converted-space">  </span>spec += uSpecular * powerFactor;" + "}" + "void PointLight( inout vec3 col, inout vec3 spec, in vec3 vertNormal, in vec3 ecPos, in Light light ) {" + "<span class="Apple-converted-space">  </span>float powerFactor;" + " <span class="Apple-converted-space">  </span>vec3 VP = light.position - ecPos;" + "<span class="Apple-converted-space">  </span>float d = length( VP ); " + "<span class="Apple-converted-space">  </span>VP = normalize( VP );" + "<span class="Apple-converted-space">  </span>float attenuation = 1.0 / ( uFalloff[0] + ( uFalloff[1] * d ) + ( uFalloff[2] * d * d ));" + "<span class="Apple-converted-space">  </span>float nDotVP = max( 0.0, dot( vertNormal, VP ));" + "<span class="Apple-converted-space">  </span>vec3 halfVector = normalize( VP - normalize(ecPos) );" + "<span class="Apple-converted-space">  </span>float nDotHV = max( 0.0, dot( vertNormal, halfVector ));" + "<span class="Apple-converted-space">  </span>if( nDotVP == 0.0 ) {" + "<span class="Apple-converted-space">    </span>powerFactor = 0.0;" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>else {" + "<span class="Apple-converted-space">    </span>powerFactor = pow( nDotHV, uShininess );" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>spec += uSpecular * powerFactor * attenuation;" + "<span class="Apple-converted-space">  </span>col += light.color * nDotVP * attenuation;" + "}" + "void SpotLight( inout vec3 col, inout vec3 spec, in vec3 vertNormal, in vec3 ecPos, in Light light ) {" + "<span class="Apple-converted-space">  </span>float spotAttenuation;" + "<span class="Apple-converted-space">  </span>float powerFactor = 0.0;" + "<span class="Apple-converted-space">  </span>vec3 VP = light.position - ecPos;" + "<span class="Apple-converted-space">  </span>vec3 ldir = normalize( -light.direction );" + "<span class="Apple-converted-space">  </span>float d = length( VP );" + "<span class="Apple-converted-space">  </span>VP = normalize( VP );" + "<span class="Apple-converted-space">  </span>float attenuation = 1.0 / ( uFalloff[0] + ( uFalloff[1] * d ) + ( uFalloff[2] * d * d ) );" + "<span class="Apple-converted-space">  </span>float spotDot = dot( VP, ldir );" + (webglMaxTempsWorkaround ? "<span class="Apple-converted-space">  </span>spotAttenuation = 1.0; " : "<span class="Apple-converted-space">  </span>if( spotDot &gt; cos( light.angle ) ) {" + "<span class="Apple-converted-space">    </span>spotAttenuation = pow( spotDot, light.concentration );" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>else{" + "<span class="Apple-converted-space">    </span>spotAttenuation = 0.0;" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>attenuation *= spotAttenuation;" + "") + "<span class="Apple-converted-space">  </span>float nDotVP = max( 0.0, dot( vertNormal, VP ) );" + "<span class="Apple-converted-space">  </span>vec3 halfVector = normalize( VP - normalize(ecPos) );" + "<span class="Apple-converted-space">  </span>float nDotHV = max( 0.0, dot( vertNormal, halfVector ) );" + "<span class="Apple-converted-space">  </span>if( nDotVP != 0.0 ) {" + "<span class="Apple-converted-space">    </span>powerFactor = pow( nDotHV, uShininess );" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>spec += uSpecular * powerFactor * attenuation;" + "<span class="Apple-converted-space">  </span>col += light.color * nDotVP * attenuation;" + "}" + "void main(void) {" + "<span class="Apple-converted-space">  </span>vec3 finalAmbient = vec3( 0.0 );" + "<span class="Apple-converted-space">  </span>vec3 finalDiffuse = vec3( 0.0 );" + "<span class="Apple-converted-space">  </span>vec3 finalSpecular = vec3( 0.0 );" + "<span class="Apple-converted-space">  </span>vec4 col = uColor;" + "<span class="Apple-converted-space">  </span>if ( uColor[0] == -1.0 ){" + "<span class="Apple-converted-space">    </span>col = aColor;" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>vec3 norm = normalize(vec3( uNormalTransform * vec4( aNormal, 0.0 ) ));" + "<span class="Apple-converted-space">  </span>vec4 ecPos4 = uView * uModel * vec4(aVertex, 1.0);" + "<span class="Apple-converted-space">  </span>vec3 ecPos = (vec3(ecPos4))/ecPos4.w;" + "<span class="Apple-converted-space">  </span>if( uLightCount == 0 ) {" + "<span class="Apple-converted-space">    </span>vFrontColor = col + vec4(uMaterialSpecular, 1.0);" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>else {" + "<span class="Apple-converted-space">    </span>for( int i = 0; i &lt; 8; i++ ) {" + "<span class="Apple-converted-space">      </span>Light l = getLight(i);" + "<span class="Apple-converted-space">      </span>if( i &gt;= uLightCount ){" + "<span class="Apple-converted-space">        </span>break;" + "<span class="Apple-converted-space">      </span>}" + "<span class="Apple-converted-space">      </span>if( l.type == 0 ) {" + "<span class="Apple-converted-space">        </span>AmbientLight( finalAmbient, ecPos, l );" + "<span class="Apple-converted-space">      </span>}" + "<span class="Apple-converted-space">      </span>else if( l.type == 1 ) {" + "<span class="Apple-converted-space">        </span>DirectionalLight( finalDiffuse, finalSpecular, norm, ecPos, l );" + "<span class="Apple-converted-space">      </span>}" + "<span class="Apple-converted-space">      </span>else if( l.type == 2 ) {" + "<span class="Apple-converted-space">        </span>PointLight( finalDiffuse, finalSpecular, norm, ecPos, l );" + "<span class="Apple-converted-space">      </span>}" + "<span class="Apple-converted-space">      </span>else {" + "<span class="Apple-converted-space">        </span>SpotLight( finalDiffuse, finalSpecular, norm, ecPos, l );" + "<span class="Apple-converted-space">      </span>}" + "<span class="Apple-converted-space">    </span>}" + " <span class="Apple-converted-space">  </span>if( uUsingMat == false ) {" + " <span class="Apple-converted-space">    </span>vFrontColor = vec4(" + " <span class="Apple-converted-space">      </span>vec3( col ) * finalAmbient +" + " <span class="Apple-converted-space">      </span>vec3( col ) * finalDiffuse +" + " <span class="Apple-converted-space">      </span>vec3( col ) * finalSpecular," + " <span class="Apple-converted-space">      </span>col[3] );" + " <span class="Apple-converted-space">  </span>}" + " <span class="Apple-converted-space">  </span>else{" + " <span class="Apple-converted-space">    </span>vFrontColor = vec4( " + " <span class="Apple-converted-space">      </span>uMaterialEmissive + " + " <span class="Apple-converted-space">      </span>(vec3(col) * uMaterialAmbient * finalAmbient ) + " + " <span class="Apple-converted-space">      </span>(vec3(col) * finalDiffuse) + " + " <span class="Apple-converted-space">      </span>(uMaterialSpecular * finalSpecular), " + " <span class="Apple-converted-space">      </span>col[3] );" + "<span class="Apple-converted-space">    </span>}" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>vTexture.xy = aTexture.xy;" + "<span class="Apple-converted-space">  </span>gl_Position = uProjection * uView * uModel * vec4( aVertex, 1.0 );" + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var fragmentShaderSrc3D = "#ifdef GL_ES\n" + "precision highp float;\n" + "#endif\n" + "varying vec4 vFrontColor;" + "uniform sampler2D uSampler;" + "uniform bool uUsingTexture;" + "varying vec2 vTexture;" + "void main(void){" + "<span class="Apple-converted-space">  </span>if( uUsingTexture ){" + "<span class="Apple-converted-space">    </span>gl_FragColor = vec4(texture2D(uSampler, vTexture.xy)) * vFrontColor;" + "<span class="Apple-converted-space">  </span>}" + "<span class="Apple-converted-space">  </span>else{" + "<span class="Apple-converted-space">    </span>gl_FragColor = vFrontColor;" + "<span class="Apple-converted-space">  </span>}" + "}";</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function uniformf(cacheId, programObj, varName, varValue) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var varLocation = curContextCache.locations[cacheId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>varLocation = curContext.getUniformLocation(programObj, varName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContextCache.locations[cacheId] = varLocation</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation !== null) if (varValue.length === 4) curContext.uniform4fv(varLocation, varValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (varValue.length === 3) curContext.uniform3fv(varLocation, varValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (varValue.length === 2) curContext.uniform2fv(varLocation, varValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else curContext.uniform1f(varLocation, varValue)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function uniformi(cacheId, programObj, varName, varValue) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var varLocation = curContextCache.locations[cacheId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>varLocation = curContext.getUniformLocation(programObj, varName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContextCache.locations[cacheId] = varLocation</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation !== null) if (varValue.length === 4) curContext.uniform4iv(varLocation, varValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (varValue.length === 3) curContext.uniform3iv(varLocation, varValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (varValue.length === 2) curContext.uniform2iv(varLocation, varValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else curContext.uniform1i(varLocation, varValue)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function uniformMatrix(cacheId, programObj, varName, transpose, matrix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var varLocation = curContextCache.locations[cacheId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>varLocation = curContext.getUniformLocation(programObj, varName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContextCache.locations[cacheId] = varLocation</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation !== -1) if (matrix.length === 16) curContext.uniformMatrix4fv(varLocation, transpose, matrix);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (matrix.length === 9) curContext.uniformMatrix3fv(varLocation, transpose, matrix);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else curContext.uniformMatrix2fv(varLocation, transpose, matrix)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function vertexAttribPointer(cacheId, programObj, varName, size, VBO) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var varLocation = curContextCache.attributes[cacheId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>varLocation = curContext.getAttribLocation(programObj, varName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContextCache.attributes[cacheId] = varLocation</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation !== -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, VBO);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.vertexAttribPointer(varLocation, size, curContext.FLOAT, false, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.enableVertexAttribArray(varLocation)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function disableVertexAttribPointer(cacheId, programObj, varName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var varLocation = curContextCache.attributes[cacheId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>varLocation = curContext.getAttribLocation(programObj, varName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContextCache.attributes[cacheId] = varLocation</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (varLocation !== -1) curContext.disableVertexAttribArray(varLocation)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var createProgramObject = function(curContext, vetexShaderSource, fragmentShaderSource) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vertexShaderObject = curContext.createShader(curContext.VERTEX_SHADER);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.shaderSource(vertexShaderObject, vetexShaderSource);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.compileShader(vertexShaderObject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!curContext.getShaderParameter(vertexShaderObject, curContext.COMPILE_STATUS)) throw curContext.getShaderInfoLog(vertexShaderObject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fragmentShaderObject = curContext.createShader(curContext.FRAGMENT_SHADER);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.shaderSource(fragmentShaderObject, fragmentShaderSource);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.compileShader(fragmentShaderObject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!curContext.getShaderParameter(fragmentShaderObject, curContext.COMPILE_STATUS)) throw curContext.getShaderInfoLog(fragmentShaderObject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var programObject = curContext.createProgram();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.attachShader(programObject, vertexShaderObject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.attachShader(programObject, fragmentShaderObject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.linkProgram(programObject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!curContext.getProgramParameter(programObject, curContext.LINK_STATUS)) throw "Error linking shaders.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return programObject</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var imageModeCorner = function(x, y, w, h, whAreSizes) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x: x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y: y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>w: w,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>h: h</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var imageModeConvert = imageModeCorner;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var imageModeCorners = function(x, y, w, h, whAreSizes) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x: x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y: y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>w: whAreSizes ? w : w - x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>h: whAreSizes ? h : h - y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var imageModeCenter = function(x, y, w, h, whAreSizes) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x: x - w / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y: y - h / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>w: w,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>h: h</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var DrawingShared = function() {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var Drawing2D = function() {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var Drawing3D = function() {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var DrawingPre = function() {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype = new DrawingShared;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.constructor = Drawing2D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype = new DrawingShared;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.constructor = Drawing3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype = new DrawingShared;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.constructor = DrawingPre;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingShared.prototype.a3DOnlyFunction = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var charMap = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var Char = p.Character = function(chr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof chr === "string" &amp;&amp; chr.length === 1) this.code = chr.charCodeAt(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (typeof chr === "number") this.code = chr;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (chr instanceof Char) this.code = chr;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else this.code = NaN;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return charMap[this.code] === undef ? charMap[this.code] = this : charMap[this.code]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Char.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return String.fromCharCode(this.code)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Char.prototype.valueOf = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.code</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var PShape = p.PShape = function(family) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = family || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.visible = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.style = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.children = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.nameTable = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.image = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.matrix = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.kind = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.close = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.width = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.height = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.parent = null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShape.prototype = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isVisible: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.visible</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setVisible: function(visible) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.visible = visible</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>disableStyle: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.style = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.children.length; i &lt; j; i++) this.children[i].disableStyle()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>enableStyle: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.style = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.children.length; i &lt; j; i++) this.children[i].enableStyle()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getFamily: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.family</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getWidth: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.width</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getHeight: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.height</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setName: function(name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.name = name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getName: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>draw: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderContext = renderContext || p;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.visible) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.pre(renderContext);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.drawImpl(renderContext);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.post(renderContext)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawImpl: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.family === 0) this.drawGroup(renderContext);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.family === 1) this.drawPrimitive(renderContext);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.family === 3) this.drawGeometry(renderContext);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.family === 21) this.drawPath(renderContext)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawPath: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i, j;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.vertices.length === 0) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderContext.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.vertexCodes.length === 0) if (this.vertices[0].length === 2) for (i = 0, j = this.vertices.length; i &lt; j; i++) renderContext.vertex(this.vertices[i][0], this.vertices[i][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else for (i = 0, j = this.vertices.length; i &lt; j; i++) renderContext.vertex(this.vertices[i][0], this.vertices[i][1], this.vertices[i][2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var index = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (this.vertices[0].length === 2) for (i = 0, j = this.vertexCodes.length; i &lt; j; i++) if (this.vertexCodes[i] === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.vertex(this.vertices[index][0], this.vertices[index][1], this.vertices[index]["moveTo"]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.breakShape = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>index++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (this.vertexCodes[i] === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.bezierVertex(this.vertices[index + 0][0], this.vertices[index + 0][1], this.vertices[index + 1][0], this.vertices[index + 1][1], this.vertices[index + 2][0], this.vertices[index + 2][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>index += 3</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (this.vertexCodes[i] === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.curveVertex(this.vertices[index][0], this.vertices[index][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>index++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (this.vertexCodes[i] === 3) renderContext.breakShape = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else for (i = 0, j = this.vertexCodes.length; i &lt; j; i++) if (this.vertexCodes[i] === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.vertex(this.vertices[index][0], this.vertices[index][1], this.vertices[index][2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (this.vertices[index]["moveTo"] === true) vertArray[vertArray.length - 1]["moveTo"] = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>else if (this.vertices[index]["moveTo"] === false) vertArray[vertArray.length - 1]["moveTo"] = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.breakShape = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (this.vertexCodes[i] === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.bezierVertex(this.vertices[index + 0][0], this.vertices[index + 0][1], this.vertices[index + 0][2], this.vertices[index + 1][0], this.vertices[index + 1][1], this.vertices[index + 1][2], this.vertices[index + 2][0], this.vertices[index + 2][1], this.vertices[index + 2][2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>index += 3</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (this.vertexCodes[i] === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>renderContext.curveVertex(this.vertices[index][0], this.vertices[index][1], this.vertices[index][2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>index++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (this.vertexCodes[i] === 3) renderContext.breakShape = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderContext.endShape(this.close ? 2 : 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawGeometry: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i, j;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderContext.beginShape(this.kind);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.style) for (i = 0, j = this.vertices.length; i &lt; j; i++) renderContext.vertex(this.vertices[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else for (i = 0, j = this.vertices.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var vert = this.vertices[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (vert[2] === 0) renderContext.vertex(vert[0], vert[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else renderContext.vertex(vert[0], vert[1], vert[2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>renderContext.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawGroup: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.children.length; i &lt; j; i++) this.children[i].draw(renderContext)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawPrimitive: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.kind === 2) renderContext.point(this.params[0], this.params[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.kind === 4) if (this.params.length === 4) renderContext.line(this.params[0], this.params[1], this.params[2], this.params[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else renderContext.line(this.params[0], this.params[1], this.params[2], this.params[3], this.params[4], this.params[5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.kind === 8) renderContext.triangle(this.params[0], this.params[1], this.params[2], this.params[3], this.params[4], this.params[5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.kind === 16) renderContext.quad(this.params[0], this.params[1], this.params[2], this.params[3], this.params[4], this.params[5], this.params[6], this.params[7]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.kind === 30) if (this.image !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var imMode = imageModeConvert;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.imageMode(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.image(this.image, this.params[0], this.params[1], this.params[2], this.params[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>imageModeConvert = imMode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var rcMode = curRectMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.rectMode(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.rect(this.params[0], this.params[1], this.params[2], this.params[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curRectMode = rcMode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (this.kind === 31) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var elMode = curEllipseMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.ellipseMode(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.ellipse(this.params[0], this.params[1], this.params[2], this.params[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curEllipseMode = elMode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (this.kind === 32) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var eMode = curEllipseMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.ellipseMode(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.arc(this.params[0], this.params[1], this.params[2], this.params[3], this.params[4], this.params[5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curEllipseMode = eMode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (this.kind === 41) if (this.params.length === 1) renderContext.box(this.params[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else renderContext.box(this.params[0], this.params[1], this.params[2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (this.kind === 40) renderContext.sphere(this.params[0])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pre: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.matrix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.pushMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.transform(this.matrix)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.style) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.pushStyle();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.styles(renderContext)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>post: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.matrix) renderContext.popMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.style) renderContext.popStyle()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>styles: function(renderContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.stroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.stroke(this.strokeColor);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.strokeWeight(this.strokeWeight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.strokeCap(this.strokeCap);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>renderContext.strokeJoin(this.strokeJoin)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else renderContext.noStroke();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.fill) renderContext.fill(this.fillColor);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else renderContext.noFill()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getChild: function(child) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i, j;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof child === "number") return this.children[child];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var found;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (child === "" || this.name === child) return this;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.nameTable.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0, j = this.nameTable.length; i &lt; j || found; i++) if (this.nameTable[i].getName === child) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>found = this.nameTable[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (found) return found</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0, j = this.children.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>found = this.children[i].getChild(child);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (found) return found</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getChildCount: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.children.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>addChild: function(child) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.children.push(child);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>child.parent = this;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (child.getName() !== null) this.addName(child.getName(), child)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>addName: function(name, shape) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.parent !== null) this.parent.addName(name, shape);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else this.nameTable.push([name, shape])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>translate: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.translate(arguments[0], arguments[1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.translate(arguments[0], arguments[1], 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>checkMatrix: function(dimensions) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.matrix === null) if (dimensions === 2) this.matrix = new p.PMatrix2D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else this.matrix = new p.PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (dimensions === 3 &amp;&amp; this.matrix instanceof p.PMatrix2D) this.matrix = new p.PMatrix3D</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotateX: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.rotate(angle, 1, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotateY: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.rotate(angle, 0, 1, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotateZ: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.rotate(angle, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotate: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.rotate(arguments[0])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.rotate(arguments[0], arguments[1], arguments[2], arguments[3])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>scale: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.scale(arguments[0], arguments[1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (arguments.length === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.scale(arguments[0], arguments[1], arguments[2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.scale(arguments[0])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>resetMatrix: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.matrix.reset()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>applyMatrix: function(matrix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) this.applyMatrix(matrix.elements[0], matrix.elements[1], 0, matrix.elements[2], matrix.elements[3], matrix.elements[4], 0, matrix.elements[5], 0, 0, 1, 0, 0, 0, 0, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 6) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.apply(arguments[0], arguments[1], arguments[2], 0, arguments[3], arguments[4], arguments[5], 0, 0, 0, 1, 0, 0, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (arguments.length === 16) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.checkMatrix(3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.matrix.apply(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7], arguments[8], arguments[9], arguments[10], arguments[11], arguments[12], arguments[13], arguments[14], arguments[15])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var PShapeSVG = p.PShapeSVG = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.PShape.call(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.element = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.vertexCodes = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.vertices = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.opacity = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.stroke = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeColor = 4278190080;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeWeight = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeCap = 'butt';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeJoin = 'miter';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeGradient = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeGradientPaint = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeName = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeOpacity = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fill = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillColor = 4278190080;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillGradient = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillGradientPaint = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillName = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillOpacity = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.element.getName() !== "svg") throw "root is not &lt;svg&gt;, it's &lt;" + this.element.getName() + "&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (arguments.length === 2) if (typeof arguments[1] === "string") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments[1].indexOf(".svg") &gt; -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.element = new p.XMLElement(p, arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.vertexCodes = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.vertices = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.opacity = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.stroke = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeColor = 4278190080;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeWeight = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeCap = 'butt';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeJoin = 'miter';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeGradient = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeGradientPaint = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeName = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.strokeOpacity = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fill = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fillColor = 4278190080;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fillGradient = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fillGradientPaint = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fillOpacity = 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (arguments[0]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.element = arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.vertexCodes = arguments[0].vertexCodes.slice();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.vertices = arguments[0].vertices.slice();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.stroke = arguments[0].stroke;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeColor = arguments[0].strokeColor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeWeight = arguments[0].strokeWeight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeCap = arguments[0].strokeCap;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeJoin = arguments[0].strokeJoin;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeGradient = arguments[0].strokeGradient;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeGradientPaint = arguments[0].strokeGradientPaint;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeName = arguments[0].strokeName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fill = arguments[0].fill;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillColor = arguments[0].fillColor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillGradient = arguments[0].fillGradient;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillGradientPaint = arguments[0].fillGradientPaint;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillName = arguments[0].fillName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeOpacity = arguments[0].strokeOpacity;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillOpacity = arguments[0].fillOpacity;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.opacity = arguments[0].opacity</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = this.element.getStringAttribute("id");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var displayStr = this.element.getStringAttribute("display", "inline");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.visible = displayStr !== "none";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var str = this.element.getAttribute("transform");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (str) this.matrix = this.parseMatrix(str);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var viewBoxStr = this.element.getStringAttribute("viewBox");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (viewBoxStr !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var viewBox = viewBoxStr.split(" ");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.width = viewBox[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.height = viewBox[3]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var unitWidth = this.element.getStringAttribute("width");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var unitHeight = this.element.getStringAttribute("height");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (unitWidth !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.width = this.parseUnitSize(unitWidth);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.height = this.parseUnitSize(unitHeight)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (this.width === 0 || this.height === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.width = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.height = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>throw "The width and/or height is not " + "readable in the &lt;svg&gt; tag of this file.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.parseColors(this.element);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.parseChildren(this.element)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype = new PShape;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function getCoords(s) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var m = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>s.replace(/\((.*?)\)/, function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return function(all, params) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>m = params.replace(/,+/g, " ").split(/\s+/)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return m</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return function(str) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.checkMatrix(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var pieces = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>str.replace(/\s*(\w+)\((.*?)\)/g, function(all) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pieces.push(p.trim(all))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (pieces.length === 0) return null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = pieces.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var m = getCoords(pieces[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (pieces[i].indexOf("matrix") !== -1) this.matrix.set(m[0], m[2], m[4], m[1], m[3], m[5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (pieces[i].indexOf("translate") !== -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var tx = m[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var ty = m.length === 2 ? m[1] : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.matrix.translate(tx, ty)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (pieces[i].indexOf("scale") !== -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var sx = m[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var sy = m.length === 2 ? m[1] : m[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.matrix.scale(sx, sy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (pieces[i].indexOf("rotate") !== -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var angle = m[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (m.length === 1) this.matrix.rotate(p.radians(angle));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>else if (m.length === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.matrix.translate(m[1], m[2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.matrix.rotate(p.radians(m[0]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.matrix.translate(-m[1], -m[2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (pieces[i].indexOf("skewX") !== -1) this.matrix.skewX(parseFloat(m[0]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (pieces[i].indexOf("skewY") !== -1) this.matrix.skewY(m[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (pieces[i].indexOf("shearX") !== -1) this.matrix.shearX(m[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (pieces[i].indexOf("shearY") !== -1) this.matrix.shearY(m[0])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.matrix</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseChildren = function(element) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var newelement = element.getChildren();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var children = new p.PShape;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, j = newelement.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var kid = this.parseChild(newelement[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (kid) children.addChild(kid)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.children.push(children)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.getName = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseChild = function(elem) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var name = elem.getName();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var shape;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (name === "g") shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (name === "defs") shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (name === "line") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.parseLine()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (name === "circle") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.parseEllipse(true)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (name === "ellipse") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.parseEllipse(false)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (name === "rect") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.parseRect()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (name === "polygon") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.parsePoly(true)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (name === "polyline") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.parsePoly(false)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (name === "path") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape = new PShapeSVG(this, elem);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.parsePath()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (name === "radialGradient") unimplemented("PShapeSVG.prototype.parseChild, name = radialGradient");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (name === "linearGradient") unimplemented("PShapeSVG.prototype.parseChild, name = linearGradient");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (name === "text") unimplemented("PShapeSVG.prototype.parseChild, name = text");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (name === "filter") unimplemented("PShapeSVG.prototype.parseChild, name = filter");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (name === "mask") unimplemented("PShapeSVG.prototype.parseChild, name = mask");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else nop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return shape</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePath = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = 21;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.kind = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pathDataChars = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pathData = p.trim(this.element.getStringAttribute("d").replace(/[\s,]+/g, " "));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (pathData === null) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pathData = p.__toCharArray(pathData);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var cx = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cy = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctrlX = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctrlY = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctrlX1 = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctrlX2 = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctrlY1 = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctrlY2 = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>endX = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>endY = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ppx = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ppy = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>px = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>py = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>i = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>valOf = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var str = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tmpArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var flag = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lastInstruction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var command;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var j, k;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (i &lt; pathData.length) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>valOf = pathData[i].valueOf();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (valOf &gt;= 65 &amp;&amp; valOf &lt;= 90 || valOf &gt;= 97 &amp;&amp; valOf &lt;= 122) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>j = i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>i++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (i &lt; pathData.length) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>tmpArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>valOf = pathData[i].valueOf();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>while (! (valOf &gt;= 65 &amp;&amp; valOf &lt;= 90 || valOf &gt;= 97 &amp;&amp; valOf &lt;= 100 || valOf &gt;= 102 &amp;&amp; valOf &lt;= 122) &amp;&amp; flag === false) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (valOf === 32) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (str !== "") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                  </span>tmpArray.push(parseFloat(str));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                  </span>str = ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>i++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>} else if (valOf === 45) if (pathData[i - 1].valueOf() === 101) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>str += pathData[i].toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>i++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>if (str !== "") tmpArray.push(parseFloat(str));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>str = pathData[i].toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>i++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>str += pathData[i].toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>i++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (i === pathData.length) flag = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>else valOf = pathData[i].valueOf()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (str !== "") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>tmpArray.push(parseFloat(str));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>str = ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>command = pathData[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>valOf = command.valueOf();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (valOf === 77) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 2 &amp;&amp; tmpArray.length % 2 === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = tmpArray[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = tmpArray[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathMoveto(cx, cy);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (tmpArray.length &gt; 2) for (j = 2, k = tmpArray.length; j &lt; k; j += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>cx = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>cy = tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 109) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 2 &amp;&amp; tmpArray.length % 2 === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx += tmpArray[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy += tmpArray[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathMoveto(cx, cy);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (tmpArray.length &gt; 2) for (j = 2, k = tmpArray.length; j &lt; k; j += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>cx += tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>cy += tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 76) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 2 &amp;&amp; tmpArray.length % 2 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 108) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 2 &amp;&amp; tmpArray.length % 2 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx += tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy += tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 72) for (j = 0, k = tmpArray.length; j &lt; k; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cx = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 104) for (j = 0, k = tmpArray.length; j &lt; k; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cx += tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 86) for (j = 0, k = tmpArray.length; j &lt; k; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cy = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 118) for (j = 0, k = tmpArray.length; j &lt; k; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cy += tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.parsePathLineto(cx, cy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 67) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 6 &amp;&amp; tmpArray.length % 6 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 6) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX1 = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY1 = tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX2 = tmpArray[j + 2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY2 = tmpArray[j + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = tmpArray[j + 4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = tmpArray[j + 5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathCurveto(ctrlX1, ctrlY1, ctrlX2, ctrlY2, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 99) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 6 &amp;&amp; tmpArray.length % 6 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 6) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX1 = cx + tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY1 = cy + tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX2 = cx + tmpArray[j + 2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY2 = cy + tmpArray[j + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = cx + tmpArray[j + 4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = cy + tmpArray[j + 5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathCurveto(ctrlX1, ctrlY1, ctrlX2, ctrlY2, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 83) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 4 &amp;&amp; tmpArray.length % 4 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (lastInstruction.toLowerCase() === "c" || lastInstruction.toLowerCase() === "s") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppx = this.vertices[this.vertices.length - 2][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppy = this.vertices[this.vertices.length - 2][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>px = this.vertices[this.vertices.length - 1][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>py = this.vertices[this.vertices.length - 1][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX1 = px + (px - ppx);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY1 = py + (py - ppy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX1 = this.vertices[this.vertices.length - 1][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY1 = this.vertices[this.vertices.length - 1][1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX2 = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY2 = tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = tmpArray[j + 2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = tmpArray[j + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathCurveto(ctrlX1, ctrlY1, ctrlX2, ctrlY2, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 115) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 4 &amp;&amp; tmpArray.length % 4 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (lastInstruction.toLowerCase() === "c" || lastInstruction.toLowerCase() === "s") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppx = this.vertices[this.vertices.length - 2][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppy = this.vertices[this.vertices.length - 2][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>px = this.vertices[this.vertices.length - 1][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>py = this.vertices[this.vertices.length - 1][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX1 = px + (px - ppx);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY1 = py + (py - ppy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX1 = this.vertices[this.vertices.length - 1][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY1 = this.vertices[this.vertices.length - 1][1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX2 = cx + tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY2 = cy + tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = cx + tmpArray[j + 2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = cy + tmpArray[j + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathCurveto(ctrlX1, ctrlY1, ctrlX2, ctrlY2, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 81) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 4 &amp;&amp; tmpArray.length % 4 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY = tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = tmpArray[j + 2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = tmpArray[j + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathQuadto(cx, cy, ctrlX, ctrlY, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 113) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 4 &amp;&amp; tmpArray.length % 4 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlX = cx + tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>ctrlY = cy + tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = cx + tmpArray[j + 2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = cy + tmpArray[j + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathQuadto(cx, cy, ctrlX, ctrlY, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 84) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 2 &amp;&amp; tmpArray.length % 2 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (lastInstruction.toLowerCase() === "q" || lastInstruction.toLowerCase() === "t") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppx = this.vertices[this.vertices.length - 2][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppy = this.vertices[this.vertices.length - 2][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>px = this.vertices[this.vertices.length - 1][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>py = this.vertices[this.vertices.length - 1][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX = px + (px - ppx);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY = py + (py - ppy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX = cx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY = cy</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathQuadto(cx, cy, ctrlX, ctrlY, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 116) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (tmpArray.length &gt;= 2 &amp;&amp; tmpArray.length % 2 === 0) for (j = 0, k = tmpArray.length; j &lt; k; j += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (lastInstruction.toLowerCase() === "q" || lastInstruction.toLowerCase() === "t") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppx = this.vertices[this.vertices.length - 2][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ppy = this.vertices[this.vertices.length - 2][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>px = this.vertices[this.vertices.length - 1][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>py = this.vertices[this.vertices.length - 1][1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX = px + (px - ppx);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY = py + (py - ppy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlX = cx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>ctrlY = cy</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endX = cx + tmpArray[j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>endY = cy + tmpArray[j + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>this.parsePathQuadto(cx, cy, ctrlX, ctrlY, endX, endY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = endX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = endY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (valOf === 90 || valOf === 122) this.close = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lastInstruction = command.toString()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else i++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePathQuadto = function(x1, y1, cx, cy, x2, y2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.vertices.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathCode(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathVertex(x1 + (cx - x1) * 2 / 3, y1 + (cy - y1) * 2 / 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathVertex(x2 + (cx - x2) * 2 / 3, y2 + (cy - y2) * 2 / 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathVertex(x2, y2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else throw "Path must start with M/m";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePathCurveto = function(x1, y1, x2, y2, x3, y3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.vertices.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathCode(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathVertex(x1, y1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathVertex(x2, y2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathVertex(x3, y3)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else throw "Path must start with M/m";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePathLineto = function(px, py) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.vertices.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathCode(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.parsePathVertex(px, py);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.vertices[this.vertices.length - 1]["moveTo"] = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else throw "Path must start with M/m";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePathMoveto = function(px, py) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.vertices.length &gt; 0) this.parsePathCode(3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.parsePathCode(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.parsePathVertex(px, py);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.vertices[this.vertices.length - 1]["moveTo"] = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePathVertex = function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var verts = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>verts[0] = x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>verts[1] = y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.vertices.push(verts)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePathCode = function(what) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.vertexCodes.push(what)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parsePoly = function(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = 21;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.close = val;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pointsAttr = p.trim(this.element.getStringAttribute("points").replace(/[,\s]+/g, " "));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (pointsAttr !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var pointsBuffer = pointsAttr.split(" ");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (pointsBuffer.length % 2 === 0) for (var i = 0, j = pointsBuffer.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var verts = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>verts[0] = pointsBuffer[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>verts[1] = pointsBuffer[++i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.vertices.push(verts)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else throw "Error parsing polygon points: odd number of coordinates provided";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseRect = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.kind = 30;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[0] = this.element.getFloatAttribute("x");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[1] = this.element.getFloatAttribute("y");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[2] = this.element.getFloatAttribute("width");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[3] = this.element.getFloatAttribute("height");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.params[2] &lt; 0 || this.params[3] &lt; 0) throw "svg error: negative width or height found while parsing &lt;rect&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseEllipse = function(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.kind = 31;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[0] = this.element.getFloatAttribute("cx") | 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[1] = this.element.getFloatAttribute("cy") | 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var rx, ry;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>rx = ry = this.element.getFloatAttribute("r");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (rx &lt; 0) throw "svg error: negative radius found while parsing &lt;circle&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>rx = this.element.getFloatAttribute("rx");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ry = this.element.getFloatAttribute("ry");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (rx &lt; 0 || ry &lt; 0) throw "svg error: negative x-axis radius or y-axis radius found while parsing &lt;ellipse&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[0] -= rx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[1] -= ry;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[2] = rx * 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[3] = ry * 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseLine = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.kind = 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.family = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[0] = this.element.getFloatAttribute("x1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[1] = this.element.getFloatAttribute("y1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[2] = this.element.getFloatAttribute("x2");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params[3] = this.element.getFloatAttribute("y2")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseColors = function(element) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.hasAttribute("opacity")) this.setOpacity(element.getAttribute("opacity"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.hasAttribute("stroke")) this.setStroke(element.getAttribute("stroke"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.hasAttribute("stroke-width")) this.setStrokeWeight(element.getAttribute("stroke-width"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.hasAttribute("stroke-linejoin")) this.setStrokeJoin(element.getAttribute("stroke-linejoin"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.hasAttribute("stroke-linecap")) this.setStrokeCap(element.getStringAttribute("stroke-linecap"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.hasAttribute("fill")) this.setFill(element.getStringAttribute("fill"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.hasAttribute("style")) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var styleText = element.getStringAttribute("style");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var styleTokens = styleText.toString().split(";");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = styleTokens.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var tokens = p.trim(styleTokens[i].split(":"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (tokens[0] === "fill") this.setFill(tokens[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (tokens[0] === "fill-opacity") this.setFillOpacity(tokens[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (tokens[0] === "stroke") this.setStroke(tokens[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (tokens[0] === "stroke-width") this.setStrokeWeight(tokens[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (tokens[0] === "stroke-linecap") this.setStrokeCap(tokens[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (tokens[0] === "stroke-linejoin") this.setStrokeJoin(tokens[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (tokens[0] === "stroke-opacity") this.setStrokeOpacity(tokens[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (tokens[0] === "opacity") this.setOpacity(tokens[1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setFillOpacity = function(opacityText) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fillOpacity = parseFloat(opacityText);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fillColor = this.fillOpacity * 255 &lt;&lt; 24 | this.fillColor &amp; 16777215</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setFill = function(fillText) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var opacityMask = this.fillColor &amp; 4278190080;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (fillText === "none") this.fill = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (fillText.indexOf("#") === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fill = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (fillText.length === 4) fillText = fillText.replace(/#(.)(.)(.)/, "#$1$1$2$2$3$3");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillColor = opacityMask | parseInt(fillText.substring(1), 16) &amp; 16777215</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (fillText.indexOf("rgb") === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fill = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillColor = opacityMask | this.parseRGB(fillText)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (fillText.indexOf("url(#") === 0) this.fillName = fillText.substring(5, fillText.length - 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (colors[fillText]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fill = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fillColor = opacityMask | parseInt(colors[fillText].substring(1), 16) &amp; 16777215</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setOpacity = function(opacity) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.strokeColor = parseFloat(opacity) * 255 &lt;&lt; 24 | this.strokeColor &amp; 16777215;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fillColor = parseFloat(opacity) * 255 &lt;&lt; 24 | this.fillColor &amp; 16777215</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setStroke = function(strokeText) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var opacityMask = this.strokeColor &amp; 4278190080;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (strokeText === "none") this.stroke = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (strokeText.charAt(0) === "#") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.stroke = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (strokeText.length === 4) strokeText = strokeText.replace(/#(.)(.)(.)/, "#$1$1$2$2$3$3");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeColor = opacityMask | parseInt(strokeText.substring(1), 16) &amp; 16777215</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (strokeText.indexOf("rgb") === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.stroke = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeColor = opacityMask | this.parseRGB(strokeText)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (strokeText.indexOf("url(#") === 0) this.strokeName = strokeText.substring(5, strokeText.length - 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (colors[strokeText]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.stroke = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.strokeColor = opacityMask | parseInt(colors[strokeText].substring(1), 16) &amp; 16777215</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setStrokeWeight = function(weight) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.strokeWeight = this.parseUnitSize(weight)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setStrokeJoin = function(linejoin) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (linejoin === "miter") this.strokeJoin = 'miter';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (linejoin === "round") this.strokeJoin = 'round';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (linejoin === "bevel") this.strokeJoin = 'bevel'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setStrokeCap = function(linecap) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (linecap === "butt") this.strokeCap = 'butt';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (linecap === "round") this.strokeCap = 'round';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (linecap === "square") this.strokeCap = 'square'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.setStrokeOpacity = function(opacityText) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.strokeOpacity = parseFloat(opacityText);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.strokeColor = this.strokeOpacity * 255 &lt;&lt; 24 | this.strokeColor &amp; 16777215</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseRGB = function(color) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sub = color.substring(color.indexOf("(") + 1, color.indexOf(")"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var values = sub.split(", ");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return values[0] &lt;&lt; 16 | values[1] &lt;&lt; 8 | values[2]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PShapeSVG.prototype.parseUnitSize = function(text) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var len = text.length - 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (len &lt; 0) return text;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (text.indexOf("pt") === len) return parseFloat(text.substring(0, len)) * 1.25;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (text.indexOf("pc") === len) return parseFloat(text.substring(0, len)) * 15;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (text.indexOf("mm") === len) return parseFloat(text.substring(0, len)) * 3.543307;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (text.indexOf("cm") === len) return parseFloat(text.substring(0, len)) * 35.43307;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (text.indexOf("in") === len) return parseFloat(text.substring(0, len)) * 90;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (text.indexOf("px") === len) return parseFloat(text.substring(0, len));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return parseFloat(text)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.shape = function(shape, x, y, width, height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length &gt;= 1 &amp;&amp; arguments[0] !== null) if (shape.isVisible()) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.pushMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (curShapeMode === 3) if (arguments.length === 5) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.translate(x - width / 2, y - height / 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.scale(width / shape.getWidth(), height / shape.getHeight())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (arguments.length === 3) p.translate(x - shape.getWidth() / 2, -shape.getHeight() / 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else p.translate(-shape.getWidth() / 2, -shape.getHeight() / 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (curShapeMode === 0) if (arguments.length === 5) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.translate(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.scale(width / shape.getWidth(), height / shape.getHeight())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (arguments.length === 3) p.translate(x, y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (curShapeMode === 1) if (arguments.length === 5) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>width -= x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>height -= y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.translate(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.scale(width / shape.getWidth(), height / shape.getHeight())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (arguments.length === 3) p.translate(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shape.draw(p);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1 &amp;&amp; curShapeMode === 3 || arguments.length &gt; 1) p.popMatrix()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.shapeMode = function(mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curShapeMode = mode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadShape = function(filename) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 1) if (filename.indexOf(".svg") &gt; -1) return new PShapeSVG(null, filename);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var XMLAttribute = function(fname, n, nameSpace, v, t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fullName = fname || "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = n || "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.namespace = nameSpace || "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.value = v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.type = t</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>XMLAttribute.prototype = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getName: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getFullName: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.fullName</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getNamespace: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.namespace</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getValue: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getType: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.type</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setValue: function(newval) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.value = newval</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var XMLElement = p.XMLElement = function(selector, uri, sysid, line) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.attributes = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.children = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fullName = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.namespace = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.content = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.parent = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.lineNr = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.systemID = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.type = "ELEMENT";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (selector) if (typeof selector === "string") if (uri === undef &amp;&amp; selector.indexOf("&lt;") &gt; -1) this.parse(selector);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fullName = selector;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.namespace = uri;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.systemId = sysid;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.lineNr = line</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else this.parse(uri)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>XMLElement.prototype = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>parse: function(textstring) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xmlDoc;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var extension = textstring.substring(textstring.length - 4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (extension === ".xml" || extension === ".svg") textstring = ajax(textstring);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlDoc = (new DOMParser).parseFromString(textstring, "text/xml");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var elements = xmlDoc.documentElement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (elements) this.parseChildrenRecursive(null, elements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else throw "Error loading document";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>throw e;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>parseChildrenRecursive: function(parent, elementpath) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xmlelement, xmlattribute, tmpattrib, l, m, child;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!parent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fullName = elementpath.localName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.name = elementpath.nodeName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlelement = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlelement = new XMLElement(elementpath.nodeName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlelement.parent = parent</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (elementpath.nodeType === 3 &amp;&amp; elementpath.textContent !== "") return this.createPCDataElement(elementpath.textContent);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (elementpath.nodeType === 4) return this.createCDataElement(elementpath.textContent);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (elementpath.attributes) for (l = 0, m = elementpath.attributes.length; l &lt; m; l++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>tmpattrib = elementpath.attributes[l];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlattribute = new XMLAttribute(tmpattrib.getname, tmpattrib.nodeName, tmpattrib.namespaceURI, tmpattrib.nodeValue, tmpattrib.nodeType);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlelement.attributes.push(xmlattribute)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (elementpath.childNodes) for (l = 0, m = elementpath.childNodes.length; l &lt; m; l++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var node = elementpath.childNodes[l];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>child = xmlelement.parseChildrenRecursive(xmlelement, node);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (child !== null) xmlelement.children.push(child)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return xmlelement</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>createElement: function(fullname, namespaceuri, sysid, line) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (sysid === undef) return new XMLElement(fullname, namespaceuri);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new XMLElement(fullname, namespaceuri, sysid, line)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>createPCDataElement: function(content, isCDATA) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (content.replace(/^\s+$/g, "") === "") return null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var pcdata = new XMLElement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pcdata.type = "TEXT";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pcdata.content = content;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return pcdata</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>createCDataElement: function(content) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var cdata = this.createPCDataElement(content);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (cdata === null) return null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cdata.type = "CDATA";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var htmlentities = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>"&lt;": "&amp;lt;",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>"&gt;": "&amp;gt;",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>"'": "&amp;apos;",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>'"': "&amp;quot;"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>entity;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (entity in htmlentities) if (!Object.hasOwnProperty(htmlentities, entity)) content = content.replace(new RegExp(entity, "g"), htmlentities[entity]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cdata.cdata = content;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return cdata</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>hasAttribute: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) return this.getAttribute(arguments[0]) !== null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) return this.getAttribute(arguments[0], arguments[1]) !== null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>equals: function(other) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (! (other instanceof XMLElement)) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i, j;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.fullName !== other.fullName) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.attributes.length !== other.getAttributeCount()) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.attributes.length !== other.attributes.length) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var attr_name, attr_ns, attr_value, attr_type, attr_other;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0, j = this.attributes.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attr_name = this.attributes[i].getName();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attr_ns = this.attributes[i].getNamespace();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attr_other = other.findAttribute(attr_name, attr_ns);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (attr_other === null) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (this.attributes[i].getValue() !== attr_other.getValue()) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (this.attributes[i].getType() !== attr_other.getType()) return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.children.length !== other.getChildCount()) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.children.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var child1, child2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0, j = this.children.length; i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>child1 = this.getChild(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>child2 = other.getChild(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!child1.equals(child2)) return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.content === other.content</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getContent: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.type === "TEXT" || this.type === "CDATA") return this.content;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var children = this.children;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (children.length === 1 &amp;&amp; (children[0].type === "TEXT" || children[0].type === "CDATA")) return children[0].content;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getAttribute: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var attribute;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attribute = this.findAttribute(arguments[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (attribute) return attribute.getValue();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return arguments[1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attribute = this.findAttribute(arguments[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (attribute) return attribute.getValue();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (arguments.length === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attribute = this.findAttribute(arguments[0], arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (attribute) return attribute.getValue();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return arguments[2]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getStringAttribute: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) return this.getAttribute(arguments[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) return this.getAttribute(arguments[0], arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.getAttribute(arguments[0], arguments[1], arguments[2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getString: function(attributeName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.getStringAttribute(attributeName)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getFloatAttribute: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) return parseFloat(this.getAttribute(arguments[0], 0));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) return this.getAttribute(arguments[0], arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.getAttribute(arguments[0], arguments[1], arguments[2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getFloat: function(attributeName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.getFloatAttribute(attributeName)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getIntAttribute: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) return this.getAttribute(arguments[0], 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) return this.getAttribute(arguments[0], arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.getAttribute(arguments[0], arguments[1], arguments[2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getInt: function(attributeName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.getIntAttribute(attributeName)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>hasChildren: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.children.length &gt; 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>addChild: function(child) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (child !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>child.parent = this;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.children.push(child)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>insertChild: function(child, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (child) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (child.getLocalName() === null &amp;&amp; !this.hasChildren()) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var lastChild = this.children[this.children.length - 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (lastChild.getLocalName() === null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lastChild.setContent(lastChild.getContent() + child.getContent());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>child.parent = this;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.children.splice(index, 0, child)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getChild: function(selector) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof selector === "number") return this.children[selector];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (selector.indexOf("/") !== -1) return this.getChildRecursive(selector.split("/"), 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var kid, kidName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.getChildCount(); i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>kid = this.getChild(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>kidName = kid.getName();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (kidName !== null &amp;&amp; kidName === selector) return kid</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getChildren: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof arguments[0] === "number") return this.getChild(arguments[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (arguments[0].indexOf("/") !== -1) return this.getChildrenRecursive(arguments[0].split("/"), 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var matches = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var kid, kidName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (var i = 0, j = this.getChildCount(); i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>kid = this.getChild(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>kidName = kid.getName();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (kidName !== null &amp;&amp; kidName === arguments[0]) matches.push(kid)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return matches</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.children</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getChildCount: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.children.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getChildRecursive: function(items, offset) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (offset === items.length) return this;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var kid, kidName, matchName = items[offset];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.getChildCount(); i &lt; j; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>kid = this.getChild(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>kidName = kid.getName();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (kidName !== null &amp;&amp; kidName === matchName) return kid.getChildRecursive(items, offset + 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getChildrenRecursive: function(items, offset) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (offset === items.length - 1) return this.getChildren(items[offset]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var matches = this.getChildren(items[offset]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var kidMatches = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; matches.length; i++) kidMatches = kidMatches.concat(matches[i].getChildrenRecursive(items, offset + 1));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return kidMatches</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isLeaf: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return !this.hasChildren()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>listChildren: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arr = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.children.length; i &lt; j; i++) arr.push(this.getChild(i).getName());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>removeAttribute: function(name, namespace) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.namespace = namespace || "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.attributes.length; i &lt; j; i++) if (this.attributes[i].getName() === name &amp;&amp; this.attributes[i].getNamespace() === this.namespace) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.attributes.splice(i, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>removeChild: function(child) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (child) for (var i = 0, j = this.children.length; i &lt; j; i++) if (this.children[i].equals(child)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.children.splice(i, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>removeChildAtIndex: function(index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.children.length &gt; index) this.children.splice(index, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>findAttribute: function(name, namespace) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.namespace = namespace || "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, j = this.attributes.length; i &lt; j; i++) if (this.attributes[i].getName() === name &amp;&amp; this.attributes[i].getNamespace() === this.namespace) return this.attributes[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setAttribute: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var attr;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var index = arguments[0].indexOf(":");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var name = arguments[0].substring(index + 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attr = this.findAttribute(name, arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (attr) attr.setValue(arguments[2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>attr = new XMLAttribute(arguments[0], name, arguments[1], arguments[2], "CDATA");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.attributes.push(attr)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>attr = this.findAttribute(arguments[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (attr) attr.setValue(arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>attr = new XMLAttribute(arguments[0], arguments[0], null, arguments[1], "CDATA");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.attributes.push(attr)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setString: function(attribute, value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.setAttribute(attribute, value)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setInt: function(attribute, value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.setAttribute(attribute, value)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setFloat: function(attribute, value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.setAttribute(attribute, value)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setContent: function(content) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.children.length &gt; 0) Processing.debug("Tried to set content for XMLElement with children");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.content = content</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setName: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.name = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fullName = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.namespace = null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var index = arguments[0].indexOf(":");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (arguments[1] === null || index &lt; 0) this.name = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else this.name = arguments[0].substring(index + 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fullName = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.namespace = arguments[1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getName: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.fullName</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getLocalName: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getAttributeCount: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.attributes.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>toString: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.type === "TEXT") return this.content;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.type === "CDATA") return this.cdata;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var tagstring = this.fullName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xmlstring = "&lt;" + tagstring;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var a, c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (a = 0; a &lt; this.attributes.length; a++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var attr = this.attributes[a];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlstring += " " + attr.getName() + "=" + '"' + attr.getValue() + '"'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.children.length === 0) if (this.content === "") xmlstring += "/&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else xmlstring += "&gt;" + this.content + "&lt;/" + tagstring + "&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlstring += "&gt;";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (c = 0; c &lt; this.children.length; c++) xmlstring += this.children[c].toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlstring += "&lt;/" + tagstring + "&gt;"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return xmlstring</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>XMLElement.parse = function(xmlstring) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var element = new XMLElement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>element.parse(xmlstring);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return element</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var XML = p.XML = p.XMLElement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadXML = function(uri) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new XML(p, uri)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var printMatrixHelper = function(elements) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var big = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; elements.length; i++) if (i !== 0) big = Math.max(big, Math.abs(elements[i]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else big = Math.abs(elements[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var digits = (big + "").indexOf(".");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (digits === 0) digits = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (digits === -1) digits = (big + "").length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return digits</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var PMatrix2D = p.PMatrix2D = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 0) this.reset();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof PMatrix2D) this.set(arguments[0].array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (arguments.length === 6) this.set(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4], arguments[5])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PMatrix2D.prototype = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>set: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 6) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var a = arguments;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.set([a[0], a[1], a[2], a[3], a[4], a[5]])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof PMatrix2D) this.elements = arguments[0].array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof Array) this.elements = arguments[0].slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>get: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var outgoing = new PMatrix2D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>outgoing.set(this.elements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return outgoing</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>reset: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.set([1, 0, 0, 0, 1, 0])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>array: function array() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.elements.slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>translate: function(tx, ty) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[2] = tx * this.elements[0] + ty * this.elements[1] + this.elements[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[5] = tx * this.elements[3] + ty * this.elements[4] + this.elements[5]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invTranslate: function(tx, ty) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.translate(-tx, -ty)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>transpose: function() {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mult: function(source, target) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var x, y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (source instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PVector) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x = source.x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = source.y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!target) target = new PVector</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (source instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x = source[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = source[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!target) target = []</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (target instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[0] = this.elements[0] * x + this.elements[1] * y + this.elements[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[1] = this.elements[3] * x + this.elements[4] * y + this.elements[5]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (target instanceof PVector) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target.x = this.elements[0] * x + this.elements[1] * y + this.elements[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target.y = this.elements[3] * x + this.elements[4] * y + this.elements[5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target.z = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return target</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>multX: function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return x * this.elements[0] + y * this.elements[1] + this.elements[2]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>multY: function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return x * this.elements[3] + y * this.elements[4] + this.elements[5]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>skewX: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, 0, 1, angle, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>skewY: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, 0, 1, 0, angle, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>shearX: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, 0, 1, Math.tan(angle), 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>shearY: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, 0, 1, 0, Math.tan(angle), 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>determinant: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.elements[0] * this.elements[4] - this.elements[1] * this.elements[3]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invert: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var d = this.determinant();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (Math.abs(d) &gt; -2147483648) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var old00 = this.elements[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var old01 = this.elements[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var old02 = this.elements[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var old10 = this.elements[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var old11 = this.elements[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var old12 = this.elements[5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[0] = old11 / d;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[3] = -old10 / d;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[1] = -old01 / d;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[4] = old00 / d;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[2] = (old01 * old12 - old11 * old02) / d;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[5] = (old10 * old02 - old00 * old12) / d;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>scale: function(sx, sy) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (sx &amp;&amp; !sy) sy = sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (sx &amp;&amp; sy) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[0] *= sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[1] *= sy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[3] *= sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[4] *= sy</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invScale: function(sx, sy) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (sx &amp;&amp; !sy) sy = sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.scale(1 / sx, 1 / sy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>apply: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var source;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1 &amp;&amp; arguments[0] instanceof PMatrix2D) source = arguments[0].array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 6) source = Array.prototype.slice.call(arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof Array) source = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var result = [0, 0, this.elements[2], 0, 0, this.elements[5]];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var e = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var row = 0; row &lt; 2; row++) for (var col = 0; col &lt; 3; col++, e++) result[e] += this.elements[row * 3 + 0] * source[col + 0] + this.elements[row * 3 + 1] * source[col + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements = result.slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>preApply: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var source;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1 &amp;&amp; arguments[0] instanceof PMatrix2D) source = arguments[0].array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 6) source = Array.prototype.slice.call(arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof Array) source = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var result = [0, 0, source[2], 0, 0, source[5]];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result[2] = source[2] + this.elements[2] * source[0] + this.elements[5] * source[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result[5] = source[5] + this.elements[2] * source[3] + this.elements[5] * source[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result[0] = this.elements[0] * source[0] + this.elements[3] * source[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result[3] = this.elements[0] * source[3] + this.elements[3] * source[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result[1] = this.elements[1] * source[0] + this.elements[4] * source[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result[4] = this.elements[1] * source[3] + this.elements[4] * source[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements = result.slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotate: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = Math.cos(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = Math.sin(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var temp1 = this.elements[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var temp2 = this.elements[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[0] = c * temp1 + s * temp2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[1] = -s * temp1 + c * temp2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>temp1 = this.elements[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>temp2 = this.elements[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[3] = c * temp1 + s * temp2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[4] = -s * temp1 + c * temp2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotateZ: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.rotate(angle)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invRotateZ: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.rotateZ(angle - Math.PI)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>print: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var digits = printMatrixHelper(this.elements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var output = "" + p.nfs(this.elements[0], digits, 4) + " " + p.nfs(this.elements[1], digits, 4) + " " + p.nfs(this.elements[2], digits, 4) + "\n" + p.nfs(this.elements[3], digits, 4) + " " + p.nfs(this.elements[4], digits, 4) + " " + p.nfs(this.elements[5], digits, 4) + "\n\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.println(output)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var PMatrix3D = p.PMatrix3D = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.reset()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PMatrix3D.prototype = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>set: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 16) this.elements = Array.prototype.slice.call(arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof PMatrix3D) this.elements = arguments[0].array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof Array) this.elements = arguments[0].slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>get: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var outgoing = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>outgoing.set(this.elements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return outgoing</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>reset: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>array: function array() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.elements.slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>translate: function(tx, ty, tz) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (tz === undef) tz = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[3] += tx * this.elements[0] + ty * this.elements[1] + tz * this.elements[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[7] += tx * this.elements[4] + ty * this.elements[5] + tz * this.elements[6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[11] += tx * this.elements[8] + ty * this.elements[9] + tz * this.elements[10];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[15] += tx * this.elements[12] + ty * this.elements[13] + tz * this.elements[14]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>transpose: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var temp = this.elements[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[4] = this.elements[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[1] = temp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>temp = this.elements[8];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[8] = this.elements[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[2] = temp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>temp = this.elements[6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[6] = this.elements[9];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[9] = temp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>temp = this.elements[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[3] = this.elements[12];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[12] = temp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>temp = this.elements[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[7] = this.elements[13];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[13] = temp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>temp = this.elements[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[11] = this.elements[14];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements[14] = temp</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mult: function(source, target) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var x, y, z, w;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (source instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PVector) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x = source.x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = source.y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>z = source.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>w = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!target) target = new PVector</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (source instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x = source[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = source[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>z = source[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>w = source[3] || 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!target || target.length !== 3 &amp;&amp; target.length !== 4) target = [0, 0, 0]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (target instanceof Array) if (target.length === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[0] = this.elements[0] * x + this.elements[1] * y + this.elements[2] * z + this.elements[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[1] = this.elements[4] * x + this.elements[5] * y + this.elements[6] * z + this.elements[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[2] = this.elements[8] * x + this.elements[9] * y + this.elements[10] * z + this.elements[11]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (target.length === 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[0] = this.elements[0] * x + this.elements[1] * y + this.elements[2] * z + this.elements[3] * w;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[1] = this.elements[4] * x + this.elements[5] * y + this.elements[6] * z + this.elements[7] * w;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[2] = this.elements[8] * x + this.elements[9] * y + this.elements[10] * z + this.elements[11] * w;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target[3] = this.elements[12] * x + this.elements[13] * y + this.elements[14] * z + this.elements[15] * w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (target instanceof PVector) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target.x = this.elements[0] * x + this.elements[1] * y + this.elements[2] * z + this.elements[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target.y = this.elements[4] * x + this.elements[5] * y + this.elements[6] * z + this.elements[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>target.z = this.elements[8] * x + this.elements[9] * y + this.elements[10] * z + this.elements[11]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return target</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>preApply: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var source;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1 &amp;&amp; arguments[0] instanceof PMatrix3D) source = arguments[0].array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 16) source = Array.prototype.slice.call(arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof Array) source = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var result = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var e = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var row = 0; row &lt; 4; row++) for (var col = 0; col &lt; 4; col++, e++) result[e] += this.elements[col + 0] * source[row * 4 + 0] + this.elements[col + 4] * source[row * 4 + 1] + this.elements[col + 8] * source[row * 4 + 2] + this.elements[col + 12] * source[row * 4 + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements = result.slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>apply: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var source;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 1 &amp;&amp; arguments[0] instanceof PMatrix3D) source = arguments[0].array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 16) source = Array.prototype.slice.call(arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1 &amp;&amp; arguments[0] instanceof Array) source = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var result = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var e = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var row = 0; row &lt; 4; row++) for (var col = 0; col &lt; 4; col++, e++) result[e] += this.elements[row * 4 + 0] * source[col + 0] + this.elements[row * 4 + 1] * source[col + 4] + this.elements[row * 4 + 2] * source[col + 8] + this.elements[row * 4 + 3] * source[col + 12];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements = result.slice()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotate: function(angle, v0, v1, v2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!v1) this.rotateZ(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var c = p.cos(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var s = p.sin(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var t = 1 - c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.apply(t * v0 * v0 + c, t * v0 * v1 - s * v2, t * v0 * v2 + s * v1, 0, t * v0 * v1 + s * v2, t * v1 * v1 + c, t * v1 * v2 - s * v0, 0, t * v0 * v2 - s * v1, t * v1 * v2 + s * v0, t * v2 * v2 + c, 0, 0, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invApply: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (inverseCopy === undef) inverseCopy = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var a = arguments;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>inverseCopy.set(a[0], a[1], a[2], a[3], a[4], a[5], a[6], a[7], a[8], a[9], a[10], a[11], a[12], a[13], a[14], a[15]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!inverseCopy.invert()) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.preApply(inverseCopy);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotateX: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = p.cos(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = p.sin(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply([1, 0, 0, 0, 0, c, -s, 0, 0, s, c, 0, 0, 0, 0, 1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotateY: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = p.cos(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = p.sin(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply([c,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>0, s, 0, 0, 1, 0, 0, -s, 0, c, 0, 0, 0, 0, 1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>rotateZ: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = Math.cos(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = Math.sin(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply([c, -s, 0, 0, s, c, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>scale: function(sx, sy, sz) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (sx &amp;&amp; !sy &amp;&amp; !sz) sy = sz = sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (sx &amp;&amp; sy &amp;&amp; !sz) sz = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (sx &amp;&amp; sy &amp;&amp; sz) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[0] *= sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[1] *= sy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[2] *= sz;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[4] *= sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[5] *= sy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[6] *= sz;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[8] *= sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[9] *= sy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[10] *= sz;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[12] *= sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[13] *= sy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.elements[14] *= sz</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>skewX: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var t = Math.tan(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, t, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>skewY: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var t = Math.tan(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, 0, 0, 0, t, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>shearX: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var t = Math.tan(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, t, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>shearY: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var t = Math.tan(angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.apply(1, 0, 0, 0, t, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>multX: function(x, y, z, w) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!z) return this.elements[0] * x + this.elements[1] * y + this.elements[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!w) return this.elements[0] * x + this.elements[1] * y + this.elements[2] * z + this.elements[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.elements[0] * x + this.elements[1] * y + this.elements[2] * z + this.elements[3] * w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>multY: function(x, y, z, w) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!z) return this.elements[4] * x + this.elements[5] * y + this.elements[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!w) return this.elements[4] * x + this.elements[5] * y + this.elements[6] * z + this.elements[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.elements[4] * x + this.elements[5] * y + this.elements[6] * z + this.elements[7] * w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>multZ: function(x, y, z, w) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!w) return this.elements[8] * x + this.elements[9] * y + this.elements[10] * z + this.elements[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.elements[8] * x + this.elements[9] * y + this.elements[10] * z + this.elements[11] * w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>multW: function(x, y, z, w) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!w) return this.elements[12] * x + this.elements[13] * y + this.elements[14] * z + this.elements[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.elements[12] * x + this.elements[13] * y + this.elements[14] * z + this.elements[15] * w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invert: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fA0 = this.elements[0] * this.elements[5] - this.elements[1] * this.elements[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fA1 = this.elements[0] * this.elements[6] - this.elements[2] * this.elements[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fA2 = this.elements[0] * this.elements[7] - this.elements[3] * this.elements[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fA3 = this.elements[1] * this.elements[6] - this.elements[2] * this.elements[5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fA4 = this.elements[1] * this.elements[7] - this.elements[3] * this.elements[5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fA5 = this.elements[2] * this.elements[7] - this.elements[3] * this.elements[6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fB0 = this.elements[8] * this.elements[13] - this.elements[9] * this.elements[12];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fB1 = this.elements[8] * this.elements[14] - this.elements[10] * this.elements[12];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fB2 = this.elements[8] * this.elements[15] - this.elements[11] * this.elements[12];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fB3 = this.elements[9] * this.elements[14] - this.elements[10] * this.elements[13];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fB4 = this.elements[9] * this.elements[15] - this.elements[11] * this.elements[13];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fB5 = this.elements[10] * this.elements[15] - this.elements[11] * this.elements[14];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fDet = fA0 * fB5 - fA1 * fB4 + fA2 * fB3 + fA3 * fB2 - fA4 * fB1 + fA5 * fB0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (Math.abs(fDet) &lt;= 1.0E-9) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var kInv = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[0] = +this.elements[5] * fB5 - this.elements[6] * fB4 + this.elements[7] * fB3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[4] = -this.elements[4] * fB5 + this.elements[6] * fB2 - this.elements[7] * fB1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[8] = +this.elements[4] * fB4 - this.elements[5] * fB2 + this.elements[7] * fB0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[12] = -this.elements[4] * fB3 + this.elements[5] * fB1 - this.elements[6] * fB0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[1] = -this.elements[1] * fB5 + this.elements[2] * fB4 - this.elements[3] * fB3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[5] = +this.elements[0] * fB5 - this.elements[2] * fB2 + this.elements[3] * fB1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[9] = -this.elements[0] * fB4 + this.elements[1] * fB2 - this.elements[3] * fB0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[13] = +this.elements[0] * fB3 - this.elements[1] * fB1 + this.elements[2] * fB0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[2] = +this.elements[13] * fA5 - this.elements[14] * fA4 + this.elements[15] * fA3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[6] = -this.elements[12] * fA5 + this.elements[14] * fA2 - this.elements[15] * fA1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[10] = +this.elements[12] * fA4 - this.elements[13] * fA2 + this.elements[15] * fA0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[14] = -this.elements[12] * fA3 + this.elements[13] * fA1 - this.elements[14] * fA0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[3] = -this.elements[9] * fA5 + this.elements[10] * fA4 - this.elements[11] * fA3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[7] = +this.elements[8] * fA5 - this.elements[10] * fA2 + this.elements[11] * fA1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[11] = -this.elements[8] * fA4 + this.elements[9] * fA2 - this.elements[11] * fA0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[15] = +this.elements[8] * fA3 - this.elements[9] * fA1 + this.elements[10] * fA0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fInvDet = 1 / fDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[0] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[1] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[2] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[3] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[4] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[5] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[6] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[7] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[8] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[9] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[10] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[11] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[12] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[13] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[14] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>kInv[15] *= fInvDet;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.elements = kInv.slice();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>toString: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var str = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; 15; i++) str += this.elements[i] + ", ";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>str += this.elements[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return str</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>print: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var digits = printMatrixHelper(this.elements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var output = "" + p.nfs(this.elements[0], digits, 4) + " " + p.nfs(this.elements[1], digits, 4) + " " + p.nfs(this.elements[2], digits, 4) + " " + p.nfs(this.elements[3], digits, 4) + "\n" + p.nfs(this.elements[4], digits, 4) + " " + p.nfs(this.elements[5], digits, 4) + " " + p.nfs(this.elements[6], digits, 4) + " " + p.nfs(this.elements[7], digits, 4) + "\n" + p.nfs(this.elements[8], digits, 4) + " " + p.nfs(this.elements[9], digits, 4) + " " + p.nfs(this.elements[10], digits, 4) + " " + p.nfs(this.elements[11], digits, 4) + "\n" + p.nfs(this.elements[12], digits, 4) + " " + p.nfs(this.elements[13], digits, 4) + " " + p.nfs(this.elements[14], digits, 4) + " " + p.nfs(this.elements[15], digits, 4) + "\n\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.println(output)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invTranslate: function(tx, ty, tz) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.preApply(1, 0, 0, -tx, 0, 1, 0, -ty, 0, 0, 1, -tz, 0, 0, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invRotateX: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = Math.cos(-angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = Math.sin(-angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.preApply([1, 0, 0, 0, 0, c, -s, 0, 0, s, c, 0, 0, 0, 0, 1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invRotateY: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = Math.cos(-angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = Math.sin(-angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.preApply([c, 0, s, 0, 0, 1, 0, 0, -s, 0, c, 0, 0, 0, 0, 1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invRotateZ: function(angle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = Math.cos(-angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = Math.sin(-angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.preApply([c, -s, 0, 0, s, c, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>invScale: function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.preApply([1 / x, 0, 0, 0, 0, 1 / y, 0, 0, 0, 0, 1 / z, 0, 0, 0, 0, 1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var PMatrixStack = p.PMatrixStack = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.matrixStack = []</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PMatrixStack.prototype.load = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tmpMatrix = drawing.$newPMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 1) tmpMatrix.set(arguments[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else tmpMatrix.set(arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.matrixStack.push(tmpMatrix)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.$newPMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new PMatrix2D</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.$newPMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new PMatrix3D</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PMatrixStack.prototype.push = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.matrixStack.push(this.peek())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PMatrixStack.prototype.pop = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.matrixStack.pop()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PMatrixStack.prototype.peek = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tmpMatrix = drawing.$newPMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>tmpMatrix.set(this.matrixStack[this.matrixStack.length - 1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return tmpMatrix</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PMatrixStack.prototype.mult = function(matrix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.matrixStack[this.matrixStack.length - 1].apply(matrix)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.split = function(str, delim) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return str.split(delim)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.splitTokens = function(str, tokens) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (tokens === undef) return str.split(/\s+/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var chars = tokens.split(/()/g),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>buffer = "",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>len = str.length,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>i, c, tokenized = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; len; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>c = str[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (chars.indexOf(c) &gt; -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (buffer !== "") tokenized.push(buffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>buffer = ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else buffer += c</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (buffer !== "") tokenized.push(buffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return tokenized</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.append = function(array, element) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>array[array.length] = element;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return array</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.concat = function(array1, array2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return array1.concat(array2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.sort = function(array, numElem) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ret = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (array.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var elemsToCopy = numElem &gt; 0 ? numElem : array.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; elemsToCopy; i++) ret.push(array[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (typeof array[0] === "string") ret.sort();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else ret.sort(function(a, b) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return a - b</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (numElem &gt; 0) for (var j = ret.length; j &lt; array.length; j++) ret.push(array[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ret</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.splice = function(array, value, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (value.length === 0) return array;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (value instanceof Array) for (var i = 0, j = index; i &lt; value.length; j++, i++) array.splice(j, 0, value[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else array.splice(index, 0, value);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return array</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.subset = function(array, offset, length) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var end = length !== undef ? offset + length : array.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return array.slice(offset, end)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.join = function(array, seperator) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return array.join(seperator)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.shorten = function(ary) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var newary = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var len = ary.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; len; i++) newary[i] = ary[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>newary.pop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return newary</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.expand = function(ary, targetSize) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var temp = ary.slice(0),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>newSize = targetSize || ary.length * 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>temp.length = newSize;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return temp</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.arrayCopy = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var src, srcPos = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dest, destPos = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>src = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dest = arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>length = src.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (arguments.length === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>src = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dest = arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>length = arguments[2]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (arguments.length === 5) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>src = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>srcPos = arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dest = arguments[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>destPos = arguments[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>length = arguments[4]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = srcPos, j = destPos; i &lt; length + srcPos; i++, j++) if (dest[j] !== undef) dest[j] = src[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else throw "array index out of bounds exception";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.reverse = function(array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return array.reverse()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mix = function(a, b, f) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return a + ((b - a) * f &gt;&gt; 8)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.peg = function(n) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return n &lt; 0 ? 0 : n &gt; 255 ? 255 : n</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.modes = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ALPHA_MASK = 4278190080,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>RED_MASK = 16711680,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>GREEN_MASK = 65280,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>BLUE_MASK = 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>min = Math.min,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>max = Math.max;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var a = min(((c1 &amp; 4278190080) &gt;&gt;&gt; 24) + f, 255) &lt;&lt; 24;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var r = ar + ((cr - ar) * f &gt;&gt; 8);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>r = (r &lt; 0 ? 0 : r &gt; 255 ? 255 : r) &lt;&lt; 16;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var g = ag + ((cg - ag) * f &gt;&gt; 8);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>g = (g &lt; 0 ? 0 : g &gt; 255 ? 255 : g) &lt;&lt; 8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var b = ab + ((cb - ab) * f &gt;&gt; 8);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>b = b &lt; 0 ? 0 : b &gt; 255 ? 255 : b;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return a | r | g | b</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>replace: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return c2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>blend: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = c1 &amp; RED_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = c1 &amp; GREEN_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = c2 &amp; RED_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = c2 &amp; GREEN_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return min(((c1 &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + f, 255) &lt;&lt; 24 | ar + ((br - ar) * f &gt;&gt; 8) &amp; RED_MASK | ag + ((bg - ag) * f &gt;&gt; 8) &amp; GREEN_MASK | ab + ((bb - ab) * f &gt;&gt; 8) &amp; BLUE_MASK</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>add: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return min(((c1 &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + f, 255) &lt;&lt; 24 | min((c1 &amp; RED_MASK) + ((c2 &amp; RED_MASK) &gt;&gt; 8) * f, RED_MASK) &amp; RED_MASK | min((c1 &amp; GREEN_MASK) + ((c2 &amp; GREEN_MASK) &gt;&gt; 8) * f, GREEN_MASK) &amp; GREEN_MASK | min((c1 &amp; BLUE_MASK) + ((c2 &amp; BLUE_MASK) * f &gt;&gt; 8), BLUE_MASK)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>subtract: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return min(((c1 &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + f, 255) &lt;&lt; 24 | max((c1 &amp; RED_MASK) - ((c2 &amp; RED_MASK) &gt;&gt; 8) * f, GREEN_MASK) &amp; RED_MASK | max((c1 &amp; GREEN_MASK) - ((c2 &amp; GREEN_MASK) &gt;&gt; 8) * f, BLUE_MASK) &amp; GREEN_MASK | max((c1 &amp; BLUE_MASK) - ((c2 &amp; BLUE_MASK) * f &gt;&gt; 8), 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lightest: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return min(((c1 &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + f, 255) &lt;&lt; 24 | max(c1 &amp; RED_MASK, ((c2 &amp; RED_MASK) &gt;&gt; 8) * f) &amp; RED_MASK | max(c1 &amp; GREEN_MASK, ((c2 &amp; GREEN_MASK) &gt;&gt; 8) * f) &amp; GREEN_MASK | max(c1 &amp; BLUE_MASK, (c2 &amp; BLUE_MASK) * f &gt;&gt; 8)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>darkest: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = c1 &amp; RED_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = c1 &amp; GREEN_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = min(c1 &amp; RED_MASK, ((c2 &amp; RED_MASK) &gt;&gt; 8) * f),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = min(c1 &amp; GREEN_MASK, ((c2 &amp; GREEN_MASK) &gt;&gt; 8) * f),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = min(c1 &amp; BLUE_MASK, (c2 &amp; BLUE_MASK) * f &gt;&gt; 8);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return min(((c1 &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + f, 255) &lt;&lt; 24 | ar + ((br - ar) * f &gt;&gt; 8) &amp; RED_MASK | ag + ((bg - ag) * f &gt;&gt; 8) &amp; GREEN_MASK | ab + ((bb - ab) * f &gt;&gt; 8) &amp; BLUE_MASK</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>difference: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = ar &gt; br ? ar - br : br - ar,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cg = ag &gt; bg ? ag - bg : bg - ag,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cb = ab &gt; bb ? ab - bb : bb - ab;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>exclusion: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = ar + br - (ar * br &gt;&gt; 7),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = ag + bg - (ag * bg &gt;&gt; 7),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = ab + bb - (ab * bb &gt;&gt; 7);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>multiply: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = ar * br &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = ag * bg &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = ab * bb &gt;&gt; 8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>screen: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = 255 - ((255 - ar) * (255 - br) &gt;&gt; 8),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = 255 - ((255 - ag) * (255 - bg) &gt;&gt; 8),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = 255 - ((255 - ab) * (255 - bb) &gt;&gt; 8);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hard_light: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = br &lt; 128 ? ar * br &gt;&gt; 7 : 255 - ((255 - ar) * (255 - br) &gt;&gt; 7),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cg = bg &lt; 128 ? ag * bg &gt;&gt; 7 : 255 - ((255 - ag) * (255 - bg) &gt;&gt; 7),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cb = bb &lt; 128 ? ab * bb &gt;&gt; 7 : 255 - ((255 - ab) * (255 - bb) &gt;&gt; 7);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>soft_light: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = (ar * br &gt;&gt; 7) + (ar * ar &gt;&gt; 8) - (ar * ar * br &gt;&gt; 15),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = (ag * bg &gt;&gt; 7) + (ag * ag &gt;&gt; 8) - (ag * ag * bg &gt;&gt; 15),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = (ab * bb &gt;&gt; 7) + (ab * ab &gt;&gt; 8) - (ab * ab * bb &gt;&gt; 15);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>overlay: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = ar &lt; 128 ? ar * br &gt;&gt; 7 : 255 - ((255 - ar) * (255 - br) &gt;&gt; 7),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cg = ag &lt; 128 ? ag * bg &gt;&gt; 7 : 255 - ((255 - ag) * (255 - bg) &gt;&gt; 7),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cb = ab &lt; 128 ? ab * bb &gt;&gt; 7 : 255 - ((255 - ab) * (255 - bb) &gt;&gt; 7);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dodge: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var cr = 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (br !== 255) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = (ar &lt;&lt; 8) / (255 - br);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = cr &lt; 0 ? 0 : cr &gt; 255 ? 255 : cr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var cg = 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (bg !== 255) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = (ag &lt;&lt; 8) / (255 - bg);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = cg &lt; 0 ? 0 : cg &gt; 255 ? 255 : cg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var cb = 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (bb !== 255) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = (ab &lt;&lt; 8) / (255 - bb);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = cb &lt; 0 ? 0 : cb &gt; 255 ? 255 : cb</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>burn: function(c1, c2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var f = (c2 &amp; ALPHA_MASK) &gt;&gt;&gt; 24,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ar = (c1 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ag = (c1 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ab = c1 &amp; BLUE_MASK,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>br = (c2 &amp; RED_MASK) &gt;&gt; 16,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bg = (c2 &amp; GREEN_MASK) &gt;&gt; 8,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bb = c2 &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var cr = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (br !== 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = (255 - ar &lt;&lt; 8) / br;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr = 255 - (cr &lt; 0 ? 0 : cr &gt; 255 ? 255 : cr)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var cg = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (bg !== 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = (255 - ag &lt;&lt; 8) / bg;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg = 255 - (cg &lt; 0 ? 0 : cg &gt; 255 ? 255 : cg)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var cb = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (bb !== 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = (255 - ab &lt;&lt; 8) / bb;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb = 255 - (cb &lt; 0 ? 0 : cb &gt; 255 ? 255 : cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return applyMode(c1, f, ar, ag, ab, br, bg, bb, cr, cg, cb)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function color$4(aValue1, aValue2, aValue3, aValue4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var r, g, b, a;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curColorMode === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var rgb = p.color.toRGB(aValue1, aValue2, aValue3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>r = rgb[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>g = rgb[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>b = rgb[2]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>r = Math.round(255 * (aValue1 / colorModeX));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>g = Math.round(255 * (aValue2 / colorModeY));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>b = Math.round(255 * (aValue3 / colorModeZ))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a = Math.round(255 * (aValue4 / colorModeA));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>r = r &lt; 0 ? 0 : r;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>g = g &lt; 0 ? 0 : g;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b = b &lt; 0 ? 0 : b;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a = a &lt; 0 ? 0 : a;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>r = r &gt; 255 ? 255 : r;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>g = g &gt; 255 ? 255 : g;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b = b &gt; 255 ? 255 : b;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a = a &gt; 255 ? 255 : a;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return a &lt;&lt; 24 &amp; 4278190080 | r &lt;&lt; 16 &amp; 16711680 | g &lt;&lt; 8 &amp; 65280 | b &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function color$2(aValue1, aValue2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var a;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aValue1 &amp; 4278190080) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>a = Math.round(255 * (aValue2 / colorModeA));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>a = a &gt; 255 ? 255 : a;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>a = a &lt; 0 ? 0 : a;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return aValue1 - (aValue1 &amp; 4278190080) + (a &lt;&lt; 24 &amp; 4278190080)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curColorMode === 1) return color$4(aValue1, aValue1, aValue1, aValue2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curColorMode === 3) return color$4(0, 0, aValue1 / colorModeX * colorModeZ, aValue2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function color$1(aValue1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aValue1 &lt;= colorModeX &amp;&amp; aValue1 &gt;= 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (curColorMode === 1) return color$4(aValue1, aValue1, aValue1, colorModeA);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (curColorMode === 3) return color$4(0, 0, aValue1 / colorModeX * colorModeZ, colorModeA)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aValue1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (aValue1 &gt; 2147483647) aValue1 -= 4294967296;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return aValue1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.color = function(aValue1, aValue2, aValue3, aValue4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aValue1 !== undef &amp;&amp; aValue2 !== undef &amp;&amp; aValue3 !== undef &amp;&amp; aValue4 !== undef) return color$4(aValue1, aValue2, aValue3, aValue4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aValue1 !== undef &amp;&amp; aValue2 !== undef &amp;&amp; aValue3 !== undef) return color$4(aValue1, aValue2, aValue3, colorModeA);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aValue1 !== undef &amp;&amp; aValue2 !== undef) return color$2(aValue1, aValue2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof aValue1 === "number") return color$1(aValue1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return color$4(colorModeX, colorModeY, colorModeZ, colorModeA)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.color.toString = function(colorInt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "rgba(" + ((colorInt &gt;&gt; 16) &amp; 255) + "," + ((colorInt &gt;&gt; 8) &amp; 255) + "," + (colorInt &amp; 255) + "," + ((colorInt &gt;&gt; 24) &amp; 255) / 255 + ")"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.color.toInt = function(r, g, b, a) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return a &lt;&lt; 24 &amp; 4278190080 | r &lt;&lt; 16 &amp; 16711680 | g &lt;&lt; 8 &amp; 65280 | b &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.color.toArray = function(colorInt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return [(colorInt &gt;&gt; 16) &amp; 255, (colorInt &gt;&gt; 8) &amp; 255, colorInt &amp; 255, (colorInt &gt;&gt; 24) &amp; 255]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.color.toGLArray = function(colorInt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return [((colorInt &amp; 16711680) &gt;&gt;&gt; 16) / 255, ((colorInt &gt;&gt; 8) &amp; 255) / 255, (colorInt &amp; 255) / 255, ((colorInt &gt;&gt; 24) &amp; 255) / 255]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.color.toRGB = function(h, s, b) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>h = h &gt; colorModeX ? colorModeX : h;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s &gt; colorModeY ? colorModeY : s;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b = b &gt; colorModeZ ? colorModeZ : b;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>h = h / colorModeX * 360;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s / colorModeY * 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b = b / colorModeZ * 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var br = Math.round(b / 100 * 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (s === 0) return [br, br, br];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var hue = h % 360;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var f = hue % 60;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var p = Math.round(b * (100 - s) / 1E4 * 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var q = Math.round(b * (6E3 - s * f) / 6E5 * 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var t = Math.round(b * (6E3 - s * (60 - f)) / 6E5 * 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>switch (Math.floor(hue / 60)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 0:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [br, t, p];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 1:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [q, br, p];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 2:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [p, br, t];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 3:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [p, q, br];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 4:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [t, p, br];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 5:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [br, p, q]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function colorToHSB(colorInt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var red, green, blue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>red = ((colorInt &gt;&gt; 16) &amp; 255) / 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>green = ((colorInt &gt;&gt; 8) &amp; 255) / 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>blue = (colorInt &amp; 255) / 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var max = p.max(p.max(red, green), blue),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>min = p.min(p.min(red, green), blue),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hue, saturation;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (min === max) return [0, 0, max * colorModeZ];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>saturation = (max - min) / max;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (red === max) hue = (green - blue) / (max - min);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (green === max) hue = 2 + (blue - red) / (max - min);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else hue = 4 + (red - green) / (max - min);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>hue /= 6;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (hue &lt; 0) hue += 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (hue &gt; 1) hue -= 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return [hue * colorModeX, saturation * colorModeY, max * colorModeZ]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.brightness = function(colInt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return colorToHSB(colInt)[2]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.saturation = function(colInt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return colorToHSB(colInt)[1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.hue = function(colInt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return colorToHSB(colInt)[0]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.red = function(aColor) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ((aColor &gt;&gt; 16) &amp; 255) / 255 * colorModeX</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.green = function(aColor) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ((aColor &amp; 65280) &gt;&gt;&gt; 8) / 255 * colorModeY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.blue = function(aColor) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (aColor &amp; 255) / 255 * colorModeZ</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.alpha = function(aColor) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ((aColor &gt;&gt; 24) &amp; 255) / 255 * colorModeA</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.lerpColor = function(c1, c2, amt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var r, g, b, a, r1, g1, b1, a1, r2, g2, b2, a2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var hsb1, hsb2, rgb, h, s;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var colorBits1 = p.color(c1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var colorBits2 = p.color(c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curColorMode === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hsb1 = colorToHSB(colorBits1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>a1 = ((colorBits1 &gt;&gt; 24) &amp; 255) / colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hsb2 = colorToHSB(colorBits2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>a2 = ((colorBits2 &amp; 4278190080) &gt;&gt;&gt; 24) / colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>h = p.lerp(hsb1[0], hsb2[0], amt);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>s = p.lerp(hsb1[1], hsb2[1], amt);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>b = p.lerp(hsb1[2], hsb2[2], amt);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>rgb = p.color.toRGB(h, s, b);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>a = p.lerp(a1, a2, amt) * colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return a &lt;&lt; 24 &amp; 4278190080 | (rgb[0] &amp; 255) &lt;&lt; 16 | (rgb[1] &amp; 255) &lt;&lt; 8 | rgb[2] &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>r1 = (colorBits1 &gt;&gt; 16) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>g1 = (colorBits1 &gt;&gt; 8) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b1 = colorBits1 &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a1 = ((colorBits1 &gt;&gt; 24) &amp; 255) / colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>r2 = (colorBits2 &amp; 16711680) &gt;&gt;&gt; 16;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>g2 = (colorBits2 &gt;&gt; 8) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b2 = colorBits2 &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a2 = ((colorBits2 &gt;&gt; 24) &amp; 255) / colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>r = p.lerp(r1, r2, amt) | 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>g = p.lerp(g1, g2, amt) | 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b = p.lerp(b1, b2, amt) | 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a = p.lerp(a1, a2, amt) * colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return a &lt;&lt; 24 &amp; 4278190080 | r &lt;&lt; 16 &amp; 16711680 | g &lt;&lt; 8 &amp; 65280 | b &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.colorMode = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curColorMode = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length &gt; 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeX = arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeY = arguments[2] || arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeZ = arguments[3] || arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeA = arguments[4] || arguments[1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.blendColor = function(c1, c2, mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mode === 0) return p.modes.replace(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 1) return p.modes.blend(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 2) return p.modes.add(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 4) return p.modes.subtract(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 8) return p.modes.lightest(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 16) return p.modes.darkest(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 32) return p.modes.difference(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 64) return p.modes.exclusion(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 128) return p.modes.multiply(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 256) return p.modes.screen(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 1024) return p.modes.hard_light(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 2048) return p.modes.soft_light(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 512) return p.modes.overlay(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 4096) return p.modes.dodge(c1, c2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === 8192) return p.modes.burn(c1, c2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function saveContext() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.save()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function restoreContext() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.restore();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isStrokeDirty = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isFillDirty = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.printMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.print()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.translate = function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.translate(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invTranslate(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.translate(x, y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.translate = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.translate(x, y, z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invTranslate(x, y, z)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.scale = function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.scale(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invScale(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.scale(x, y || x)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.scale = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.scale(x, y, z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invScale(x, y, z)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.transform = function(pmatrix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var e = pmatrix.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.transform(e[0], e[3], e[1], e[4], e[2], e[5])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.transformm = function(pmatrix3d) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>throw "p.transform is currently not supported in 3D mode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.pushMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>userMatrixStack.load(modelView);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>userReverseMatrixStack.load(modelViewInv);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>saveContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.pushMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>userMatrixStack.load(modelView);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>userReverseMatrixStack.load(modelViewInv)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.popMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.set(userMatrixStack.pop());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.set(userReverseMatrixStack.pop());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>restoreContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.popMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.set(userMatrixStack.pop());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.set(userReverseMatrixStack.pop())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.resetMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.reset();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.reset();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.setTransform(1, 0, 0, 1, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.resetMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.reset();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.reset()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingShared.prototype.applyMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var a = arguments;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.apply(a[0], a[1], a[2], a[3], a[4], a[5], a[6], a[7], a[8], a[9], a[10], a[11], a[12], a[13], a[14], a[15]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invApply(a[0], a[1], a[2], a[3], a[4], a[5], a[6], a[7], a[8], a[9], a[10], a[11], a[12], a[13], a[14], a[15])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.applyMatrix = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var a = arguments;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var cnt = a.length; cnt &lt; 16; cnt++) a[cnt] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a[10] = a[15] = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.applyMatrix.apply(this, a)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.rotateX = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.rotateX(angleInRadians);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invRotateX(angleInRadians)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.rotateZ = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>throw "rotateZ() is not supported in 2D mode. Use rotate(float) instead.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.rotateZ = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.rotateZ(angleInRadians);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invRotateZ(angleInRadians)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.rotateY = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.rotateY(angleInRadians);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invRotateY(angleInRadians)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.rotate = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.rotateZ(angleInRadians);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.invRotateZ(angleInRadians);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.rotate(angleInRadians)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.rotate = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.rotateZ(angleInRadians)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.shearX = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.shearX(angleInRadians);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.transform(1, 0, angleInRadians, 1, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.shearX = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.shearX(angleInRadians)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.shearY = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.shearY(angleInRadians);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.transform(1, angleInRadians, 0, 1, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.shearY = function(angleInRadians) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.shearY(angleInRadians)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.pushStyle = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>saveContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pushMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var newState = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"doFill": doFill,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"currentFillColor": currentFillColor,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"doStroke": doStroke,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"currentStrokeColor": currentStrokeColor,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curTint": curTint,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curRectMode": curRectMode,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curColorMode": curColorMode,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"colorModeX": colorModeX,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"colorModeZ": colorModeZ,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"colorModeY": colorModeY,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"colorModeA": colorModeA,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curTextFont": curTextFont,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"horizontalTextAlignment": horizontalTextAlignment,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"verticalTextAlignment": verticalTextAlignment,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"textMode": textMode,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curFontName": curFontName,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curTextSize": curTextSize,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curTextAscent": curTextAscent,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curTextDescent": curTextDescent,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"curTextLeading": curTextLeading</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>styleArray.push(newState)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.popStyle = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldState = styleArray.pop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (oldState) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>restoreContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.popMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>doFill = oldState.doFill;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currentFillColor = oldState.currentFillColor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>doStroke = oldState.doStroke;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currentStrokeColor = oldState.currentStrokeColor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTint = oldState.curTint;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curRectMode = oldState.curRectMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curColorMode = oldState.curColorMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeX = oldState.colorModeX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeZ = oldState.colorModeZ;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeY = oldState.colorModeY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>colorModeA = oldState.colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTextFont = oldState.curTextFont;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curFontName = oldState.curFontName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTextSize = oldState.curTextSize;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>horizontalTextAlignment = oldState.horizontalTextAlignment;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>verticalTextAlignment = oldState.verticalTextAlignment;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>textMode = oldState.textMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTextAscent = oldState.curTextAscent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTextDescent = oldState.curTextDescent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTextLeading = oldState.curTextLeading</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else throw "Too many popStyle() without enough pushStyle()";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.year = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (new Date).getFullYear()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.month = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (new Date).getMonth() + 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.day = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (new Date).getDate()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.hour = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (new Date).getHours()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.minute = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (new Date).getMinutes()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.second = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (new Date).getSeconds()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.millis = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return Date.now() - start</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function redrawHelper() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sec = (Date.now() - timeSinceLastFPS) / 1E3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>framesSinceLastFPS++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fps = framesSinceLastFPS / sec;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (sec &gt; 0.5) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>timeSinceLastFPS = Date.now();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>framesSinceLastFPS = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.__frameRate = fps</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.frameCount++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.redraw = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>redrawHelper();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineWidth = lineWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pmouseXLastEvent = p.pmouseX,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pmouseYLastEvent = p.pmouseY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseX = pmouseXLastFrame;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseY = pmouseYLastFrame;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>saveContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.draw();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>restoreContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pmouseXLastFrame = p.mouseX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pmouseYLastFrame = p.mouseY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseX = pmouseXLastEvent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseY = pmouseYLastEvent</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.redraw = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>redrawHelper();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pmouseXLastEvent = p.pmouseX,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pmouseYLastEvent = p.pmouseY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseX = pmouseXLastFrame;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseY = pmouseYLastFrame;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.clear(curContext.DEPTH_BUFFER_BIT);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContextCache = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attributes: {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>locations: {}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.noLights();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.lightFalloff(1, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.shininess(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.ambient(255, 255, 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.specular(0, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.emissive(0, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.camera();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.draw();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pmouseXLastFrame = p.mouseX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pmouseYLastFrame = p.mouseY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseX = pmouseXLastEvent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseY = pmouseYLastEvent</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noLoop = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doLoop = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>loopStarted = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>clearInterval(looping);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curSketch.onPause()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loop = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (loopStarted) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>timeSinceLastFPS = Date.now();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>framesSinceLastFPS = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>looping = window.setInterval(function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curSketch.onFrameStart();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.redraw();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curSketch.onFrameEnd()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e_loop) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>window.clearInterval(looping);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>throw e_loop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curMsPerFrame);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doLoop = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>loopStarted = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curSketch.onLoop()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.frameRate = function(aRate) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curFrameRate = aRate;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curMsPerFrame = 1E3 / curFrameRate;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doLoop) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.noLoop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.loop()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var eventHandlers = [];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function attachEventHandler(elem, type, fn) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (elem.addEventListener) elem.addEventListener(type, fn, false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else elem.attachEvent("on" + type, fn);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>eventHandlers.push({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>elem: elem,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>type: type,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fn: fn</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function detachEventHandler(eventHandler) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var elem = eventHandler.elem,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>type = eventHandler.type,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fn = eventHandler.fn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (elem.removeEventListener) elem.removeEventListener(type, fn, false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (elem.detachEvent) elem.detachEvent("on" + type, fn)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.exit = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>window.clearInterval(looping);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>removeInstance(p.externals.canvas.id);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>delete curElement.onmousedown;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var lib in Processing.lib) if (Processing.lib.hasOwnProperty(lib)) if (Processing.lib[lib].hasOwnProperty("detach")) Processing.lib[lib].detach(p);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i = eventHandlers.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (i--) detachEventHandler(eventHandlers[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curSketch.onExit()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.cursor = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length &gt; 1 || arguments.length === 1 &amp;&amp; arguments[0] instanceof p.PImage) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var image = arguments[0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x, y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length &gt;= 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x = arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = arguments[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (x &lt; 0 || y &lt; 0 || y &gt;= image.height || x &gt;= image.width) throw "x and y must be non-negative and less than the dimensions of the image";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x = image.width &gt;&gt;&gt; 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y = image.height &gt;&gt;&gt; 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var imageDataURL = image.toDataURL();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var style = 'url("' + imageDataURL + '") ' + x + " " + y + ", default";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curCursor = curElement.style.cursor = style</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (arguments.length === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var mode = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curCursor = curElement.style.cursor = mode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else curCursor = curElement.style.cursor = oldCursor</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noCursor = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curCursor = curElement.style.cursor = PConstants.NOCURSOR</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.link = function(href, target) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (target !== undef) window.open(href, target);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else window.location = href</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.beginDraw = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.endDraw = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.toImageData = function(x, y, w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x = x !== undef ? x : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = y !== undef ? y : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>w = w !== undef ? w : p.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>h = h !== undef ? h : p.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return curContext.getImageData(x, y, w, h)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.toImageData = function(x, y, w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x = x !== undef ? x : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = y !== undef ? y : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>w = w !== undef ? w : p.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>h = h !== undef ? h : p.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c = document.createElement("canvas"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctx = c.getContext("2d"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>obj = ctx.createImageData(w, h),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uBuff = new Uint8Array(w * h * 4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.readPixels(x, y, w, h, curContext.RGBA, curContext.UNSIGNED_BYTE, uBuff);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, ul = uBuff.length, obj_data = obj.data; i &lt; ul; i++) obj_data[i] = uBuff[(h - 1 - Math.floor(i / 4 / w)) * w * 4 + i % (w * 4)];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return obj</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.status = function(text) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>window.status = text</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.binary = function(num, numBits) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var bit;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (numBits &gt; 0) bit = numBits;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (num instanceof Char) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bit = 16;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>num |= 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bit = 32;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (bit &gt; 1 &amp;&amp; !(num &gt;&gt;&gt; bit - 1 &amp; 1)) bit--</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (bit &gt; 0) result += num &gt;&gt;&gt; --bit &amp; 1 ? "1" : "0";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.unbinary = function(binaryString) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i = binaryString.length - 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>mask = 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (i &gt;= 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ch = binaryString[i--];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (ch !== "0" &amp;&amp; ch !== "1") throw "the value passed into unbinary was not an 8 bit binary number";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (ch === "1") result += mask;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>mask &lt;&lt;= 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function nfCoreScalar(value, plus, minus, leftDigits, rightDigits, group) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sign = value &lt; 0 ? minus : plus;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var autoDetectDecimals = rightDigits === 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var rightDigitsOfDefault = rightDigits === undef || rightDigits &lt; 0 ? 0 : rightDigits;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var absValue = Math.abs(value);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (autoDetectDecimals) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>rightDigitsOfDefault = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>absValue *= 10;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (Math.abs(Math.round(absValue) - absValue) &gt; 1.0E-6 &amp;&amp; rightDigitsOfDefault &lt; 7) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>++rightDigitsOfDefault;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>absValue *= 10</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (rightDigitsOfDefault !== 0) absValue *= Math.pow(10, rightDigitsOfDefault);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var number, doubled = absValue * 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (Math.floor(absValue) === absValue) number = absValue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (Math.floor(doubled) === doubled) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var floored = Math.floor(absValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>number = floored + floored % 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else number = Math.round(absValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var buffer = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var totalDigits = leftDigits + rightDigitsOfDefault;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (totalDigits &gt; 0 || number &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>totalDigits--;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>buffer = "" + number % 10 + buffer;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>number = Math.floor(number / 10)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (group !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i = buffer.length - 3 - rightDigitsOfDefault;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (i &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>buffer = buffer.substring(0, i) + group + buffer.substring(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>i -= 3</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (rightDigitsOfDefault &gt; 0) return sign + buffer.substring(0, buffer.length - rightDigitsOfDefault) + "." + buffer.substring(buffer.length - rightDigitsOfDefault, buffer.length);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return sign + buffer</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function nfCore(value, plus, minus, leftDigits, rightDigits, group) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (value instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arr = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, len = value.length; i &lt; len; i++) arr.push(nfCoreScalar(value[i], plus, minus, leftDigits, rightDigits, group));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return nfCoreScalar(value, plus, minus, leftDigits, rightDigits, group)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.nf = function(value, leftDigits, rightDigits) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return nfCore(value, "", "-", leftDigits, rightDigits)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.nfs = function(value, leftDigits, rightDigits) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return nfCore(value, " ", "-", leftDigits, rightDigits)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.nfp = function(value, leftDigits, rightDigits) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return nfCore(value, "+", "-", leftDigits, rightDigits)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.nfc = function(value, leftDigits, rightDigits) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return nfCore(value, "", "-", leftDigits, rightDigits, ",")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var decimalToHex = function(d, padding) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>padding = padding === undef || padding === null ? padding = 8 : padding;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (d &lt; 0) d = 4294967295 + d + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var hex = Number(d).toString(16).toUpperCase();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (hex.length &lt; padding) hex = "0" + hex;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (hex.length &gt;= padding) hex = hex.substring(hex.length - padding, hex.length);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return hex</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.hex = function(value, len) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 1) if (value instanceof Char) len = 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else len = 8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return decimalToHex(value, len)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function unhexScalar(hex) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var value = parseInt("0x" + hex, 16);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (value &gt; 2147483647) value -= 4294967296;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.unhex = function(hex) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (hex instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arr = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; hex.length; i++) arr.push(unhexScalar(hex[i]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return unhexScalar(hex)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadStrings = function(filename) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (localStorage[filename]) return localStorage[filename].split("\n");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var filecontent = ajax(filename);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof filecontent !== "string" || filecontent === "") return [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>filecontent = filecontent.replace(/(\r\n?)/g, "\n").replace(/\n$/, "");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return filecontent.split("\n")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.saveStrings = function(filename, strings) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>localStorage[filename] = strings.join("\n")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadBytes = function(url) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var string = ajax(url);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ret = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; string.length; i++) ret.push(string.charCodeAt(i));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ret</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function removeFirstArgument(args) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return Array.prototype.slice.call(args, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.matchAll = function(aString, aRegExp) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var results = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>latest;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var regexp = new RegExp(aRegExp, "g");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while ((latest = regexp.exec(aString)) !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>results.push(latest);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (latest[0].length === 0)++regexp.lastIndex</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return results.length &gt; 0 ? results : null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__contains = function(subject, subStr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.contains.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return subject !== null &amp;&amp; subStr !== null &amp;&amp; typeof subStr === "string" &amp;&amp; subject.indexOf(subStr) &gt; -1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__replaceAll = function(subject, regex, replacement) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.replaceAll.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return subject.replace(new RegExp(regex, "g"), replacement)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__replaceFirst = function(subject, regex, replacement) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.replaceFirst.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return subject.replace(new RegExp(regex, ""), replacement)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__replace = function(subject, what, replacement) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.replace.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (what instanceof RegExp) return subject.replace(what, replacement);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof what !== "string") what = what.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (what === "") return subject;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i = subject.indexOf(what);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (i &lt; 0) return subject;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var j = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>do {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result += subject.substring(j, i) + replacement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>j = i + what.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} while ((i = subject.indexOf(what, j)) &gt;= 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result + subject.substring(j)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__equals = function(subject, other) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (subject.equals instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>Function) return subject.equals.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return subject.valueOf() === other.valueOf()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__equalsIgnoreCase = function(subject, other) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.equalsIgnoreCase.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return subject.toLowerCase() === other.toLowerCase()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__toCharArray = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.toCharArray.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var chars = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, len = subject.length; i &lt; len; ++i) chars[i] = new Char(subject.charAt(i));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return chars</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__split = function(subject, regex, limit) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.split.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pattern = new RegExp(regex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (limit === undef || limit &lt; 1) return subject.split(pattern);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currSubject = subject,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pos;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while ((pos = currSubject.search(pattern)) !== -1 &amp;&amp; result.length &lt; limit - 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var match = pattern.exec(currSubject).toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result.push(currSubject.substring(0, pos));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currSubject = currSubject.substring(pos + match.length)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (pos !== -1 || currSubject !== "") result.push(currSubject);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__codePointAt = function(subject, idx) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var code = subject.charCodeAt(idx),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hi, low;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (55296 &lt;= code &amp;&amp; code &lt;= 56319) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>hi = code;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>low = subject.charCodeAt(idx + 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return (hi - 55296) * 1024 + (low - 56320) + 65536</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return code</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.match = function(str, regexp) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return str.match(regexp)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__matches = function(str, regexp) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (new RegExp(regexp)).test(str)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__startsWith = function(subject, prefix, toffset) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.startsWith.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>toffset = toffset || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (toffset &lt; 0 || toffset &gt; subject.length) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return prefix === "" || prefix === subject ? true : subject.indexOf(prefix) === toffset</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__endsWith = function(subject, suffix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof subject !== "string") return subject.endsWith.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var suffixLen = suffix ? suffix.length : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return suffix === "" || suffix === subject ? true : subject.indexOf(suffix) === subject.length - suffixLen</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__hashCode = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (subject.hashCode instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>Function) return subject.hashCode.apply(subject, removeFirstArgument(arguments));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return virtHashCode(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__printStackTrace = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.println("Exception: " + subject.toString())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var logBuffer = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.println = function(message) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var bufferLen = logBuffer.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (bufferLen) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>Processing.logger.log(logBuffer.join(""));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>logBuffer.length = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 0 &amp;&amp; bufferLen === 0) Processing.logger.log("");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (arguments.length !== 0) Processing.logger.log(message)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.print = function(message) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>logBuffer.push(message)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.str = function(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arr = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; val.length; i++) arr.push(val[i].toString() + "");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return val.toString() + ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.trim = function(str) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (str instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arr = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; str.length; i++) arr.push(str[i].replace(/^\s*/, "").replace(/\s*$/, "").replace(/\r*$/, ""));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return str.replace(/^\s*/, "").replace(/\s*$/, "").replace(/\r*$/, "")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function booleanScalar(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "number") return val !== 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "boolean") return val;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "string") return val.toLowerCase() === "true";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val instanceof Char) return val.code === 49 || val.code === 84 || val.code === 116</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.parseBoolean = function(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ret = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; val.length; i++) ret.push(booleanScalar(val[i]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ret</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return booleanScalar(val)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.parseByte = function(what) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (what instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bytes = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; what.length; i++) bytes.push(0 - (what[i] &amp; 128) | what[i] &amp; 127);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return bytes</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return 0 - (what &amp; 128) | what &amp; 127</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.parseChar = function(key) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof key === "number") return new Char(String.fromCharCode(key &amp; 65535));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (key instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ret = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; key.length; i++) ret.push(new Char(String.fromCharCode(key[i] &amp; 65535)));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ret</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>throw "char() may receive only one argument of type int, byte, int[], or byte[].";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function floatScalar(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "number") return val;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "boolean") return val ? 1 : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "string") return parseFloat(val);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val instanceof Char) return val.code</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.parseFloat = function(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ret = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; val.length; i++) ret.push(floatScalar(val[i]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ret</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return floatScalar(val)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function intScalar(val, radix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "number") return val &amp; 4294967295;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "boolean") return val ? 1 : 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof val === "string") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var number = parseInt(val, radix || 10);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return number &amp; 4294967295</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val instanceof Char) return val.code</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.parseInt = function(val, radix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (val instanceof Array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ret = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; val.length; i++) if (typeof val[i] === "string" &amp;&amp; !/^\s*[+\-]?\d+\s*$/.test(val[i])) ret.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else ret.push(intScalar(val[i], radix));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ret</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return intScalar(val, radix)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__int_cast = function(val) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return 0 | val</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.__instanceof = function(obj, type) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof type !== "function") throw "Function is expected as type argument for instanceof operator";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof obj === "string") return type === Object || type === String;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (obj instanceof type) return true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof obj !== "object" || obj === null) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var objType = obj.constructor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (type.$isInterface) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var interfaces = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (objType) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (objType.$interfaces) interfaces = interfaces.concat(objType.$interfaces);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>objType = objType.$base</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (interfaces.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var i = interfaces.shift();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (i === type) return true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (i.$interfaces) interfaces = interfaces.concat(i.$interfaces)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (objType.hasOwnProperty("$base")) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>objType = objType.$base;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (objType === type) return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.abs = Math.abs;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.ceil = Math.ceil;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.constrain = function(aNumber, aMin, aMax) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return aNumber &gt; aMax ? aMax : aNumber &lt; aMin ? aMin : aNumber</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.dist = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var dx, dy, dz;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dx = arguments[0] - arguments[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dy = arguments[1] - arguments[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return Math.sqrt(dx * dx + dy * dy)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 6) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dx = arguments[0] - arguments[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dy = arguments[1] - arguments[4];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dz = arguments[2] - arguments[5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return Math.sqrt(dx * dx + dy * dy + dz * dz)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.exp = Math.exp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.floor = Math.floor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.lerp = function(value1, value2, amt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (value2 - value1) * amt + value1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.log = Math.log;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.mag = function(a, b, c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (c) return Math.sqrt(a * a + b * b + c * c);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return Math.sqrt(a * a + b * b)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.map = function(value, istart, istop, ostart, ostop) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ostart + (ostop - ostart) * ((value - istart) / (istop - istart))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.max = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 2) return arguments[0] &lt; arguments[1] ? arguments[1] : arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var numbers = arguments.length === 1 ? arguments[0] : arguments;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (! ("length" in numbers &amp;&amp; numbers.length &gt; 0)) throw "Non-empty array is expected";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var max = numbers[0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>count = numbers.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 1; i &lt; count; ++i) if (max &lt; numbers[i]) max = numbers[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return max</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.min = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 2) return arguments[0] &lt; arguments[1] ? arguments[0] : arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var numbers = arguments.length === 1 ? arguments[0] : arguments;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (! ("length" in numbers &amp;&amp; numbers.length &gt; 0)) throw "Non-empty array is expected";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var min = numbers[0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>count = numbers.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 1; i &lt; count; ++i) if (min &gt; numbers[i]) min = numbers[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return min</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.norm = function(aNumber, low, high) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (aNumber - low) / (high - low)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.pow = Math.pow;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.round = Math.round;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.sq = function(aNumber) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return aNumber * aNumber</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.sqrt = Math.sqrt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.acos = Math.acos;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.asin = Math.asin;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.atan = Math.atan;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.atan2 = Math.atan2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.cos = Math.cos;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.degrees = function(aAngle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return aAngle * 180 / Math.PI</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.radians = function(aAngle) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return aAngle / 180 * Math.PI</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.sin = Math.sin;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.tan = Math.tan;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var currentRandom = Math.random;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.random = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 0) return currentRandom();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 1) return currentRandom() * arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aMin = arguments[0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>aMax = arguments[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return currentRandom() * (aMax - aMin) + aMin</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function Marsaglia(i1, i2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var z = i1 || 362436069,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>w = i2 || 521288629;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var nextInt = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>z = 36969 * (z &amp; 65535) + (z &gt;&gt;&gt; 16) &amp; 4294967295;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>w = 18E3 * (w &amp; 65535) + (w &gt;&gt;&gt; 16) &amp; 4294967295;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ((z &amp; 65535) &lt;&lt; 16 | w &amp; 65535) &amp; 4294967295</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.nextDouble = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i = nextInt() / 4294967296;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return i &lt; 0 ? 1 + i : i</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.nextInt = nextInt</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Marsaglia.createRandomized = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var now = new Date;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new Marsaglia(now / 6E4 &amp; 4294967295, now &amp; 4294967295)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.randomSeed = function(seed) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentRandom = (new Marsaglia(seed)).nextDouble</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.Random = function(seed) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var haveNextNextGaussian = false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>nextNextGaussian, random;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.nextGaussian = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (haveNextNextGaussian) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>haveNextNextGaussian = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return nextNextGaussian</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var v1, v2, s;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>do {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v1 = 2 * random() - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v2 = 2 * random() - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>s = v1 * v1 + v2 * v2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} while (s &gt;= 1 || s === 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var multiplier = Math.sqrt(-2 * Math.log(s) / s);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>nextNextGaussian = v2 * multiplier;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>haveNextNextGaussian = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return v1 * multiplier</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>random = seed === undef ? Math.random : (new Marsaglia(seed)).nextDouble</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function PerlinNoise(seed) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var rnd = seed !== undef ? new Marsaglia(seed) : Marsaglia.createRandomized();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, j;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var perm = new Uint8Array(512);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; 256; ++i) perm[i] = i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; 256; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var t = perm[j = rnd.nextInt() &amp; 255];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>perm[j] = perm[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>perm[i] = t</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; 256; ++i) perm[i + 256] = perm[i];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function grad3d(i, x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var h = i &amp; 15;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var u = h &lt; 8 ? x : y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v = h &lt; 4 ? y : h === 12 || h === 14 ? x : z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ((h &amp; 1) === 0 ? u : -u) + ((h &amp; 2) === 0 ? v : -v)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function grad2d(i, x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var v = (i &amp; 1) === 0 ? x : y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return (i &amp; 2) === 0 ? -v : v</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function grad1d(i, x) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return (i &amp; 1) === 0 ? -x : x</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function lerp(t, a, b) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return a + t * (b - a)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.noise3d = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var X = Math.floor(x) &amp; 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>Y = Math.floor(y) &amp; 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>Z = Math.floor(z) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x -= Math.floor(x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y -= Math.floor(y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>z -= Math.floor(z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fx = (3 - 2 * x) * x * x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>fy = (3 - 2 * y) * y * y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>fz = (3 - 2 * z) * z * z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var p0 = perm[X] + Y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p00 = perm[p0] + Z,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p01 = perm[p0 + 1] + Z,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p1 = perm[X + 1] + Y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p10 = perm[p1] + Z,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p11 = perm[p1 + 1] + Z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return lerp(fz, lerp(fy, lerp(fx, grad3d(perm[p00], x, y, z), grad3d(perm[p10], x - 1, y, z)), lerp(fx, grad3d(perm[p01], x, y - 1, z), grad3d(perm[p11], x - 1, y - 1, z))), lerp(fy, lerp(fx, grad3d(perm[p00 + 1], x, y, z - 1), grad3d(perm[p10 + 1], x - 1, y, z - 1)), lerp(fx, grad3d(perm[p01 + 1], x, y - 1, z - 1), grad3d(perm[p11 + 1], x - 1, y - 1, z - 1))))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.noise2d = function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var X = Math.floor(x) &amp; 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>Y = Math.floor(y) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x -= Math.floor(x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y -= Math.floor(y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fx = (3 - 2 * x) * x * x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>fy = (3 - 2 * y) * y * y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var p0 = perm[X] + Y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p1 = perm[X + 1] + Y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return lerp(fy, lerp(fx, grad2d(perm[p0], x, y), grad2d(perm[p1], x - 1, y)), lerp(fx, grad2d(perm[p0 + 1], x, y - 1), grad2d(perm[p1 + 1], x - 1, y - 1)))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.noise1d = function(x) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var X = Math.floor(x) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x -= Math.floor(x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fx = (3 - 2 * x) * x * x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return lerp(fx, grad1d(perm[X], x), grad1d(perm[X + 1], x - 1))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var noiseProfile = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>generator: undef,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>octaves: 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fallout: 0.5,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>seed: undef</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noise = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (noiseProfile.generator === undef) noiseProfile.generator = new PerlinNoise(noiseProfile.seed);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var generator = noiseProfile.generator;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var effect = 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>k = 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sum = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; noiseProfile.octaves; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>effect *= noiseProfile.fallout;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>switch (arguments.length) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case 1:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sum += effect * (1 + generator.noise1d(k * x)) / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case 2:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sum += effect * (1 + generator.noise2d(k * x, k * y)) / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case 3:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sum += effect * (1 + generator.noise3d(k * x, k * y, k * z)) / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>k *= 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return sum</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noiseDetail = function(octaves, fallout) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>noiseProfile.octaves = octaves;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (fallout !== undef) noiseProfile.fallout = fallout</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noiseSeed = function(seed) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>noiseProfile.seed = seed;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>noiseProfile.generator = undef</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingShared.prototype.size = function(aWidth, aHeight, aMode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doStroke) p.stroke(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doFill) p.fill(255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var savedProperties = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillStyle: curContext.fillStyle,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>strokeStyle: curContext.strokeStyle,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lineCap: curContext.lineCap,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lineJoin: curContext.lineJoin</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curElement.style.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curElement.style.removeProperty("width");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curElement.style.removeProperty("height")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.width = p.width = aWidth || 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.height = p.height = aHeight || 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var prop in savedProperties) if (savedProperties.hasOwnProperty(prop)) curContext[prop] = savedProperties[prop];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.textFont(curTextFont);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.background();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>maxPixelsCached = Math.max(1E3, aWidth * aHeight * 0.05);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.externals.context = curContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; 720; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sinLUT[i] = p.sin(i * (Math.PI / 180) * 0.5);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cosLUT[i] = p.cos(i * (Math.PI / 180) * 0.5)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.size = function(aWidth, aHeight, aMode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curContext === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext = curElement.getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>userMatrixStack = new PMatrixStack;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>userReverseMatrixStack = new PMatrixStack;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>modelView = new PMatrix2D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>modelViewInv = new PMatrix2D</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.size.apply(this, arguments)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.size = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var size3DCalled = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return function size(aWidth, aHeight, aMode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (size3DCalled) throw "Multiple calls to size() for 3D renders are not allowed.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>size3DCalled = true;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function getGLContext(canvas) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var ctxNames = ["experimental-webgl", "webgl", "webkit-3d"],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>gl;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (var i = 0, l = ctxNames.length; i &lt; l; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>gl = canvas.getContext(ctxNames[i], {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>antialias: false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>preserveDrawingBuffer: true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (gl) break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return gl</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curElement.width = p.width = aWidth || 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curElement.height = p.height = aHeight || 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext = getGLContext(curElement);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>canTex = curContext.createTexture();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>textTex = curContext.createTexture()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e_size) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>Processing.debug(e_size)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!curContext) throw "WebGL context is not supported on this browser.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.viewport(0, 0, curElement.width, curElement.height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.enable(curContext.DEPTH_TEST);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.enable(curContext.BLEND);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.blendFunc(curContext.SRC_ALPHA, curContext.ONE_MINUS_SRC_ALPHA);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>programObject2D = createProgramObject(curContext, vertexShaderSrc2D, fragmentShaderSrc2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>programObjectUnlitShape = createProgramObject(curContext, vertexShaderSrcUnlitShape, fragmentShaderSrcUnlitShape);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.strokeWeight(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>programObject3D = createProgramObject(curContext, vertexShaderSrc3D, fragmentShaderSrc3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("usingTexture3d", programObject3D, "usingTexture", usingTexture);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.lightFalloff(1, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.shininess(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.ambient(255, 255, 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.specular(0, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.emissive(0, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>boxBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, boxBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, boxVerts, curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>boxNormBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, boxNormBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, boxNorms, curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>boxOutlineBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, boxOutlineBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, boxOutlineVerts, curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>rectBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, rectBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, rectVerts, curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>rectNormBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, rectNormBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, rectNorms, curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lineBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillColorBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>strokeColorBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>shapeTexVBO = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pointBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, pointBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array([0, 0, 0]), curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>textBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, textBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array([1, 1, 0, -1, 1, 0, -1, -1, 0, 1, -1, 0]), curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>textureBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, textureBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array([0, 0, 1, 0, 1, 1, 0, 1]), curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>indexBuffer = curContext.createBuffer();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindBuffer(curContext.ELEMENT_ARRAY_BUFFER, indexBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ELEMENT_ARRAY_BUFFER, new Uint16Array([0, 1, 2, 2, 3, 0]), curContext.STATIC_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cam = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraInv = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>modelView = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>modelViewInv = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>projection = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.camera();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.perspective();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>userMatrixStack = new PMatrixStack;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>userReverseMatrixStack = new PMatrixStack;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curveBasisMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curveToBezierMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curveDrawMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bezierDrawMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bezierBasisInverse = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bezierBasisMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bezierBasisMatrix.set(-1, 3, -3, 1, 3, -6, 3, 0, -3, 3, 0, 0, 1, 0, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>DrawingShared.prototype.size.apply(this, arguments)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.ambientLight = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.ambientLight = function(r, g, b, x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lightCount === 8) throw "can only create " + 8 + " lights";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pos = new PVector(x, y, z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.mult(pos, pos);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = color$4(r, g, b, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var normalizedCol = [((col &gt;&gt; 16) &amp; 255) / 255, ((col &gt;&gt; 8) &amp; 255) / 255, (col &amp; 255) / 255];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.color.3d." + lightCount, programObject3D, "uLights" + lightCount + ".color", normalizedCol);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.position.3d." + lightCount, programObject3D, "uLights" + lightCount + ".position", pos.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLights.type.3d." + lightCount, programObject3D, "uLights" + lightCount + ".type", 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLightCount3d", programObject3D, "uLightCount", ++lightCount)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.directionalLight = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.directionalLight = function(r, g, b, nx, ny, nz) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lightCount === 8) throw "can only create " + 8 + " lights";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mvm = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mvm.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mvm.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mvm = mvm.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var dir = [mvm[0] * nx + mvm[4] * ny + mvm[8] * nz, mvm[1] * nx + mvm[5] * ny + mvm[9] * nz, mvm[2] * nx + mvm[6] * ny + mvm[10] * nz];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = color$4(r, g, b, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var normalizedCol = [((col &gt;&gt; 16) &amp; 255) / 255, ((col &gt;&gt; 8) &amp; 255) / 255, (col &amp; 255) / 255];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.color.3d." + lightCount, programObject3D, "uLights" + lightCount + ".color", normalizedCol);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.position.3d." + lightCount, programObject3D, "uLights" + lightCount + ".position", dir);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLights.type.3d." + lightCount, programObject3D, "uLights" + lightCount + ".type", 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLightCount3d", programObject3D, "uLightCount", ++lightCount)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.lightFalloff = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.lightFalloff = function(constant, linear, quadratic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uFalloff3d", programObject3D, "uFalloff", [constant, linear, quadratic])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.lightSpecular = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.lightSpecular = function(r, g, b) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = color$4(r, g, b, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var normalizedCol = [((col &gt;&gt; 16) &amp; 255) / 255, ((col &gt;&gt; 8) &amp; 255) / 255, (col &amp; 255) / 255];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uSpecular3d", programObject3D, "uSpecular", normalizedCol)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.lights = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.ambientLight(128, 128, 128);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.directionalLight(128, 128, 128, 0, 0, -1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.lightFalloff(1, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.lightSpecular(0, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.pointLight = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.pointLight = function(r, g, b, x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lightCount === 8) throw "can only create " + 8 + " lights";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pos = new PVector(x, y, z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.mult(pos, pos);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = color$4(r, g, b, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var normalizedCol = [((col &gt;&gt; 16) &amp; 255) / 255, ((col &gt;&gt; 8) &amp; 255) / 255, (col &amp; 255) / 255];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.color.3d." + lightCount, programObject3D, "uLights" + lightCount + ".color", normalizedCol);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.position.3d." + lightCount, programObject3D, "uLights" + lightCount + ".position", pos.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLights.type.3d." + lightCount, programObject3D, "uLights" + lightCount + ".type", 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLightCount3d", programObject3D, "uLightCount", ++lightCount)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.noLights = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.noLights = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lightCount = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLightCount3d", programObject3D, "uLightCount", lightCount)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.spotLight = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.spotLight = function(r, g, b, x, y, z, nx, ny, nz, angle, concentration) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lightCount === 8) throw "can only create " + 8 + " lights";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pos = new PVector(x, y, z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mvm = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mvm.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mvm.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mvm.mult(pos, pos);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mvm = mvm.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var dir = [mvm[0] * nx + mvm[4] * ny + mvm[8] * nz, mvm[1] *</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>nx + mvm[5] * ny + mvm[9] * nz, mvm[2] * nx + mvm[6] * ny + mvm[10] * nz];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = color$4(r, g, b, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var normalizedCol = [((col &gt;&gt; 16) &amp; 255) / 255, ((col &gt;&gt; 8) &amp; 255) / 255, (col &amp; 255) / 255];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.color.3d." + lightCount, programObject3D, "uLights" + lightCount + ".color", normalizedCol);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.position.3d." + lightCount, programObject3D, "uLights" + lightCount + ".position", pos.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.direction.3d." + lightCount, programObject3D, "uLights" + lightCount + ".direction", dir);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.concentration.3d." + lightCount, programObject3D, "uLights" + lightCount + ".concentration", concentration);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uLights.angle.3d." + lightCount, programObject3D, "uLights" + lightCount + ".angle", angle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLights.type.3d." + lightCount, programObject3D, "uLights" + lightCount + ".type", 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uLightCount3d", programObject3D, "uLightCount", ++lightCount)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.beginCamera = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>throw "beginCamera() is not available in 2D mode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.beginCamera = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (manipulatingCamera) throw "You cannot call beginCamera() again before calling endCamera()";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>manipulatingCamera = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView = cameraInv;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv = cam</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.endCamera = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>throw "endCamera() is not available in 2D mode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.endCamera = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!manipulatingCamera) throw "You cannot call endCamera() before calling beginCamera()";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.set(cam);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.set(cameraInv);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>manipulatingCamera = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.camera = function(eyeX, eyeY, eyeZ, centerX, centerY, centerZ, upX, upY, upZ) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (eyeX === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraX = p.width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraY = p.height / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraZ = cameraY / Math.tan(cameraFOV / 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>eyeX = cameraX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>eyeY = cameraY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>eyeZ = cameraZ;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>centerX = cameraX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>centerY = cameraY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>centerZ = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>upX = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>upY = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>upZ = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var z = new PVector(eyeX - centerX, eyeY - centerY, eyeZ - centerZ);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var y = new PVector(upX, upY, upZ);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>z.normalize();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var x = PVector.cross(y, z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = PVector.cross(z, x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x.normalize();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y.normalize();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var xX = x.x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xY = x.y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xZ = x.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var yX = y.x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yY = y.y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yZ = y.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var zX = z.x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>zY = z.y,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>zZ = z.z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cam.set(xX, xY, xZ, 0, yX, yY, yZ, 0, zX, zY, zZ, 0, 0, 0, 0, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cam.translate(-eyeX, -eyeY, -eyeZ);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraInv.reset();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraInv.invApply(xX, xY, xZ, 0, yX, yY, yZ, 0, zX, zY, zZ, 0, 0, 0, 0, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cameraInv.translate(eyeX, eyeY, eyeZ);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelView.set(cam);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>modelViewInv.set(cameraInv)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.perspective = function(fov, aspect, near, far) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraY = curElement.height / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraZ = cameraY / Math.tan(cameraFOV / 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraNear = cameraZ / 10;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraFar = cameraZ * 10;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cameraAspect = p.width / p.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fov = cameraFOV;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>aspect = cameraAspect;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>near = cameraNear;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>far = cameraFar</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var yMax, yMin, xMax, xMin;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>yMax = near * Math.tan(fov / 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>yMin = -yMax;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>xMax = yMax * aspect;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>xMin = yMin * aspect;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.frustum(xMin, xMax, yMin, yMax, near, far)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.frustum = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>throw "Processing.js: frustum() is not supported in 2D mode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.frustum = function(left, right, bottom, top, near, far) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>frustumMode = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>projection = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>projection.set(2 * near / (right - left), 0, (right + left) / (right - left), 0, 0, 2 * near / (top - bottom), (top + bottom) / (top - bottom), 0, 0, 0, -(far + near) / (far - near), -(2 * far * near) / (far - near), 0, 0, -1, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var proj = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>proj.set(projection);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>proj.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("projection2d", programObject2D, "uProjection", false, proj.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("projection3d", programObject3D, "uProjection", false, proj.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObjectUnlitShape);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uProjectionUS", programObjectUnlitShape, "uProjection", false, proj.array())</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.ortho = function(left, right, bottom, top, near, far) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>left = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>right = p.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bottom = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>top = p.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>near = -10;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>far = 10</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var x = 2 / (right - left);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var y = 2 / (top - bottom);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var z = -2 / (far - near);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tx = -(right + left) / (right - left);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ty = -(top + bottom) / (top - bottom);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tz = -(far + near) / (far - near);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>projection = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>projection.set(x, 0, 0, tx, 0, y, 0, ty, 0, 0, z, tz, 0, 0, 0, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var proj = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>proj.set(projection);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>proj.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("projection2d", programObject2D, "uProjection", false, proj.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("projection3d", programObject3D, "uProjection", false, proj.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObjectUnlitShape);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uProjectionUS", programObjectUnlitShape, "uProjection", false, proj.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>frustumMode = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.printProjection = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>projection.print()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.printCamera = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cam.print()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.box = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.box = function(w, h, d) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!h || !d) h = d = w;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var model = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.scale(w, h, d);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("model3d", programObject3D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("view3d", programObject3D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.enable(curContext.POLYGON_OFFSET_FILL);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.polygonOffset(1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("color3d", programObject3D, "uColor", fillStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (lightCount &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var v = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v.set(view);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var m = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>m.set(model);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v.mult(m);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var normalMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.set(v);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.invert();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>uniformMatrix("uNormalTransform3d", programObject3D, "uNormalTransform", false, normalMatrix.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>vertexAttribPointer("aNormal3d", programObject3D, "aNormal", 3, boxNormBuffer)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else disableVertexAttribPointer("aNormal3d", programObject3D, "aNormal");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("aVertex3d", programObject3D, "aVertex", 3, boxBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aColor3d", programObject3D, "aColor");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aTexture3d", programObject3D, "aTexture");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.TRIANGLES, 0, boxVerts.length / 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.disable(curContext.POLYGON_OFFSET_FILL)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lineWidth &gt; 0 &amp;&amp; doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uModel2d", programObject2D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uView2d", programObject2D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("uColor2d", programObject2D, "uColor", strokeStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("uIsDrawingText2d", programObject2D, "uIsDrawingText", false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("vertex2d", programObject2D, "aVertex", 3, boxOutlineBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aTextureCoord2d", programObject2D, "aTextureCoord");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.LINES, 0, boxOutlineVerts.length / 3)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var initSphere = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; sphereDetailU; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(-1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereX[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereY[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereZ[i])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(-1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(sphereX[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(sphereY[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(sphereZ[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var v1, v11, v2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var voff = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 2; i &lt; sphereDetailV; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v1 = v11 = voff;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>voff += sphereDetailU;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v2 = voff;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = 0; j &lt; sphereDetailU; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereVerts.push(sphereX[v1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereVerts.push(sphereY[v1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereVerts.push(sphereZ[v1++]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereVerts.push(sphereX[v2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereVerts.push(sphereY[v2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereVerts.push(sphereZ[v2++])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v1 = v11;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v2 = voff;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereX[v1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereY[v1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereZ[v1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereX[v2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereY[v2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereZ[v2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; sphereDetailU; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v2 = voff + i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereX[v2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereY[v2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(sphereZ[v2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sphereVerts.push(0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(sphereX[voff]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(sphereY[voff]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(sphereZ[voff]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereVerts.push(0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bindBuffer(curContext.ARRAY_BUFFER, sphereBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(sphereVerts), curContext.STATIC_DRAW)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.sphereDetail = function(ures, vres) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 1) ures = vres = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (ures &lt; 3) ures = 3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (vres &lt; 2) vres = 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (ures === sphereDetailU &amp;&amp; vres === sphereDetailV) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var delta = 720 / ures;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var cx = new Float32Array(ures);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var cz = new Float32Array(ures);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; ures; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cx[i] = cosLUT[i * delta % 720 | 0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cz[i] = sinLUT[i * delta % 720 | 0]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vertCount = ures * (vres - 1) + 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var currVert = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereX = new Float32Array(vertCount);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereY = new Float32Array(vertCount);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereZ = new Float32Array(vertCount);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var angle_step = 720 * 0.5 / vres;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var angle = angle_step;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 1; i &lt; vres; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var curradius = sinLUT[angle % 720 | 0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var currY = -cosLUT[angle % 720 | 0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = 0; j &lt; ures; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereX[currVert] = cx[j] * curradius;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereY[currVert] = currY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>sphereZ[currVert++] = cz[j] * curradius</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>angle += angle_step</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereDetailU = ures;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sphereDetailV = vres;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>initSphere()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.sphere = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.sphere = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sRad = arguments[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (sphereDetailU &lt; 3 || sphereDetailV &lt; 2) p.sphereDetail(30);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var model = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.scale(sRad, sRad, sRad);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (lightCount &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var v = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v.set(view);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var m = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>m.set(model);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v.mult(m);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var normalMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.set(v);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.invert();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>uniformMatrix("uNormalTransform3d", programObject3D, "uNormalTransform", false, normalMatrix.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>vertexAttribPointer("aNormal3d", programObject3D, "aNormal", 3, sphereBuffer)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else disableVertexAttribPointer("aNormal3d", programObject3D, "aNormal");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aTexture3d", programObject3D, "aTexture");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uModel3d", programObject3D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uView3d", programObject3D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("aVertex3d", programObject3D, "aVertex", 3, sphereBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aColor3d", programObject3D, "aColor");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.enable(curContext.POLYGON_OFFSET_FILL);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.polygonOffset(1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("uColor3d", programObject3D, "uColor", fillStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.TRIANGLE_STRIP, 0, sphereVerts.length / 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.disable(curContext.POLYGON_OFFSET_FILL)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lineWidth &gt; 0 &amp;&amp; doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uModel2d", programObject2D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uView2d", programObject2D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("aVertex2d", programObject2D, "aVertex", 3, sphereBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aTextureCoord2d", programObject2D, "aTextureCoord");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("uColor2d", programObject2D, "uColor", strokeStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("uIsDrawingText", programObject2D, "uIsDrawingText", false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.LINE_STRIP, 0, sphereVerts.length / 3)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.modelX = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mv = modelView.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ci = cameraInv.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ax = mv[0] * x + mv[1] * y + mv[2] * z + mv[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ay = mv[4] * x + mv[5] * y + mv[6] * z + mv[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var az = mv[8] * x + mv[9] * y + mv[10] * z + mv[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aw = mv[12] * x + mv[13] * y + mv[14] * z + mv[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ox = ci[0] * ax + ci[1] * ay + ci[2] * az + ci[3] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ow = ci[12] * ax + ci[13] * ay + ci[14] * az + ci[15] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ow !== 0 ? ox / ow : ox</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.modelY = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mv = modelView.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ci = cameraInv.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ax = mv[0] * x + mv[1] * y + mv[2] * z + mv[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ay = mv[4] * x + mv[5] * y + mv[6] * z + mv[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var az = mv[8] * x + mv[9] * y + mv[10] * z + mv[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aw = mv[12] * x + mv[13] * y + mv[14] * z + mv[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oy = ci[4] * ax + ci[5] * ay + ci[6] * az + ci[7] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ow = ci[12] * ax + ci[13] * ay + ci[14] * az + ci[15] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ow !== 0 ? oy / ow : oy</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.modelZ = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mv = modelView.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ci = cameraInv.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ax = mv[0] * x + mv[1] * y + mv[2] * z + mv[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ay = mv[4] * x + mv[5] * y + mv[6] * z + mv[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var az = mv[8] * x + mv[9] * y + mv[10] * z + mv[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aw = mv[12] * x + mv[13] * y + mv[14] * z + mv[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oz = ci[8] * ax + ci[9] * ay + ci[10] * az + ci[11] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ow = ci[12] * ax + ci[13] * ay + ci[14] * az + ci[15] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ow !== 0 ? oz / ow : oz</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.ambient = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.ambient = function(v1, v2, v3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uUsingMat3d", programObject3D, "uUsingMat", true);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = p.color(v1, v2, v3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uMaterialAmbient3d", programObject3D, "uMaterialAmbient", p.color.toGLArray(col).slice(0, 3))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.emissive = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.emissive = function(v1, v2, v3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uUsingMat3d", programObject3D, "uUsingMat", true);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = p.color(v1, v2, v3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uMaterialEmissive3d", programObject3D, "uMaterialEmissive", p.color.toGLArray(col).slice(0, 3))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.shininess = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.shininess = function(shine) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uUsingMat3d", programObject3D, "uUsingMat", true);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uShininess3d", programObject3D, "uShininess", shine)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.specular = DrawingShared.prototype.a3DOnlyFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.specular = function(v1, v2, v3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uUsingMat3d", programObject3D, "uUsingMat", true);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var col = p.color(v1, v2, v3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uMaterialSpecular3d", programObject3D, "uMaterialSpecular", p.color.toGLArray(col).slice(0, 3))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.screenX = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mv = modelView.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mv.length === 16) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ax = mv[0] * x + mv[1] * y + mv[2] * z + mv[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ay = mv[4] * x + mv[5] * y + mv[6] * z + mv[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var az = mv[8] * x + mv[9] * y + mv[10] * z + mv[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var aw = mv[12] * x + mv[13] * y + mv[14] * z + mv[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var pj = projection.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ox = pj[0] * ax + pj[1] * ay + pj[2] * az + pj[3] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ow = pj[12] * ax + pj[13] * ay + pj[14] * az + pj[15] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (ow !== 0) ox /= ow;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return p.width * (1 + ox) / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return modelView.multX(x, y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.screenY = function screenY(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mv = modelView.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mv.length === 16) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ax = mv[0] * x + mv[1] * y + mv[2] * z + mv[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ay = mv[4] * x + mv[5] * y + mv[6] * z + mv[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var az = mv[8] * x + mv[9] * y + mv[10] * z + mv[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var aw = mv[12] * x + mv[13] * y + mv[14] * z + mv[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var pj = projection.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var oy = pj[4] * ax + pj[5] * ay + pj[6] * az + pj[7] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var ow = pj[12] * ax + pj[13] * ay + pj[14] * az + pj[15] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (ow !== 0) oy /= ow;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return p.height * (1 + oy) / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return modelView.multY(x, y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.screenZ = function screenZ(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var mv = modelView.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mv.length !== 16) return 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pj = projection.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ax = mv[0] * x + mv[1] * y + mv[2] * z + mv[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ay = mv[4] * x + mv[5] * y + mv[6] * z + mv[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var az = mv[8] * x + mv[9] * y + mv[10] * z + mv[11];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aw = mv[12] * x + mv[13] * y + mv[14] * z + mv[15];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oz = pj[8] * ax + pj[9] * ay + pj[10] * az + pj[11] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ow = pj[12] * ax + pj[13] * ay + pj[14] * az + pj[15] * aw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (ow !== 0) oz /= ow;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (oz + 1) / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingShared.prototype.fill = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var color = p.color(arguments[0], arguments[1], arguments[2], arguments[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (color === currentFillColor &amp;&amp; doFill) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doFill = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentFillColor = color</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.fill = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.fill.apply(this, arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isFillDirty = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.fill = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.fill.apply(this, arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fillStyle = p.color.toGLArray(currentFillColor)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function executeContextFill() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (isFillDirty) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.fillStyle = p.color.toString(currentFillColor);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>isFillDirty = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.fill()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noFill = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doFill = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingShared.prototype.stroke = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var color = p.color(arguments[0], arguments[1], arguments[2], arguments[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (color === currentStrokeColor &amp;&amp; doStroke) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doStroke = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentStrokeColor = color</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.stroke = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.stroke.apply(this, arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isStrokeDirty = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.stroke = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.stroke.apply(this, arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>strokeStyle = p.color.toGLArray(currentStrokeColor)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function executeContextStroke() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (isStrokeDirty) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.strokeStyle = p.color.toString(currentStrokeColor);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>isStrokeDirty = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.stroke()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noStroke = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>doStroke = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingShared.prototype.strokeWeight = function(w) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lineWidth = w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.strokeWeight = function(w) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.strokeWeight.apply(this, arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineWidth = w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.strokeWeight = function(w) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>DrawingShared.prototype.strokeWeight.apply(this, arguments);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("pointSize2d", programObject2D, "uPointSize", w);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObjectUnlitShape);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("pointSizeUnlitShape", programObjectUnlitShape, "uPointSize", w);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineWidth(w)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.strokeCap = function(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawing.$ensureContext().lineCap = value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.strokeJoin = function(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawing.$ensureContext().lineJoin = value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.smooth = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>renderSmooth = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var style = curElement.style;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setProperty("image-rendering", "optimizeQuality", "important");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setProperty("-ms-interpolation-mode", "bicubic", "important");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curContext.hasOwnProperty("mozImageSmoothingEnabled")) curContext.mozImageSmoothingEnabled = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.smooth = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>renderSmooth = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.noSmooth = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>renderSmooth = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var style = curElement.style;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setProperty("image-rendering", "optimizeSpeed", "important");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setProperty("image-rendering", "-moz-crisp-edges", "important");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setProperty("image-rendering", "-webkit-optimize-contrast", "important");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setProperty("image-rendering", "optimize-contrast", "important");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>style.setProperty("-ms-interpolation-mode", "nearest-neighbor", "important");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curContext.hasOwnProperty("mozImageSmoothingEnabled")) curContext.mozImageSmoothingEnabled = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.noSmooth = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>renderSmooth = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.point = function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!doStroke) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x = Math.round(x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = Math.round(y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.fillStyle = p.color.toString(currentStrokeColor);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isFillDirty = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lineWidth &gt; 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.arc(x, y, lineWidth / 2, 0, 6.283185307179586, false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.fill()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else curContext.fillRect(x, y, 1, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.point = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var model = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.translate(x, y, z || 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uModel2d", programObject2D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uView2d", programObject2D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lineWidth &gt; 0 &amp;&amp; doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("uColor2d", programObject2D, "uColor", strokeStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("uIsDrawingText2d", programObject2D, "uIsDrawingText", false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("uSmooth2d", programObject2D, "uSmooth", renderSmooth);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("aVertex2d", programObject2D, "aVertex", 3, pointBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aTextureCoord2d", programObject2D, "aTextureCoord");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.POINTS, 0, 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.beginShape = function(type) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curShape = type;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curvePoints = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertArray = []</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.vertex = function(x, y, moveTo) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vert = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (firstVert) firstVert = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert["isVert"] = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[0] = x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[1] = y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[2] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[3] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[4] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[5] = currentFillColor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[6] = currentStrokeColor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertArray.push(vert);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (moveTo) vertArray[vertArray.length - 1]["moveTo"] = moveTo</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.vertex = function(x, y, z, u, v) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vert = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (firstVert) firstVert = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert["isVert"] = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (v === undef &amp;&amp; usingTexture) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v = u;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>u = z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>z = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (u !== undef &amp;&amp; v !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (curTextureMode === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>u /= curTexture.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v /= curTexture.height</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>u = u &gt; 1 ? 1 : u;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>u = u &lt; 0 ? 0 : u;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v = v &gt; 1 ? 1 : v;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>v = v &lt; 0 ? 0 : v</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[0] = x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[1] = y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[2] = z || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[3] = u || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[4] = v || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[5] = fillStyle[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[6] = fillStyle[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[7] = fillStyle[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[8] = fillStyle[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[9] = strokeStyle[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[10] = strokeStyle[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[11] = strokeStyle[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[12] = strokeStyle[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[13] = normalX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[14] = normalY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[15] = normalZ;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertArray.push(vert)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var point3D = function(vArray, cArray) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObjectUnlitShape);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uViewUS", programObjectUnlitShape, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uSmoothUS", programObjectUnlitShape, "uSmooth", renderSmooth);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("aVertexUS", programObjectUnlitShape, "aVertex", 3, pointBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(vArray), curContext.STREAM_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("aColorUS", programObjectUnlitShape, "aColor", 4, fillColorBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(cArray), curContext.STREAM_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.drawArrays(curContext.POINTS, 0, vArray.length / 3)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var line3D = function(vArray, mode, cArray) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ctxMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mode === "LINES") ctxMode = curContext.LINES;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === "LINE_LOOP") ctxMode = curContext.LINE_LOOP;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else ctxMode = curContext.LINE_STRIP;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObjectUnlitShape);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uViewUS", programObjectUnlitShape, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("aVertexUS", programObjectUnlitShape, "aVertex", 3, lineBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(vArray), curContext.STREAM_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("aColorUS", programObjectUnlitShape, "aColor", 4, strokeColorBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(cArray), curContext.STREAM_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.drawArrays(ctxMode, 0, vArray.length / 3)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var fill3D = function(vArray, mode, cArray, tArray) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ctxMode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mode === "TRIANGLES") ctxMode = curContext.TRIANGLES;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === "TRIANGLE_FAN") ctxMode = curContext.TRIANGLE_FAN;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else ctxMode = curContext.TRIANGLE_STRIP;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("model3d", programObject3D, "uModel", false, [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("view3d", programObject3D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.enable(curContext.POLYGON_OFFSET_FILL);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.polygonOffset(1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("color3d", programObject3D, "uColor", [-1, 0, 0, 0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("vertex3d", programObject3D, "aVertex", 3, fillBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(vArray), curContext.STREAM_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (usingTexture &amp;&amp; curTint !== null) curTint3d(cArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("aColor3d", programObject3D, "aColor", 4, fillColorBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(cArray), curContext.STREAM_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>disableVertexAttribPointer("aNormal3d", programObject3D, "aNormal");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (usingTexture) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("uUsingTexture3d", programObject3D, "uUsingTexture", usingTexture);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("aTexture3d", programObject3D, "aTexture", 2, shapeTexVBO);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(tArray), curContext.STREAM_DRAW)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.drawArrays(ctxMode, 0, vArray.length / 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.disable(curContext.POLYGON_OFFSET_FILL)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function fillStrokeClose() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeContextFill();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeContextStroke();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.closePath()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.endShape = function(mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (vertArray.length === 0) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var closeShape = mode === 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (closeShape) vertArray.push(vertArray[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lineVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fillVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var colorVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var strokeVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var texVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var cachedVertArray;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>firstVert = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, j, k;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vertArrayLength = vertArray.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 0; j &lt; 3; j++) fillVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>texVertArray.push(cachedVertArray[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>texVertArray.push(cachedVertArray[4])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (isCurve &amp;&amp; (curShape === 20 || curShape === undef)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (vertArrayLength &gt; 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var b = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>s = 1 - curTightness;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.moveTo(vertArray[1][0], vertArray[1][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 1; i + 2 &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>b[0] = [cachedVertArray[0], cachedVertArray[1]];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>b[1] = [cachedVertArray[0] + (s * vertArray[i + 1][0] - s * vertArray[i - 1][0]) / 6, cachedVertArray[1] + (s * vertArray[i + 1][1] - s * vertArray[i - 1][1]) / 6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>b[2] = [vertArray[i + 1][0] + (s * vertArray[i][0] - s * vertArray[i + 2][0]) / 6, vertArray[i + 1][1] + (s * vertArray[i][1] - s * vertArray[i + 2][1]) / 6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>b[3] = [vertArray[i + 1][0], vertArray[i + 1][1]];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.bezierCurveTo(b[1][0], b[1][1], b[2][0], b[2][1], b[3][0], b[3][1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>fillStrokeClose()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (isBezier &amp;&amp; (curShape === 20 || curShape === undef)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (vertArray[i]["isVert"]) if (vertArray[i]["moveTo"]) curContext.moveTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else curContext.lineTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else curContext.bezierCurveTo(vertArray[i][0], vertArray[i][1], vertArray[i][2], vertArray[i][3], vertArray[i][4], vertArray[i][5])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillStrokeClose()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curShape === 2) for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doStroke) p.stroke(cachedVertArray[6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.point(cachedVertArray[0], cachedVertArray[1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curShape === 4) for (i = 0; i + 1 &lt; vertArrayLength; i += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doStroke) p.stroke(vertArray[i + 1][6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.line(cachedVertArray[0], cachedVertArray[1], vertArray[i + 1][0], vertArray[i + 1][1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curShape === 9) for (i = 0; i + 2 &lt; vertArrayLength; i += 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.moveTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.lineTo(vertArray[i + 1][0], vertArray[i + 1][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.lineTo(vertArray[i + 2][0], vertArray[i + 2][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.lineTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.fill(vertArray[i + 2][5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>executeContextFill()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.stroke(vertArray[i + 2][6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>executeContextStroke()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.closePath()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curShape === 10) for (i = 0; i + 1 &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.moveTo(vertArray[i + 1][0], vertArray[i + 1][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.lineTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doStroke) p.stroke(vertArray[i + 1][6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doFill) p.fill(vertArray[i + 1][5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (i + 2 &lt; vertArrayLength) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.lineTo(vertArray[i + 2][0], vertArray[i + 2][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doStroke) p.stroke(vertArray[i + 2][6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doFill) p.fill(vertArray[i + 2][5])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillStrokeClose()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curShape === 11) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (vertArrayLength &gt; 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.moveTo(vertArray[0][0], vertArray[0][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.lineTo(vertArray[1][0], vertArray[1][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.lineTo(vertArray[2][0], vertArray[2][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.fill(vertArray[2][5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>executeContextFill()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.stroke(vertArray[2][6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>executeContextStroke()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.closePath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 3; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.moveTo(vertArray[0][0], vertArray[0][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.lineTo(vertArray[i - 1][0], vertArray[i - 1][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.lineTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>p.fill(cachedVertArray[5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>executeContextFill()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>p.stroke(cachedVertArray[6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>executeContextStroke()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.closePath()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curShape === 16) for (i = 0; i + 3 &lt; vertArrayLength; i += 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.moveTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 1; j &lt; 4; j++) curContext.lineTo(vertArray[i + j][0], vertArray[i + j][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.lineTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.fill(vertArray[i + 3][5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>executeContextFill()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.stroke(vertArray[i + 3][6]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>executeContextStroke()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.closePath()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curShape === 17) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (vertArrayLength &gt; 3) for (i = 0; i + 1 &lt; vertArrayLength; i += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (i + 3 &lt; vertArrayLength) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.moveTo(vertArray[i + 2][0], vertArray[i + 2][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.lineTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.lineTo(vertArray[i + 1][0], vertArray[i + 1][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.lineTo(vertArray[i + 3][0], vertArray[i + 3][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doFill) p.fill(vertArray[i + 3][5]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doStroke) p.stroke(vertArray[i + 3][6])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.moveTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.lineTo(vertArray[i + 1][0], vertArray[i + 1][1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>fillStrokeClose()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.moveTo(vertArray[0][0], vertArray[0][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 1; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (cachedVertArray["isVert"]) if (cachedVertArray["moveTo"]) curContext.moveTo(cachedVertArray[0], cachedVertArray[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else curContext.lineTo(cachedVertArray[0], cachedVertArray[1])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillStrokeClose()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isCurve = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isBezier = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertCount = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (closeShape) vertArray.pop()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.endShape = function(mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (vertArray.length === 0) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var closeShape = mode === 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lineVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fillVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var colorVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var strokeVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var texVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var cachedVertArray;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>firstVert = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, j, k;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vertArrayLength = vertArray.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 0; j &lt; 3; j++) fillVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>texVertArray.push(cachedVertArray[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>texVertArray.push(cachedVertArray[4])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (closeShape) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillVertArray.push(vertArray[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillVertArray.push(vertArray[0][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fillVertArray.push(vertArray[0][2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 5; i &lt; 9; i++) colorVertArray.push(vertArray[0][i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 9; i &lt; 13; i++) strokeVertArray.push(vertArray[0][i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>texVertArray.push(vertArray[0][3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>texVertArray.push(vertArray[0][4])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (isCurve &amp;&amp; (curShape === 20 || curShape === undef)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lineVertArray = fillVertArray;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doStroke) line3D(lineVertArray, null, strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doFill) fill3D(fillVertArray, null, colorVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (isBezier &amp;&amp; (curShape === 20 || curShape === undef)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lineVertArray = fillVertArray;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lineVertArray.splice(lineVertArray.length - 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>strokeVertArray.splice(strokeVertArray.length - 4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doStroke) line3D(lineVertArray, null, strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (doFill) fill3D(fillVertArray, "TRIANGLES", colorVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (curShape === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>point3D(lineVertArray, strokeVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (curShape === 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>line3D(lineVertArray, "LINES", strokeVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (curShape === 9) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (vertArrayLength &gt; 2) for (i = 0; i + 2 &lt; vertArrayLength; i += 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>fillVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>texVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>lineVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colorVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>strokeVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) for (k = 0; k &lt; 3; k++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lineVertArray.push(vertArray[i + j][k]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>fillVertArray.push(vertArray[i + j][k])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) for (k = 3; k &lt; 5; k++) texVertArray.push(vertArray[i + j][k]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) for (k = 5; k &lt; 9; k++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>colorVertArray.push(vertArray[i + j][k]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray.push(vertArray[i + j][k + 4])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doStroke) line3D(lineVertArray, "LINE_LOOP", strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doFill || usingTexture) fill3D(fillVertArray, "TRIANGLES", colorVertArray, texVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (curShape === 10) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (vertArrayLength &gt; 2) for (i = 0; i + 2 &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>lineVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>fillVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>strokeVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colorVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>texVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) for (k = 0; k &lt; 3; k++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lineVertArray.push(vertArray[i + j][k]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>fillVertArray.push(vertArray[i + j][k])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) for (k = 3; k &lt; 5; k++) texVertArray.push(vertArray[i + j][k]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) for (k = 5; k &lt; 9; k++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray.push(vertArray[i + j][k + 4]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>colorVertArray.push(vertArray[i + j][k])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doFill || usingTexture) fill3D(fillVertArray, "TRIANGLE_STRIP", colorVertArray, texVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doStroke) line3D(lineVertArray, "LINE_LOOP", strokeVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (curShape === 11) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (vertArrayLength &gt; 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (i = 0; i &lt; 3; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (i = 0; i &lt; 3; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doStroke) line3D(lineVertArray, "LINE_LOOP", strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (i = 2; i + 1 &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lineVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lineVertArray.push(vertArray[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lineVertArray.push(vertArray[0][1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lineVertArray.push(vertArray[0][2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray.push(vertArray[0][9]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray.push(vertArray[0][10]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray.push(vertArray[0][11]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray.push(vertArray[0][12]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 2; j++) for (k = 0; k &lt; 3; k++) lineVertArray.push(vertArray[i + j][k]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 2; j++) for (k = 9; k &lt; 13; k++) strokeVertArray.push(vertArray[i + j][k]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (doStroke) line3D(lineVertArray, "LINE_STRIP", strokeVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doFill || usingTexture) fill3D(fillVertArray, "TRIANGLE_FAN", colorVertArray, texVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (curShape === 16) for (i = 0; i + 3 &lt; vertArrayLength; i += 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lineVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (j = 0; j &lt; 4; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cachedVertArray = vertArray[i + j];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (k = 0; k &lt; 3; k++) lineVertArray.push(cachedVertArray[k])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doStroke) line3D(lineVertArray, "LINE_LOOP", strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>fillVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colorVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>texVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) fillVertArray.push(vertArray[i][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(vertArray[i][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) fillVertArray.push(vertArray[i + 1][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(vertArray[i + 1][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) fillVertArray.push(vertArray[i + 3][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(vertArray[i + 3][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) fillVertArray.push(vertArray[i + 2][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(vertArray[i + 2][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (usingTexture) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 0][3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 0][4]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 1][3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 1][4]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 3][3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 3][4]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 2][3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>texVertArray.push(vertArray[i + 2][4])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>fill3D(fillVertArray, "TRIANGLE_STRIP", colorVertArray, texVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (curShape === 17) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var tempArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (vertArrayLength &gt; 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (i = 0; i &lt; 2; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (i = 0; i &lt; 2; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>line3D(lineVertArray, "LINE_STRIP", strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (vertArrayLength &gt; 4 &amp;&amp; vertArrayLength % 2 &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>tempArray = fillVertArray.splice(fillVertArray.length - 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>vertArray.pop()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (i = 0; i + 3 &lt; vertArrayLength; i += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>lineVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>strokeVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(vertArray[i + 1][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(vertArray[i + 3][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(vertArray[i + 2][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(vertArray[i + 0][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(vertArray[i + 1][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(vertArray[i + 3][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(vertArray[i + 2][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(vertArray[i + 0][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (doStroke) line3D(lineVertArray, "LINE_STRIP", strokeVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (doFill || usingTexture) fill3D(fillVertArray, "TRIANGLE_LIST", colorVertArray, texVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (vertArrayLength === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(vertArray[0][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (j = 9; j &lt; 13; j++) strokeVertArray.push(vertArray[0][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>point3D(lineVertArray, strokeVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0; i &lt; vertArrayLength; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cachedVertArray = vertArray[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 0; j &lt; 3; j++) lineVertArray.push(cachedVertArray[j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (j = 5; j &lt; 9; j++) strokeVertArray.push(cachedVertArray[j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doStroke &amp;&amp; closeShape) line3D(lineVertArray, "LINE_LOOP", strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (doStroke &amp;&amp; !closeShape) line3D(lineVertArray, "LINE_STRIP", strokeVertArray);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doFill || usingTexture) fill3D(fillVertArray, "TRIANGLE_FAN", colorVertArray, texVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>usingTexture = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("usingTexture3d", programObject3D, "uUsingTexture", usingTexture)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isCurve = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isBezier = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertCount = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var splineForward = function(segments, matrix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var f = 1 / segments;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ff = f * f;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fff = ff * f;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>matrix.set(0, 0, 0, 1, fff, ff, f, 0, 6 * fff, 2 * ff, 0, 0, 6 * fff, 0, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var curveInit = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!curveDrawMatrix) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curveBasisMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curveDrawMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curveInited = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var s = curTightness;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveBasisMatrix.set((s - 1) / 2, (s + 3) / 2, (-3 - s) / 2, (1 - s) / 2, 1 - s, (-5 - s) / 2, s + 2, (s - 1) / 2, (s - 1) / 2, 0, (1 - s) / 2, 0, 0, 1, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>splineForward(curveDet, curveDrawMatrix);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!bezierBasisInverse) curveToBezierMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveToBezierMatrix.set(curveBasisMatrix);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveToBezierMatrix.preApply(bezierBasisInverse);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveDrawMatrix.apply(curveBasisMatrix)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.bezierVertex = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isBezier = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vert = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (firstVert) throw "vertex() must be used at least once before calling bezierVertex()";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; arguments.length; i++) vert[i] = arguments[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertArray.push(vert);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertArray[vertArray.length - 1]["isVert"] = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.bezierVertex = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isBezier = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vert = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (firstVert) throw "vertex() must be used at least once before calling bezierVertex()";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 9) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (bezierDrawMatrix === undef) bezierDrawMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var lastPoint = vertArray.length - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>splineForward(bezDetail, bezierDrawMatrix);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bezierDrawMatrix.apply(bezierBasisMatrix);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var draw = bezierDrawMatrix.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var x1 = vertArray[lastPoint][0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y1 = vertArray[lastPoint][1],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>z1 = vertArray[lastPoint][2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xplot1 = draw[4] * x1 + draw[5] * arguments[0] + draw[6] * arguments[3] + draw[7] * arguments[6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xplot2 = draw[8] * x1 + draw[9] * arguments[0] + draw[10] * arguments[3] + draw[11] * arguments[6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xplot3 = draw[12] * x1 + draw[13] * arguments[0] + draw[14] * arguments[3] + draw[15] * arguments[6];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var yplot1 = draw[4] * y1 + draw[5] * arguments[1] + draw[6] * arguments[4] + draw[7] * arguments[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var yplot2 = draw[8] * y1 + draw[9] * arguments[1] + draw[10] * arguments[4] + draw[11] * arguments[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var yplot3 = draw[12] * y1 + draw[13] * arguments[1] + draw[14] * arguments[4] + draw[15] * arguments[7];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var zplot1 = draw[4] * z1 + draw[5] * arguments[2] + draw[6] * arguments[5] + draw[7] * arguments[8];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var zplot2 = draw[8] * z1 + draw[9] * arguments[2] + draw[10] * arguments[5] + draw[11] * arguments[8];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var zplot3 = draw[12] * z1 + draw[13] * arguments[2] + draw[14] * arguments[5] + draw[15] * arguments[8];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = 0; j &lt; bezDetail; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x1 += xplot1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xplot1 += xplot2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xplot2 += xplot3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y1 += yplot1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>yplot1 += yplot2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>yplot2 += yplot3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>z1 += zplot1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>zplot1 += zplot2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>zplot2 += zplot3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.vertex(x1, y1, z1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(arguments[6], arguments[7], arguments[8])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.texture = function(pimage) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var curContext = drawing.$ensureContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (pimage.__texture) curContext.bindTexture(curContext.TEXTURE_2D, pimage.__texture);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (pimage.localName === "canvas") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindTexture(curContext.TEXTURE_2D, canTex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texImage2D(curContext.TEXTURE_2D, 0, curContext.RGBA, curContext.RGBA, curContext.UNSIGNED_BYTE, pimage);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_MAG_FILTER, curContext.LINEAR);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_MIN_FILTER, curContext.LINEAR);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.generateMipmap(curContext.TEXTURE_2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTexture.width = pimage.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTexture.height = pimage.height</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var texture = curContext.createTexture(),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cvs = document.createElement("canvas"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cvsTextureCtx = cvs.getContext("2d"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pot;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (pimage.width &amp; pimage.width - 1 === 0) cvs.width = pimage.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pot = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (pot &lt; pimage.width) pot *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cvs.width = pot</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (pimage.height &amp; pimage.height - 1 === 0) cvs.height = pimage.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pot = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (pot &lt; pimage.height) pot *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cvs.height = pot</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cvsTextureCtx.drawImage(pimage.sourceImg, 0, 0, pimage.width, pimage.height, 0, 0, cvs.width, cvs.height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bindTexture(curContext.TEXTURE_2D, texture);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_MIN_FILTER, curContext.LINEAR_MIPMAP_LINEAR);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_MAG_FILTER, curContext.LINEAR);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_WRAP_T, curContext.CLAMP_TO_EDGE);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_WRAP_S, curContext.CLAMP_TO_EDGE);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.texImage2D(curContext.TEXTURE_2D, 0, curContext.RGBA, curContext.RGBA, curContext.UNSIGNED_BYTE, cvs);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.generateMipmap(curContext.TEXTURE_2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pimage.__texture = texture;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTexture.width = pimage.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTexture.height = pimage.height</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>usingTexture = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("usingTexture3d", programObject3D, "uUsingTexture", usingTexture)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textureMode = function(mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextureMode = mode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var curveVertexSegment = function(x1, y1, z1, x2, y2, z2, x3, y3, z3, x4, y4, z4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var x0 = x2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var y0 = y2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var z0 = z2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var draw = curveDrawMatrix.array();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var xplot1 = draw[4] * x1 + draw[5] * x2 + draw[6] * x3 + draw[7] * x4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var xplot2 = draw[8] * x1 + draw[9] * x2 + draw[10] * x3 + draw[11] * x4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var xplot3 = draw[12] * x1 + draw[13] * x2 + draw[14] * x3 + draw[15] * x4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var yplot1 = draw[4] * y1 + draw[5] * y2 + draw[6] * y3 + draw[7] * y4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var yplot2 = draw[8] * y1 + draw[9] * y2 + draw[10] * y3 + draw[11] * y4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var yplot3 = draw[12] * y1 + draw[13] * y2 + draw[14] * y3 + draw[15] * y4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var zplot1 = draw[4] * z1 + draw[5] * z2 + draw[6] * z3 + draw[7] * z4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var zplot2 = draw[8] * z1 + draw[9] * z2 + draw[10] * z3 + draw[11] * z4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var zplot3 = draw[12] * z1 + draw[13] * z2 + draw[14] * z3 + draw[15] * z4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x0, y0, z0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var j = 0; j &lt; curveDet; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x0 += xplot1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xplot1 += xplot2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xplot2 += xplot3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y0 += yplot1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yplot1 += yplot2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yplot2 += yplot3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>z0 += zplot1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>zplot1 += zplot2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>zplot2 += zplot3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(x0, y0, z0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.curveVertex = function(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isCurve = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x, y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.curveVertex = function(x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isCurve = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!curveInited) curveInit();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var vert = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[0] = x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[1] = y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vert[2] = z;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertArray.push(vert);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveVertCount++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curveVertCount &gt; 3) curveVertexSegment(curveVertArray[curveVertCount - 4][0], curveVertArray[curveVertCount - 4][1], curveVertArray[curveVertCount - 4][2], curveVertArray[curveVertCount - 3][0], curveVertArray[curveVertCount - 3][1], curveVertArray[curveVertCount - 3][2], curveVertArray[curveVertCount - 2][0], curveVertArray[curveVertCount - 2][1], curveVertArray[curveVertCount - 2][2], curveVertArray[curveVertCount - 1][0], curveVertArray[curveVertCount - 1][1], curveVertArray[curveVertCount - 1][2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.curve = function(x1, y1, x2, y2, x3, y3, x4, y4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(x1, y1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(x2, y2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(x3, y3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(x4, y4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.curve = function(x1, y1, z1, x2, y2, z2, x3, y3, z3, x4, y4, z4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (z4 !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.curveVertex(x1, y1, z1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.curveVertex(x2, y2, z2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.curveVertex(x3, y3, z3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.curveVertex(x4, y4, z4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.endShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(x1, y1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(z1, x2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(y2, z2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.curveVertex(x3, y3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.curveTightness = function(tightness) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTightness = tightness</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.curveDetail = function(detail) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveDet = detail;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curveInit()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.rectMode = function(aRectMode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curRectMode = aRectMode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.imageMode = function(mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>switch (mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 0:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>imageModeConvert = imageModeCorner;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 1:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>imageModeConvert = imageModeCorners;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 3:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>imageModeConvert = imageModeCenter;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>default:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>throw "Invalid imageMode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.ellipseMode = function(aEllipseMode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curEllipseMode = aEllipseMode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.arc = function(x, y, width, height, start, stop) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (width &lt;= 0 || stop &lt; start) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curEllipseMode === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width = width - x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height = height - y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curEllipseMode === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x = x - width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y = y - height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width = width * 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height = height * 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curEllipseMode === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x = x - width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y = y - height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (start &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>start += 6.283185307179586;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>stop += 6.283185307179586</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (stop - start &gt; 6.283185307179586) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>start = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>stop = 6.283185307179586</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var hr = width / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vr = height / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>centerX = x + hr,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>centerY = y + vr,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>startLUT = 0 | 0.5 + start * p.RAD_TO_DEG * 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>stopLUT = 0 | 0.5 + stop * p.RAD_TO_DEG * 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>i, j;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var savedStroke = doStroke;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>doStroke = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(centerX, centerY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = startLUT; i &lt;= stopLUT; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>j = i % 720;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.vertex(centerX + cosLUT[j] * hr, centerY + sinLUT[j] * vr)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.endShape(2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>doStroke = savedStroke</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var savedFill = doFill;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>doFill = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = startLUT; i &lt;= stopLUT; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>j = i % 720;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.vertex(centerX + cosLUT[j] * hr, centerY + sinLUT[j] * vr)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.endShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>doFill = savedFill</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.line = function(x1, y1, x2, y2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!doStroke) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x1 = Math.round(x1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x2 = Math.round(x2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y1 = Math.round(y1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y2 = Math.round(y2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (x1 === x2 &amp;&amp; y1 === y2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.point(x1, y1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var swap = undef,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lineCap = undef,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>drawCrisp = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currentModelView = modelView.array(),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>identityMatrix = [1, 0, 0, 0, 1, 0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; 6 &amp;&amp; drawCrisp; i++) drawCrisp = currentModelView[i] === identityMatrix[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (drawCrisp) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (x1 === x2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (y1 &gt; y2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>swap = y1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>y1 = y2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>y2 = swap</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>y2++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lineWidth % 2 === 1) curContext.translate(0.5, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (y1 === y2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (x1 &gt; x2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>swap = x1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>x1 = x2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>x2 = swap</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>x2++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lineWidth % 2 === 1) curContext.translate(0, 0.5)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (lineWidth === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lineCap = curContext.lineCap;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.lineCap = "butt"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.moveTo(x1 || 0, y1 || 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineTo(x2 || 0, y2 || 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeContextStroke();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (drawCrisp) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (x1 === x2 &amp;&amp; lineWidth % 2 === 1) curContext.translate(-0.5, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (y1 === y2 &amp;&amp; lineWidth % 2 === 1) curContext.translate(0, -0.5);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (lineWidth === 1) curContext.lineCap = lineCap</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.line = function(x1, y1, z1, x2, y2, z2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (y2 === undef || z2 === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>z2 = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y2 = x2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x2 = z1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>z1 = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (x1 === x2 &amp;&amp; y1 === y2 &amp;&amp; z1 === z2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.point(x1, y1, z1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lineVerts = [x1, y1, z1, x2, y2, z2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lineWidth &gt; 0 &amp;&amp; doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uModel2d", programObject2D, "uModel", false, [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uView2d", programObject2D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("uColor2d", programObject2D, "uColor", strokeStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("uIsDrawingText", programObject2D, "uIsDrawingText", false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("aVertex2d", programObject2D, "aVertex", 3, lineBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aTextureCoord2d", programObject2D, "aTextureCoord");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.bufferData(curContext.ARRAY_BUFFER, new Float32Array(lineVerts), curContext.STREAM_DRAW);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.LINES, 0, 2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.bezier = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length !== 8) throw "You must use 8 parameters for bezier() in 2D mode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(arguments[0], arguments[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.bezierVertex(arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.bezier = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length !== 12) throw "You must use 12 parameters for bezier() in 3D mode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(arguments[0], arguments[1], arguments[2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.bezierVertex(arguments[3], arguments[4], arguments[5], arguments[6], arguments[7], arguments[8], arguments[9], arguments[10], arguments[11]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.bezierDetail = function(detail) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>bezDetail = detail</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.bezierPoint = function(a, b, c, d, t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (1 - t) * (1 - t) * (1 - t) * a + 3 * (1 - t) * (1 - t) * t * b + 3 * (1 - t) * t * t * c + t * t * t * d</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.bezierTangent = function(a, b, c, d, t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return 3 * t * t * (-a + 3 * b - 3 * c + d) + 6 * t * (a - 2 * b + c) + 3 * (-a + b)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.curvePoint = function(a, b, c, d, t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return 0.5 * (2 * b + (-a + c) * t + (2 * a - 5 * b + 4 * c - d) * t * t + (-a + 3 * b - 3 * c + d) * t * t * t)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.curveTangent = function(a, b, c, d, t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return 0.5 * (-a + c + 2 * (2 * a - 5 * b + 4 * c - d) * t + 3 * (-a + 3 * b - 3 * c + d) * t * t)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.triangle = function(x1, y1, x2, y2, x3, y3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.beginShape(9);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x1, y1, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x2, y2, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x3, y3, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.quad = function(x1, y1, x2, y2, x3, y3, x4, y4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.beginShape(16);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x1, y1, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x2, y2, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x3, y3, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x4, y4, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var roundedRect$2d = function(x, y, width, height, tl, tr, br, bl) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (bl === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tr = tl;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>br = tl;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bl = tl</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var halfWidth = width / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>halfHeight = height / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (tl &gt; halfWidth || tl &gt; halfHeight) tl = Math.min(halfWidth, halfHeight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (tr &gt; halfWidth || tr &gt; halfHeight) tr = Math.min(halfWidth, halfHeight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (br &gt; halfWidth || br &gt; halfHeight) br = Math.min(halfWidth, halfHeight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (bl &gt; halfWidth || bl &gt; halfHeight) bl = Math.min(halfWidth, halfHeight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!doFill || doStroke) curContext.translate(0.5, 0.5);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.moveTo(x + tl, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineTo(x + width - tr, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.quadraticCurveTo(x + width, y, x + width, y + tr);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineTo(x + width, y + height - br);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.quadraticCurveTo(x + width, y + height, x + width - br, y + height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineTo(x + bl, y + height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.quadraticCurveTo(x, y + height, x, y + height - bl);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineTo(x, y + tl);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.quadraticCurveTo(x, y, x + tl, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!doFill || doStroke) curContext.translate(-0.5, -0.5);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeContextFill();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeContextStroke()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.rect = function(x, y, width, height, tl, tr, br, bl) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!width &amp;&amp; !height) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curRectMode === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width -= x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height -= y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curRectMode === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x -= width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y -= height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curRectMode === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x -= width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y -= height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x = Math.round(x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = Math.round(y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>width = Math.round(width);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>height = Math.round(height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (tl !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>roundedRect$2d(x, y, width, height, tl, tr, br, bl);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doStroke &amp;&amp; lineWidth % 2 === 1) curContext.translate(0.5, 0.5);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.rect(x, y, width, height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeContextFill();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeContextStroke();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doStroke &amp;&amp; lineWidth % 2 === 1) curContext.translate(-0.5, -0.5)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.rect = function(x, y, width, height, tl, tr, br, bl) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (tl !== undef) throw "rect() with rounded corners is not supported in 3D mode";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curRectMode === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width -= x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height -= y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curRectMode === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x -= width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y -= height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curRectMode === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x -= width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y -= height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var model = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.translate(x, y, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.scale(width, height, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lineWidth &gt; 0 &amp;&amp; doStroke) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uModel2d", programObject2D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uView2d", programObject2D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("uColor2d", programObject2D, "uColor", strokeStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformi("uIsDrawingText2d", programObject2D, "uIsDrawingText", false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("aVertex2d", programObject2D, "aVertex", 3, rectBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>disableVertexAttribPointer("aTextureCoord2d", programObject2D, "aTextureCoord");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.LINE_LOOP, 0, rectVerts.length / 3)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.useProgram(programObject3D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uModel3d", programObject3D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformMatrix("uView3d", programObject3D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.enable(curContext.POLYGON_OFFSET_FILL);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.polygonOffset(1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uniformf("color3d", programObject3D, "uColor", fillStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (lightCount &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var v = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v.set(view);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var m = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>m.set(model);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>v.mult(m);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var normalMatrix = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.set(v);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.invert();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>normalMatrix.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>uniformMatrix("uNormalTransform3d", programObject3D, "uNormalTransform", false, normalMatrix.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>vertexAttribPointer("aNormal3d", programObject3D, "aNormal", 3, rectNormBuffer)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else disableVertexAttribPointer("normal3d", programObject3D, "aNormal");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertexAttribPointer("vertex3d", programObject3D, "aVertex", 3, rectBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.drawArrays(curContext.TRIANGLE_FAN, 0, rectVerts.length / 3);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.disable(curContext.POLYGON_OFFSET_FILL)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.ellipse = function(x, y, width, height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x = x || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = y || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (width &lt;= 0 &amp;&amp; height &lt;= 0) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curEllipseMode === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height *= 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curEllipseMode === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width = width - x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height = height - y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x += width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y += height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curEllipseMode === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x += width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y += height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (width === height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.beginPath();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.arc(x, y, width / 2, 0, 6.283185307179586, false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>executeContextFill();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>executeContextStroke()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var w = width / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>h = height / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>C = 0.5522847498307933,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>c_x = C * w,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>c_y = C * h;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(x + w, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.bezierVertex(x + w, y - c_y, x + c_x, y - h, x, y - h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.bezierVertex(x - c_x, y - h, x - w, y - c_y, x - w, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.bezierVertex(x - w, y + c_y, x - c_x, y + h, x, y + h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.bezierVertex(x + c_x, y + h, x + w, y + c_y, x + w, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.ellipse = function(x, y, width, height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x = x || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = y || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (width &lt;= 0 &amp;&amp; height &lt;= 0) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curEllipseMode === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width *= 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height *= 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curEllipseMode === 1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width = width - x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height = height - y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x += width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y += height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (curEllipseMode === 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x += width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y += height / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var w = width / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>h = height / 2,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>C = 0.5522847498307933,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>c_x = C * w,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>c_y = C * h;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.beginShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.vertex(x + w, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.bezierVertex(x + w, y - c_y, 0, x + c_x, y - h, 0, x, y - h, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.bezierVertex(x - c_x, y - h, 0, x - w, y - c_y, 0, x - w, y, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.bezierVertex(x - w, y + c_y, 0, x - c_x, y + h, 0, x, y + h, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.bezierVertex(x + c_x, y + h, 0, x + w, y + c_y, 0, x + w, y, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.endShape();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (doFill) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xAv = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>yAv = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>i, j;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; vertArray.length; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xAv += vertArray[i][0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>yAv += vertArray[i][1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xAv /= vertArray.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yAv /= vertArray.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var vert = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>fillVertArray = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colorVertArray = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[0] = xAv;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[1] = yAv;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[2] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[3] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[4] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[5] = fillStyle[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[6] = fillStyle[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[7] = fillStyle[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[8] = fillStyle[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[9] = strokeStyle[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[10] = strokeStyle[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[11] = strokeStyle[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[12] = strokeStyle[3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[13] = normalX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[14] = normalY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vert[15] = normalZ;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>vertArray.unshift(vert);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; vertArray.length; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (j = 0; j &lt; 3; j++) fillVertArray.push(vertArray[i][j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (j = 5; j &lt; 9; j++) colorVertArray.push(vertArray[i][j])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fill3D(fillVertArray, "TRIANGLE_FAN", colorVertArray)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.normal = function(nx, ny, nz) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length !== 3 || !(typeof nx === "number" &amp;&amp; typeof ny === "number" &amp;&amp; typeof nz === "number")) throw "normal() requires three numeric arguments.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalX = nx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalY = ny;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>normalZ = nz;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curShape !== 0) if (normalMode === 0) normalMode = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (normalMode === 1) normalMode = 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.save = function(file, img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img !== undef) return window.open(img.toDataURL(), "_blank");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return window.open(p.externals.canvas.toDataURL(), "_blank")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var saveNumber = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.saveFrame = function(file) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (file === undef) file = "screen-####.png";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var frameFilename = file.replace(/#+/, function(all) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var s = "" + saveNumber++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (s.length &lt; all.length) s = "0" + s;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return s</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.save(frameFilename)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var utilityContext2d = document.createElement("canvas").getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var canvasDataCache = [undef, undef, undef];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function getCanvasData(obj, w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var canvasData = canvasDataCache.shift();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (canvasData === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>canvasData = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>canvasData.canvas = document.createElement("canvas");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>canvasData.context = canvasData.canvas.getContext("2d")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>canvasDataCache.push(canvasData);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var canvas = canvasData.canvas,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>context = canvasData.context,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width = w || obj.width,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height = h || obj.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>canvas.width = width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>canvas.height = height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!obj) context.clearRect(0, 0, width, height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if ("data" in obj) context.putImageData(obj, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>context.clearRect(0, 0, width, height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>context.drawImage(obj, 0, 0, width, height)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return canvasData</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function buildPixelsObject(pImage) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>getLength: function(aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (aImg.isRemote) throw "Image is loaded remotely. Cannot get length.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>else return aImg.imageData.data.length ? aImg.imageData.data.length / 4 : 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}(pImage),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>getPixel: function(aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return function(i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var offset = i * 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>data = aImg.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (aImg.isRemote) throw "Image is loaded remotely. Cannot get pixels.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return (data[offset + 3] &amp; 255) &lt;&lt; 24 | (data[offset] &amp; 255) &lt;&lt; 16 | (data[offset + 1] &amp; 255) &lt;&lt; 8 | data[offset + 2] &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}(pImage),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>setPixel: function(aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return function(i, c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var offset = i * 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>data = aImg.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (aImg.isRemote) throw "Image is loaded remotely. Cannot set pixel.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>data[offset + 0] = (c &gt;&gt; 16) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>data[offset + 1] = (c &gt;&gt; 8) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>data[offset + 2] = c &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>data[offset + 3] = (c &gt;&gt; 24) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>aImg.__isDirty = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}(pImage),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>toArray: function(aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var arr = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>data = aImg.imageData.data,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>length = aImg.width * aImg.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (aImg.isRemote) throw "Image is loaded remotely. Cannot get pixels.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (var i = 0, offset = 0; i &lt; length; i++, offset += 4) arr.push((data[offset + 3] &amp; 255) &lt;&lt; 24 | (data[offset] &amp; 255) &lt;&lt; 16 | (data[offset + 1] &amp; 255) &lt;&lt; 8 | data[offset + 2] &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}(pImage),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>set: function(aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return function(arr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var offset, data, c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (this.isRemote) throw "Image is loaded remotely. Cannot set pixels.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>data = aImg.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (var i = 0, aL = arr.length; i &lt; aL; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>c = arr[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>offset = i * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>data[offset + 0] = (c &gt;&gt; 16) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>data[offset + 1] = (c &gt;&gt; 8) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>data[offset + 2] = c &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>data[offset + 3] = (c &gt;&gt; 24) &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>aImg.__isDirty = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}(pImage)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var PImage = function(aWidth, aHeight, aFormat) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.__isDirty = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aWidth instanceof HTMLImageElement) this.fromHTMLImageData(aWidth);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (aHeight || aFormat) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.width = aWidth || 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.height = aHeight || 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var canvas = this.sourceImg = document.createElement("canvas");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>canvas.width = this.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>canvas.height = this.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var imageData = this.imageData = canvas.getContext("2d").createImageData(this.width, this.height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.format = aFormat === 2 || aFormat === 4 ? aFormat : 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.format === 1) for (var i = 3, data = this.imageData.data, len = data.length; i &lt; len; i += 4) data[i] = 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.__isDirty = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.updatePixels()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.width = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.height = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.imageData = utilityContext2d.createImageData(1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.format = 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.pixels = buildPixelsObject(this)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PImage.prototype = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>__isPImage: true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updatePixels: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var canvas = this.sourceImg;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (canvas &amp;&amp; canvas instanceof HTMLCanvasElement &amp;&amp; this.__isDirty) canvas.getContext("2d").putImageData(this.imageData, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.__isDirty = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fromHTMLImageData: function(htmlImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var canvasData = getCanvasData(htmlImg);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var imageData = canvasData.context.getImageData(0, 0, htmlImg.width, htmlImg.height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fromImageData(imageData)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (htmlImg.width &amp;&amp; htmlImg.height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.isRemote = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.width = htmlImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.height = htmlImg.height</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.sourceImg = htmlImg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"get": function(x, y, w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!arguments.length) return p.get(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) return p.get(x, y, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 4) return p.get(x, y, w, h, this)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"set": function(x, y, c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.set(x, y, c, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.__isDirty = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>blend: function(srcImg, x, y, width, height, dx, dy, dwidth, dheight, MODE) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 9) p.blend(this, srcImg, x, y, width, height, dx, dy, dwidth, dheight, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 10) p.blend(srcImg, x, y, width, height, dx, dy, dwidth, dheight, MODE, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>delete this.sourceImg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>copy: function(srcImg, sx, sy, swidth, sheight, dx, dy, dwidth, dheight) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 8) p.blend(this, srcImg, sx, sy, swidth, sheight, dx, dy, dwidth, 0, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 9) p.blend(srcImg, sx, sy, swidth, sheight, dx, dy, dwidth, dheight, 0, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>delete this.sourceImg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>filter: function(mode, param) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (arguments.length === 2) p.filter(mode, param, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (arguments.length === 1) p.filter(mode, null, this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>delete this.sourceImg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>save: function(file) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.save(file, this)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>resize: function(w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.isRemote) throw "Image is loaded remotely. Cannot resize.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.width !== 0 || this.height !== 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (w === 0 &amp;&amp; h !== 0) w = Math.floor(this.width / this.height * h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (h === 0 &amp;&amp; w !== 0) h = Math.floor(this.height / this.width * w);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var canvas = getCanvasData(this.imageData).canvas;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var imageData = getCanvasData(canvas, w, h).context.getImageData(0, 0, w, h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.fromImageData(imageData)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>mask: function(mask) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var obj = this.toImageData(),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>i, size;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (mask instanceof PImage || mask.__isPImage) if (mask.width === this.width &amp;&amp; mask.height === this.height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>mask = mask.toImageData();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 2, size = this.width * this.height * 4; i &lt; size; i += 4) obj.data[i + 1] = mask.data[i]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else throw "mask must have the same dimensions as PImage.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (mask instanceof</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>Array) if (this.width * this.height === mask.length) for (i = 0, size = mask.length; i &lt; size; ++i) obj.data[i * 4 + 3] = mask[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else throw "mask array must be the same length as PImage pixels array.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.fromImageData(obj)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>loadPixels: nop,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>toImageData: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.isRemote) return this.sourceImg;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!this.__isDirty) return this.imageData;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var canvasData = getCanvasData(this.sourceImg);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return canvasData.context.getImageData(0, 0, this.width, this.height)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>toDataURL: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.isRemote) throw "Image is loaded remotely. Cannot create dataURI.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var canvasData = getCanvasData(this.imageData);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return canvasData.canvas.toDataURL()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fromImageData: function(canvasImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var w = canvasImg.width,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>h = canvasImg.height,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>canvas = document.createElement("canvas"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>ctx = canvas.getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.width = canvas.width = w;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.height = canvas.height = h;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ctx.putImageData(canvasImg, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.format = 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.imageData = canvasImg;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.sourceImg = canvas</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.PImage = PImage;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.createImage = function(w, h, mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new PImage(w, h, mode)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadImage = function(file, type, callback) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (type) file = file + "." + type;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pimg;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curSketch.imageCache.images[file]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pimg = new PImage(curSketch.imageCache.images[file]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pimg.loaded = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return pimg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pimg = new PImage;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var img = document.createElement("img");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pimg.sourceImg = img;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>img.onload = function(aImage, aPImage, aCallback) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var image = aImage;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var pimg = aPImage;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var callback = aCallback;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pimg.fromHTMLImageData(image);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pimg.loaded = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (callback) callback()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}(img, pimg, callback);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>img.src = file;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return pimg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.requestImage = p.loadImage;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function get$2(x, y) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (x &gt;= p.width || x &lt; 0 || y &lt; 0 || y &gt;= p.height) return 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (isContextReplaced) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var offset = ((0 | x) + p.width * (0 | y)) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data = p.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return (data[offset + 3] &amp; 255) &lt;&lt; 24 | (data[offset] &amp; 255) &lt;&lt; 16 | (data[offset + 1] &amp; 255) &lt;&lt; 8 | data[offset + 2] &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>data = p.toImageData(0 | x, 0 | y, 1, 1).data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (data[3] &amp; 255) &lt;&lt; 24 | (data[0] &amp; 255) &lt;&lt; 16 | (data[1] &amp; 255) &lt;&lt; 8 | data[2] &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function get$3(x, y, img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img.isRemote) throw "Image is loaded remotely. Cannot get x,y.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var offset = y * img.width * 4 + x * 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data = img.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return (data[offset + 3] &amp; 255) &lt;&lt; 24 | (data[offset] &amp; 255) &lt;&lt; 16 | (data[offset + 1] &amp; 255) &lt;&lt; 8 | data[offset + 2] &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function get$4(x, y, w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c = new PImage(w, h, 2);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>c.fromImageData(p.toImageData(x, y, w, h));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return c</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function get$5(x, y, w, h, img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img.isRemote) throw "Image is loaded remotely. Cannot get x,y,w,h.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c = new PImage(w, h, 2),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cData = c.imageData.data,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>imgWidth = img.width,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>imgHeight = img.height,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>imgData = img.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var startRow = Math.max(0, -y),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>startColumn = Math.max(0, -x),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>stopRow = Math.min(h, imgHeight - y),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>stopColumn = Math.min(w, imgWidth - x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = startRow; i &lt; stopRow; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var sourceOffset = ((y + i) * imgWidth + (x + startColumn)) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var targetOffset = (i * w + startColumn) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = startColumn; j &lt; stopColumn; ++j) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cData[targetOffset++] = imgData[sourceOffset++];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cData[targetOffset++] = imgData[sourceOffset++];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cData[targetOffset++] = imgData[sourceOffset++];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cData[targetOffset++] = imgData[sourceOffset++]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>c.__isDirty = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return c</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.get = function(x, y, w, h, img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img !== undefined) return get$5(x, y, w, h, img);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (h !== undefined) return get$4(x, y, w, h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (w !== undefined) return get$3(x, y, w);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (y !== undefined) return get$2(x, y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (x !== undefined) return get$5(0, 0, x.width, x.height, x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return get$4(0, 0, p.width, p.height)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.createGraphics = function(w, h, render) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pg = new Processing;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pg.size(w, h, render);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pg.background(0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return pg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function resetContext() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (isContextReplaced) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext = originalContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>isContextReplaced = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.updatePixels()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function SetPixelContextWrapper() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function wrapFunction(newContext, name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function wrapper() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resetContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext[name].apply(curContext, arguments)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>newContext[name] = wrapper</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function wrapProperty(newContext, name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function getter() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resetContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return curContext[name]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>function setter(value) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resetContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext[name] = value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.defineProperty(newContext, name, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>get: getter,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>set: setter</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var n in curContext) if (typeof curContext[n] === "function") wrapFunction(this, n);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else wrapProperty(this, n)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function replaceContext() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (isContextReplaced) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.loadPixels();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (proxyContext === null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>originalContext = curContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>proxyContext = new SetPixelContextWrapper</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>isContextReplaced = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext = proxyContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setPixelsCached = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function set$3(x, y, c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (x &lt; p.width &amp;&amp; x &gt;= 0 &amp;&amp; y &gt;= 0 &amp;&amp; y &lt; p.height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>replaceContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.pixels.setPixel((0 | x) + p.width * (0 | y), c);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (++setPixelsCached &gt; maxPixelsCached) resetContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function set$4(x, y, obj, img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img.isRemote) throw "Image is loaded remotely. Cannot set x,y.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c = p.color.toArray(obj);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var offset = y * img.width * 4 + x * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var data = img.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>data[offset] = c[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>data[offset + 1] = c[1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>data[offset + 2] = c[2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>data[offset + 3] = c[3]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.set = function(x, y, obj, img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var color, oldFill;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 3) if (typeof obj === "number") set$3(x, y, obj);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (obj instanceof PImage || obj.__isPImage) p.image(obj, x, y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (arguments.length === 4) set$4(x, y, obj, img)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.imageData = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.pixels = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getLength: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return p.imageData.data.length ? p.imageData.data.length / 4 : 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>getPixel: function(i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var offset = i * 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data = p.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return data[offset + 3] &lt;&lt; 24 &amp; 4278190080 | data[offset + 0] &lt;&lt; 16 &amp; 16711680 | data[offset + 1] &lt;&lt; 8 &amp; 65280 | data[offset + 2] &amp; 255</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setPixel: function(i, c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var offset = i * 4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data = p.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data[offset + 0] = (c &amp; 16711680) &gt;&gt;&gt; 16;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data[offset + 1] = (c &amp; 65280) &gt;&gt;&gt; 8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data[offset + 2] = c &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data[offset + 3] = (c &amp; 4278190080) &gt;&gt;&gt; 24</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>toArray: function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arr = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>length = p.imageData.width * p.imageData.height,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data = p.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, offset = 0; i &lt; length; i++, offset += 4) arr.push(data[offset + 3] &lt;&lt; 24 &amp; 4278190080 | data[offset + 0] &lt;&lt; 16 &amp; 16711680 | data[offset + 1] &lt;&lt; 8 &amp; 65280 | data[offset + 2] &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return arr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>set: function(arr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, aL = arr.length; i &lt; aL; i++) this.setPixel(i, arr[i])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadPixels = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.imageData = drawing.$ensureContext().getImageData(0, 0, p.width, p.height)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.updatePixels = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (p.imageData) drawing.$ensureContext().putImageData(p.imageData, 0, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.hint = function(which) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var curContext = drawing.$ensureContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (which === 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.disable(curContext.DEPTH_TEST);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.depthMask(false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.clear(curContext.DEPTH_BUFFER_BIT)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (which === -4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.enable(curContext.DEPTH_TEST);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.depthMask(true)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (which === -1 || which === 2) renderSmooth = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (which === 1) renderSmooth = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var backgroundHelper = function(arg1, arg2, arg3, arg4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var obj;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arg1 instanceof PImage || arg1.__isPImage) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>obj = arg1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!obj.loaded) throw "Error using image in background(): PImage not loaded.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (obj.width !== p.width || obj.height !== p.height) throw "Background image must be the same dimensions as the canvas.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else obj = p.color(arg1, arg2, arg3, arg4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>backgroundObj = obj</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.background = function(arg1, arg2, arg3, arg4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arg1 !== undef) backgroundHelper(arg1, arg2, arg3, arg4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (backgroundObj instanceof PImage || backgroundObj.__isPImage) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>saveContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.setTransform(1, 0, 0, 1, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.image(backgroundObj, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>restoreContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>saveContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.setTransform(1, 0, 0, 1, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (p.alpha(backgroundObj) !== colorModeA) curContext.clearRect(0, 0, p.width, p.height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.fillStyle = p.color.toString(backgroundObj);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.fillRect(0, 0, p.width, p.height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>isFillDirty = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>restoreContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.background = function(arg1, arg2, arg3, arg4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length &gt; 0) backgroundHelper(arg1, arg2, arg3, arg4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c = p.color.toGLArray(backgroundObj);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.clearColor(c[0], c[1], c[2], c[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.clear(curContext.COLOR_BUFFER_BIT | curContext.DEPTH_BUFFER_BIT)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.image = function(img, x, y, w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>x = Math.round(x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>y = Math.round(y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img.width &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var wid = w || img.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var hgt = h || img.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var bounds = imageModeConvert(x || 0, y || 0, w || img.width, h || img.height, arguments.length &lt; 4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fastImage = !!img.sourceImg &amp;&amp; curTint === null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (fastImage) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var htmlElement = img.sourceImg;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (img.__isDirty) img.updatePixels();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.drawImage(htmlElement, 0, 0, htmlElement.width, htmlElement.height, bounds.x, bounds.y, bounds.w, bounds.h)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var obj = img.toImageData();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (curTint !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curTint(obj);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>img.__isDirty = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.drawImage(getCanvasData(obj).canvas, 0, 0, img.width, img.height, bounds.x, bounds.y, bounds.w, bounds.h)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.image = function(img, x, y, w, h) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img.width &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x = Math.round(x);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y = Math.round(y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>w = w || img.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>h = h || img.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.beginShape(p.QUADS);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.texture(img);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(x, y, 0, 0, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(x, y + h, 0, 0, h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(x + w, y + h, 0, w, h);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.vertex(x + w, y, 0, w, 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.endShape()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.tint = function(a1, a2, a3, a4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tintColor = p.color(a1, a2, a3, a4);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var r = p.red(tintColor) / colorModeX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var g = p.green(tintColor) / colorModeY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var b = p.blue(tintColor) / colorModeZ;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var a = p.alpha(tintColor) / colorModeA;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTint = function(obj) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var data = obj.data,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>length = 4 * obj.width * obj.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; length;) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] *= r;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] *= g;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] *= b;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] *= a</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTint3d = function(data) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; data.length;) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] = r;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] = g;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] = b;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>data[i++] = a</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.noTint = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTint = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTint3d = null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.copy = function(src, sx, sy, sw, sh, dx, dy, dw, dh) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (dh === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dh = dw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dw = dy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dy = dx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dx = sh;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sh = sw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sw = sy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sy = sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sx = src;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>src = p</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.blend(src, sx, sy, sw, sh, dx, dy, dw, dh, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.blend = function(src, sx, sy, sw, sh, dx, dy, dw, dh, mode, pimgdest) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (src.isRemote) throw "Image is loaded remotely. Cannot blend image.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mode === undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>mode = dh;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dh = dw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dw = dy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dy = dx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dx = sh;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sh = sw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sw = sy;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sy = sx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sx = src;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>src = p</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sx2 = sx + sw,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sy2 = sy + sh,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dx2 = dx + dw,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dy2 = dy + dh,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dest = pimgdest || p;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (pimgdest === undef || mode === undef) p.loadPixels();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>src.loadPixels();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (src === p &amp;&amp; p.intersect(sx, sy, sx2, sy2, dx, dy, dx2, dy2)) p.blit_resize(p.get(sx, sy, sx2 - sx, sy2 - sy), 0, 0, sx2 - sx - 1, sy2 - sy - 1, dest.imageData.data, dest.width, dest.height, dx, dy, dx2, dy2, mode);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else p.blit_resize(src, sx, sy, sx2, sy2, dest.imageData.data, dest.width, dest.height, dx, dy, dx2, dy2, mode);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (pimgdest === undef) p.updatePixels()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var buildBlurKernel = function(r) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var radius = p.floor(r * 3.5),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>i, radiusi;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>radius = radius &lt; 1 ? 1 : radius &lt; 248 ? radius : 248;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (p.shared.blurRadius !== radius) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.shared.blurRadius = radius;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.shared.blurKernelSize = 1 + (p.shared.blurRadius &lt;&lt; 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.shared.blurKernel = new Float32Array(p.shared.blurKernelSize);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var sharedBlurKernal = p.shared.blurKernel;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var sharedBlurKernelSize = p.shared.blurKernelSize;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var sharedBlurRadius = p.shared.blurRadius;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; sharedBlurKernelSize; i++) sharedBlurKernal[i] = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var radiusiSquared = (radius - 1) * (radius - 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 1; i &lt; radius; i++) sharedBlurKernal[radius + i] = sharedBlurKernal[radiusi] = radiusiSquared;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>sharedBlurKernal[radius] = radius * radius</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var blurARGB = function(r, aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sum, cr, cg, cb, ca, c, m;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var read, ri, ym, ymi, bk0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var wh = aImg.pixels.getLength();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var r2 = new Float32Array(wh);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var g2 = new Float32Array(wh);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var b2 = new Float32Array(wh);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var a2 = new Float32Array(wh);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var yi = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var x, y, i, offset;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>buildBlurKernel(r);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aImgHeight = aImg.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aImgWidth = aImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sharedBlurKernelSize = p.shared.blurKernelSize;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sharedBlurRadius = p.shared.blurRadius;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sharedBlurKernal = p.shared.blurKernel;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pix = aImg.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (y = 0; y &lt; aImgHeight; y++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (x = 0; x &lt; aImgWidth; x++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cb = cg = cr = ca = sum = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>read = x - sharedBlurRadius;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (read &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bk0 = -read;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>read = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (read &gt;= aImgWidth) break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bk0 = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = bk0; i &lt; sharedBlurKernelSize; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (read &gt;= aImgWidth) break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>offset = (read + yi) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>m = sharedBlurKernal[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ca += m * pix[offset + 3];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr += m * pix[offset];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg += m * pix[offset + 1];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb += m * pix[offset + 2];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>sum += m;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>read++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>ri = yi + x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>a2[ri] = ca / sum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>r2[ri] = cr / sum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>g2[ri] = cg / sum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>b2[ri] = cb / sum</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yi += aImgWidth</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>yi = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ym = -sharedBlurRadius;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ymi = ym * aImgWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (y = 0; y &lt; aImgHeight; y++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (x = 0; x &lt; aImgWidth; x++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cb = cg = cr = ca = sum = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (ym &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bk0 = ri = -ym;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>read = x</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (ym &gt;= aImgHeight) break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>bk0 = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ri = ym;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>read = x + ymi</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = bk0; i &lt; sharedBlurKernelSize; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (ri &gt;= aImgHeight) break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>m = sharedBlurKernal[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ca += m * a2[read];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cr += m * r2[read];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cg += m * g2[read];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cb += m * b2[read];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>sum += m;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ri++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>read += aImgWidth</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>offset = (x + yi) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pix[offset] = cr / sum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pix[offset + 1] = cg / sum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pix[offset + 2] = cb / sum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pix[offset + 3] = ca / sum</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yi += aImgWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ymi += aImgWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ym++</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var dilate = function(isInverted, aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var currIdx = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var maxIdx = aImg.pixels.getLength();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var out = new Int32Array(maxIdx);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var currRowIdx, maxRowIdx, colOrig, colOut, currLum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var idxRight, idxLeft, idxUp, idxDown, colRight, colLeft, colUp, colDown, lumRight, lumLeft, lumUp, lumDown;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!isInverted) while (currIdx &lt; maxIdx) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currRowIdx = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>maxRowIdx = currIdx + aImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (currIdx &lt; maxRowIdx) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colOrig = colOut = aImg.pixels.getPixel(currIdx);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxLeft = currIdx - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxRight = currIdx + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxUp = currIdx - aImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxDown = currIdx + aImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxLeft &lt; currRowIdx) idxLeft = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxRight &gt;= maxRowIdx) idxRight = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxUp &lt; 0) idxUp = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxDown &gt;= maxIdx) idxDown = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colUp = aImg.pixels.getPixel(idxUp);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colLeft = aImg.pixels.getPixel(idxLeft);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colDown = aImg.pixels.getPixel(idxDown);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colRight = aImg.pixels.getPixel(idxRight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>currLum = 77 * (colOrig &gt;&gt; 16 &amp; 255) + 151 * (colOrig &gt;&gt; 8 &amp; 255) + 28 * (colOrig &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumLeft = 77 * (colLeft &gt;&gt; 16 &amp; 255) + 151 * (colLeft &gt;&gt; 8 &amp; 255) + 28 * (colLeft &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumRight = 77 * (colRight &gt;&gt; 16 &amp; 255) + 151 * (colRight &gt;&gt; 8 &amp; 255) + 28 * (colRight &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumUp = 77 * (colUp &gt;&gt; 16 &amp; 255) + 151 * (colUp &gt;&gt; 8 &amp; 255) + 28 * (colUp &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumDown = 77 * (colDown &gt;&gt; 16 &amp; 255) + 151 * (colDown &gt;&gt; 8 &amp; 255) + 28 * (colDown &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumLeft &gt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colLeft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumLeft</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumRight &gt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colRight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumRight</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumUp &gt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colUp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumUp</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumDown &gt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colDown;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumDown</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>out[currIdx++] = colOut</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else while (currIdx &lt; maxIdx) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currRowIdx = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>maxRowIdx = currIdx + aImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (currIdx &lt; maxRowIdx) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colOrig = colOut = aImg.pixels.getPixel(currIdx);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxLeft = currIdx - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxRight = currIdx + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxUp = currIdx - aImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idxDown = currIdx + aImg.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxLeft &lt; currRowIdx) idxLeft = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxRight &gt;= maxRowIdx) idxRight = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxUp &lt; 0) idxUp = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (idxDown &gt;= maxIdx) idxDown = currIdx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colUp = aImg.pixels.getPixel(idxUp);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colLeft = aImg.pixels.getPixel(idxLeft);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colDown = aImg.pixels.getPixel(idxDown);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>colRight = aImg.pixels.getPixel(idxRight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>currLum = 77 * (colOrig &gt;&gt; 16 &amp; 255) + 151 * (colOrig &gt;&gt; 8 &amp; 255) + 28 * (colOrig &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumLeft = 77 * (colLeft &gt;&gt; 16 &amp; 255) + 151 * (colLeft &gt;&gt; 8 &amp; 255) + 28 * (colLeft &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumRight = 77 * (colRight &gt;&gt; 16 &amp; 255) + 151 * (colRight &gt;&gt; 8 &amp; 255) + 28 * (colRight &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumUp = 77 * (colUp &gt;&gt; 16 &amp; 255) + 151 * (colUp &gt;&gt; 8 &amp; 255) + 28 * (colUp &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lumDown = 77 * (colDown &gt;&gt; 16 &amp; 255) + 151 * (colDown &gt;&gt; 8 &amp; 255) + 28 * (colDown &amp; 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumLeft &lt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colLeft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumLeft</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumRight &lt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colRight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumRight</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumUp &lt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colUp;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumUp</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (lumDown &lt; currLum) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>colOut = colDown;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>currLum = lumDown</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>out[currIdx++] = colOut</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>aImg.pixels.set(out)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.filter = function(kind, param, aImg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var img, col, lum, i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>aImg.loadPixels();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>img = aImg</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.loadPixels();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>img = p</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (param === undef) param = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (img.isRemote) throw "Image is loaded remotely. Cannot filter image.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var imglen = img.pixels.getLength();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>switch (kind) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 11:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var radius = param || 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>blurARGB(radius, img);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 12:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (img.format === 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0; i &lt; imglen; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>col = 255 - img.pixels.getPixel(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>img.pixels.setPixel(i, 4278190080 | col &lt;&lt; 16 | col &lt;&lt; 8 | col)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>img.format = 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else for (i = 0; i &lt; imglen; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>col = img.pixels.getPixel(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lum = 77 * (col &gt;&gt; 16 &amp; 255) + 151 * (col &gt;&gt; 8 &amp; 255) + 28 * (col &amp; 255) &gt;&gt; 8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>img.pixels.setPixel(i, col &amp; 4278190080 | lum &lt;&lt; 16 | lum &lt;&lt; 8 | lum)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 13:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; imglen; i++) img.pixels.setPixel(i, img.pixels.getPixel(i) ^ 16777215);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 15:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (param === null) throw "Use filter(POSTERIZE, int levels) instead of filter(POSTERIZE)";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var levels = p.floor(param);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (levels &lt; 2 || levels &gt; 255) throw "Levels must be between 2 and 255 for filter(POSTERIZE, levels)";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var levels1 = levels - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; imglen; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var rlevel = img.pixels.getPixel(i) &gt;&gt; 16 &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var glevel = img.pixels.getPixel(i) &gt;&gt; 8 &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var blevel = img.pixels.getPixel(i) &amp; 255;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>rlevel = (rlevel * levels &gt;&gt; 8) * 255 / levels1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>glevel = (glevel * levels &gt;&gt; 8) * 255 / levels1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>blevel = (blevel * levels &gt;&gt; 8) * 255 / levels1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>img.pixels.setPixel(i, 4278190080 &amp; img.pixels.getPixel(i) | rlevel &lt;&lt; 16 | glevel &lt;&lt; 8 | blevel)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 14:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; imglen; i++) img.pixels.setPixel(i, img.pixels.getPixel(i) | 4278190080);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>img.format = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 16:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (param === null) param = 0.5;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (param &lt; 0 || param &gt; 1) throw "Level must be between 0 and 1 for filter(THRESHOLD, level)";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var thresh = p.floor(param * 255);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0; i &lt; imglen; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var max = p.max((img.pixels.getPixel(i) &amp; 16711680) &gt;&gt; 16, p.max((img.pixels.getPixel(i) &amp; 65280) &gt;&gt; 8, img.pixels.getPixel(i) &amp; 255));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>img.pixels.setPixel(i, img.pixels.getPixel(i) &amp; 4278190080 | (max &lt; thresh ? 0 : 16777215))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 17:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dilate(true, img);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 18:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dilate(false, img);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>img.updatePixels()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.shared = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fracU: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ifU: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>fracV: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ifV: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>u1: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>u2: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>v1: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>v2: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sX: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sY: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>iw: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>iw1: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ih1: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ul: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ll: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ur: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lr: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cUL: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cLL: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cUR: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cLR: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>srcXOffset: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>srcYOffset: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>r: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>g: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>b: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>a: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>srcBuffer: null,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>blurRadius: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>blurKernelSize: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>blurKernel: null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.intersect = function(sx1, sy1, sx2, sy2, dx1, dy1, dx2, dy2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sw = sx2 - sx1 + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var sh = sy2 - sy1 + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var dw = dx2 - dx1 + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var dh = dy2 - dy1 + 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (dx1 &lt; sx1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dw += dx1 - sx1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (dw &gt; sw) dw = sw</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var w = sw + sx1 - dx1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (dw &gt; w) dw = w</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (dy1 &lt; sy1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dh += dy1 - sy1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (dh &gt; sh) dh = sh</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var h = sh + sy1 - dy1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (dh &gt; h) dh = h</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ! (dw &lt;= 0 || dh &lt;= 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var blendFuncs = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[1] = p.modes.blend;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[2] = p.modes.add;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[4] = p.modes.subtract;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[8] = p.modes.lightest;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[16] = p.modes.darkest;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[0] = p.modes.replace;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[32] = p.modes.difference;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[64] = p.modes.exclusion;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[128] = p.modes.multiply;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[256] = p.modes.screen;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[512] = p.modes.overlay;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[1024] = p.modes.hard_light;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[2048] = p.modes.soft_light;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[4096] = p.modes.dodge;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>blendFuncs[8192] = p.modes.burn;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.blit_resize = function(img, srcX1, srcY1, srcX2, srcY2, destPixels, screenW, screenH, destX1, destY1, destX2, destY2, mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var x, y;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (srcX1 &lt; 0) srcX1 = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (srcY1 &lt; 0) srcY1 = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (srcX2 &gt;= img.width) srcX2 = img.width - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (srcY2 &gt;= img.height) srcY2 = img.height - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var srcW = srcX2 - srcX1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var srcH = srcY2 - srcY1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var destW = destX2 - destX1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var destH = destY2 - destY1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (destW &lt;= 0 || destH &lt;= 0 || srcW &lt;= 0 || srcH &lt;= 0 || destX1 &gt;= screenW || destY1 &gt;= screenH || srcX1 &gt;= img.width || srcY1 &gt;= img.height) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var dx = Math.floor(srcW / destW * 32768);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var dy = Math.floor(srcH / destH * 32768);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var pshared = p.shared;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pshared.srcXOffset = Math.floor(destX1 &lt; 0 ? -destX1 * dx : srcX1 * 32768);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pshared.srcYOffset = Math.floor(destY1 &lt; 0 ? -destY1 * dy : srcY1 * 32768);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (destX1 &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>destW += destX1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>destX1 = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (destY1 &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>destH += destY1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>destY1 = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>destW = Math.min(destW, screenW - destX1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>destH = Math.min(destH, screenH - destY1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var destOffset = destY1 * screenW + destX1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var destColor;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pshared.srcBuffer = img.imageData.data;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pshared.iw = img.width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pshared.iw1 = img.width - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pshared.ih1 = img.height - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var filterBilinear = p.filter_bilinear,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>filterNewScanline = p.filter_new_scanline,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>blendFunc = blendFuncs[mode],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>blendedColor, idx, cULoffset, cURoffset, cLLoffset, cLRoffset, ALPHA_MASK = 4278190080,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>RED_MASK = 16711680,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>GREEN_MASK = 65280,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>BLUE_MASK = 255,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PREC_MAXVAL = 32767,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PRECISIONB = 15,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PREC_RED_SHIFT = 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>PREC_ALPHA_SHIFT = 9,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>srcBuffer = pshared.srcBuffer,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>min = Math.min;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (y = 0; y &lt; destH; y++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pshared.sX = pshared.srcXOffset;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pshared.fracV = pshared.srcYOffset &amp; PREC_MAXVAL;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pshared.ifV = PREC_MAXVAL - pshared.fracV;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pshared.v1 = (pshared.srcYOffset &gt;&gt; PRECISIONB) * pshared.iw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pshared.v2 = min((pshared.srcYOffset &gt;&gt; PRECISIONB) + 1, pshared.ih1) * pshared.iw;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (x = 0; x &lt; destW; x++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>idx = (destOffset + x) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>destColor = destPixels[idx + 3] &lt;&lt; 24 &amp; ALPHA_MASK | destPixels[idx] &lt;&lt; 16 &amp; RED_MASK | destPixels[idx + 1] &lt;&lt; 8 &amp; GREEN_MASK | destPixels[idx + 2] &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.fracU = pshared.sX &amp; PREC_MAXVAL;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.ifU = PREC_MAXVAL - pshared.fracU;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.ul = pshared.ifU * pshared.ifV &gt;&gt; PRECISIONB;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.ll = pshared.ifU * pshared.fracV &gt;&gt; PRECISIONB;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.ur = pshared.fracU * pshared.ifV &gt;&gt; PRECISIONB;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.lr = pshared.fracU * pshared.fracV &gt;&gt; PRECISIONB;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.u1 = pshared.sX &gt;&gt; PRECISIONB;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.u2 = min(pshared.u1 + 1, pshared.iw1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cULoffset = (pshared.v1 + pshared.u1) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cURoffset = (pshared.v1 + pshared.u2) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cLLoffset = (pshared.v2 + pshared.u1) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>cLRoffset = (pshared.v2 + pshared.u2) * 4;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.cUL = srcBuffer[cULoffset + 3] &lt;&lt; 24 &amp; ALPHA_MASK | srcBuffer[cULoffset] &lt;&lt; 16 &amp; RED_MASK | srcBuffer[cULoffset + 1] &lt;&lt; 8 &amp; GREEN_MASK | srcBuffer[cULoffset + 2] &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.cUR = srcBuffer[cURoffset + 3] &lt;&lt; 24 &amp; ALPHA_MASK | srcBuffer[cURoffset] &lt;&lt; 16 &amp; RED_MASK | srcBuffer[cURoffset + 1] &lt;&lt; 8 &amp; GREEN_MASK | srcBuffer[cURoffset + 2] &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.cLL = srcBuffer[cLLoffset + 3] &lt;&lt; 24 &amp; ALPHA_MASK | srcBuffer[cLLoffset] &lt;&lt; 16 &amp; RED_MASK | srcBuffer[cLLoffset + 1] &lt;&lt; 8 &amp; GREEN_MASK | srcBuffer[cLLoffset + 2] &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.cLR = srcBuffer[cLRoffset + 3] &lt;&lt; 24 &amp; ALPHA_MASK | srcBuffer[cLRoffset] &lt;&lt; 16 &amp; RED_MASK | srcBuffer[cLRoffset + 1] &lt;&lt; 8 &amp; GREEN_MASK | srcBuffer[cLRoffset + 2] &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.r = pshared.ul * ((pshared.cUL &amp; RED_MASK) &gt;&gt; 16) + pshared.ll * ((pshared.cLL &amp; RED_MASK) &gt;&gt; 16) + pshared.ur * ((pshared.cUR &amp; RED_MASK) &gt;&gt; 16) + pshared.lr * ((pshared.cLR &amp; RED_MASK) &gt;&gt; 16) &lt;&lt; PREC_RED_SHIFT &amp; RED_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.g = pshared.ul * (pshared.cUL &amp; GREEN_MASK) + pshared.ll * (pshared.cLL &amp; GREEN_MASK) + pshared.ur * (pshared.cUR &amp; GREEN_MASK) + pshared.lr * (pshared.cLR &amp; GREEN_MASK) &gt;&gt;&gt; PRECISIONB &amp; GREEN_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.b = pshared.ul * (pshared.cUL &amp; BLUE_MASK) + pshared.ll * (pshared.cLL &amp; BLUE_MASK) + pshared.ur * (pshared.cUR &amp; BLUE_MASK) + pshared.lr * (pshared.cLR &amp; BLUE_MASK) &gt;&gt;&gt; PRECISIONB;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.a = pshared.ul * ((pshared.cUL &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + pshared.ll * ((pshared.cLL &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + pshared.ur * ((pshared.cUR &amp; ALPHA_MASK) &gt;&gt;&gt; 24) + pshared.lr * ((pshared.cLR &amp; ALPHA_MASK) &gt;&gt;&gt; 24) &lt;&lt; PREC_ALPHA_SHIFT &amp; ALPHA_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>blendedColor = blendFunc(destColor, pshared.a | pshared.r | pshared.g | pshared.b);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>destPixels[idx] = (blendedColor &amp; RED_MASK) &gt;&gt;&gt; 16;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>destPixels[idx + 1] = (blendedColor &amp; GREEN_MASK) &gt;&gt;&gt; 8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>destPixels[idx + 2] = blendedColor &amp; BLUE_MASK;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>destPixels[idx + 3] = (blendedColor &amp; ALPHA_MASK) &gt;&gt;&gt; 24;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>pshared.sX += dx</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>destOffset += screenW;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>pshared.srcYOffset += dy</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadFont = function(name, size) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (name === undef) throw "font name required in loadFont.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (name.indexOf(".svg") === -1) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (size === undef) size = curTextFont.size;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return PFont.get(name, size)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var font = p.loadGlyphs(name);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>name: name,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>css: "12px sans-serif",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>glyph: true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>units_per_em: font.units_per_em,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>horiz_adv_x: 1 / font.units_per_em * font.horiz_adv_x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ascent: font.ascent,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>descent: font.descent,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width: function(str) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var width = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var len = str.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (var i = 0; i &lt; len; i++) try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>width += parseFloat(p.glyphLook(p.glyphTable[name], str[i]).horiz_adv_x)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} catch(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>Processing.debug(e)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return width / p.glyphTable[name].units_per_em</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.createFont = function(name, size) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return p.loadFont(name, size)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textFont = function(pfont, size) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (size !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!pfont.glyph) pfont = PFont.get(pfont.name, size);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curTextSize = size</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextFont = pfont;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curFontName = curTextFont.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextAscent = curTextFont.ascent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextDescent = curTextFont.descent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextLeading = curTextFont.leading;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var curContext = drawing.$ensureContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.font = curTextFont.css</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textSize = function(size) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextFont = PFont.get(curFontName, size);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextSize = size;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextAscent = curTextFont.ascent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextDescent = curTextFont.descent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextLeading = curTextFont.leading;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var curContext = drawing.$ensureContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.font = curTextFont.css</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textAscent = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return curTextAscent</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textDescent = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return curTextDescent</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textLeading = function(leading) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curTextLeading = leading</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textAlign = function(xalign, yalign) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>horizontalTextAlignment = xalign;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>verticalTextAlignment = yalign || 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function toP5String(obj) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (obj instanceof String) return obj;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof obj === "number") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (obj === (0 | obj)) return obj.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return p.nf(obj, 0, 3)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (obj === null || obj === undef) return "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return obj.toString()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.textWidth = function(str) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lines = toP5String(str).split(/\r?\n/g),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, linesCount = lines.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.font = curTextFont.css;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; linesCount; ++i) width = Math.max(width, curTextFont.measureTextWidth(lines[i]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return width | 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.textWidth = function(str) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lines = toP5String(str).split(/\r?\n/g),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, linesCount = lines.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (textcanvas === undef) textcanvas = document.createElement("canvas");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var textContext = textcanvas.getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>textContext.font = curTextFont.css;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; linesCount; ++i) width = Math.max(width, textContext.measureText(lines[i]).width);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return width | 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.glyphLook = function(font, chr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>switch (chr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "1":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.one;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "2":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.two;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "3":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.three;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "4":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.four;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "5":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.five;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "6":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.six;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "7":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.seven;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "8":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.eight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "9":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.nine;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "0":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.zero;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case " ":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.space;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "$":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.dollar;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "!":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.exclam;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case '"':</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.quotedbl;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "#":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.numbersign;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "%":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.percent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "&amp;":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.ampersand;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "'":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.quotesingle;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "(":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.parenleft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case ")":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.parenright;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "*":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.asterisk;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "+":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.plus;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case ",":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.comma;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "-":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.hyphen;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case ".":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.period;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "/":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.slash;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "_":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.underscore;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case ":":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.colon;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case ";":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.semicolon;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "&lt;":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.less;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "=":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.equal;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "&gt;":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.greater;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "?":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.question;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "@":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.at;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "[":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.bracketleft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "\\":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.backslash;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "]":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.bracketright;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "^":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.asciicircum;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "`":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.grave;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "{":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.braceleft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "|":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.bar;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "}":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.braceright;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>case "~":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font.asciitilde;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>default:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return font[chr]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} catch(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>Processing.debug(e)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.text$line = function(str, x, y, z, align) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var textWidth = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xOffset = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!curTextFont.glyph) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (str &amp;&amp; "fillText" in curContext) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (isFillDirty) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curContext.fillStyle = p.color.toString(currentFillColor);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>isFillDirty = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (align === 39 || align === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>textWidth = curTextFont.measureTextWidth(str);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (align === 39) xOffset = -textWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>else xOffset = -textWidth / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curContext.fillText(str, x + xOffset, y)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var font = p.glyphTable[curFontName];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>saveContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.translate(x, y + curTextSize);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (align === 39 || align === 3) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>textWidth = font.width(str);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (align === 39) xOffset = -textWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else xOffset = -textWidth / 2</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var upem = font.units_per_em,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>newScale = 1 / upem * curTextSize;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>curContext.scale(newScale, newScale);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, len = str.length; i &lt; len; i++) try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.glyphLook(font, str[i]).draw()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>Processing.debug(e)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>restoreContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.text$line = function(str, x, y, z, align) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (textcanvas === undef) textcanvas = document.createElement("canvas");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = curContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext = textcanvas.getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.font = curTextFont.css;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var textWidth = curTextFont.measureTextWidth(str);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>textcanvas.width = textWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>textcanvas.height = curTextSize;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext = textcanvas.getContext("2d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.font = curTextFont.css;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.textBaseline = "top";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>Drawing2D.prototype.text$line(str, 0, 0, 0, 37);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var aspect = textcanvas.width / textcanvas.height;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bindTexture(curContext.TEXTURE_2D, textTex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.texImage2D(curContext.TEXTURE_2D, 0, curContext.RGBA, curContext.RGBA, curContext.UNSIGNED_BYTE, textcanvas);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_MAG_FILTER, curContext.LINEAR);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_MIN_FILTER, curContext.LINEAR);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_WRAP_T, curContext.CLAMP_TO_EDGE);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.texParameteri(curContext.TEXTURE_2D, curContext.TEXTURE_WRAP_S, curContext.CLAMP_TO_EDGE);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var xOffset = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (align === 39) xOffset = -textWidth;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (align === 3) xOffset = -textWidth / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var model = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var scalefactor = curTextSize * 0.5;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.translate(x + xOffset - scalefactor / 2, y - scalefactor, z);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.scale(-aspect * scalefactor, -scalefactor, scalefactor);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.translate(-1, -1, -1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>model.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var view = new PMatrix3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.scale(1, -1, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.apply(modelView.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>view.transpose();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.useProgram(programObject2D);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("aVertex2d", programObject2D, "aVertex", 3, textBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>vertexAttribPointer("aTextureCoord2d", programObject2D, "aTextureCoord", 2, textureBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uSampler2d", programObject2D, "uSampler", [0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformi("uIsDrawingText2d", programObject2D, "uIsDrawingText", true);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uModel2d", programObject2D, "uModel", false, model.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformMatrix("uView2d", programObject2D, "uView", false, view.array());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>uniformf("uColor2d", programObject2D, "uColor", fillStyle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.bindBuffer(curContext.ELEMENT_ARRAY_BUFFER, indexBuffer);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.drawElements(curContext.TRIANGLES, 6, curContext.UNSIGNED_SHORT, 0)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function text$4(str, x, y, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lines, linesCount;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (str.indexOf("\n") &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lines = [str];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>linesCount = 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lines = str.split(/\r?\n/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>linesCount = lines.length</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var yOffset = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (verticalTextAlignment === 101) yOffset = curTextAscent + curTextDescent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (verticalTextAlignment === 3) yOffset = curTextAscent / 2 - (linesCount - 1) * curTextLeading / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (verticalTextAlignment === 102) yOffset = -(curTextDescent + (linesCount - 1) * curTextLeading);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; linesCount; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var line = lines[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>drawing.text$line(line, x, y + yOffset, z, horizontalTextAlignment);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yOffset += curTextLeading</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function text$6(str, x, y, width, height, z) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (str.length === 0 || width === 0 || height === 0) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curTextSize &gt; height) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var spaceMark = -1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var start = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lineWidth = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var drawCommands = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var charPos = 0, len = str.length; charPos &lt; len; charPos++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var currentChar = str[charPos];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var spaceChar = currentChar === " ";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var letterWidth = curTextFont.measureTextWidth(currentChar);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (currentChar !== "\n" &amp;&amp; lineWidth + letterWidth &lt;= width) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (spaceChar) spaceMark = charPos;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lineWidth += letterWidth</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (spaceMark + 1 === start) if (charPos &gt; 0) spaceMark = charPos;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (currentChar === "\n") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>drawCommands.push({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>text: str.substring(start, charPos),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>width: lineWidth</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>start = charPos + 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>drawCommands.push({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>text: str.substring(start, spaceMark + 1),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>width: lineWidth</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>start = spaceMark + 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lineWidth = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>charPos = start - 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (start &lt; len) drawCommands.push({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>text: str.substring(start),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width: lineWidth</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var xOffset = 1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yOffset = curTextAscent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (horizontalTextAlignment === 3) xOffset = width / 2;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (horizontalTextAlignment === 39) xOffset = width;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var linesCount = drawCommands.length,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>visibleLines = Math.min(linesCount, Math.floor(height / curTextLeading));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (verticalTextAlignment === 101) yOffset = curTextAscent + curTextDescent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (verticalTextAlignment === 3) yOffset = height / 2 - curTextLeading * (visibleLines / 2 - 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (verticalTextAlignment === 102) yOffset = curTextDescent + curTextLeading;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var command, drawCommand, leading;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (command = 0; command &lt; linesCount; command++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>leading = command * curTextLeading;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (yOffset + leading &gt; height - curTextDescent) break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>drawCommand = drawCommands[command];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>drawing.text$line(drawCommand.text, x + xOffset, y + yOffset + leading, z, horizontalTextAlignment)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.text = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (textMode === 5) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (arguments.length === 3) text$4(toP5String(arguments[0]), arguments[1], arguments[2], 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (arguments.length === 4) text$4(toP5String(arguments[0]), arguments[1], arguments[2], arguments[3]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (arguments.length === 5) text$6(toP5String(arguments[0]), arguments[1], arguments[2], arguments[3], arguments[4], 0);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (arguments.length === 6) text$6(toP5String(arguments[0]), arguments[1], arguments[2], arguments[3], arguments[4], arguments[5])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.textMode = function(mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>textMode = mode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.loadGlyphs = function(url) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var x, y, cx, cy, nx, ny, d, a, lastCom, lenC, horiz_adv_x, getXY = "[0-9\\-]+",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>path;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var regex = function(needle, hay) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>results = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>latest, regexp = new RegExp(needle, "g");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>latest = results[i] = regexp.exec(hay);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (latest) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>i++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>latest = results[i] = regexp.exec(hay)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return results</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var buildPath = function(d) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var c = regex("[A-Za-z][0-9\\- ]+|Z", d);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var beforePathDraw = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>saveContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return drawing.$ensureContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var afterPathDraw = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>executeContextFill();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>executeContextStroke();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>restoreContext()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>path = "return {draw:function(){var curContext=beforePathDraw();curContext.beginPath();";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>x = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>y = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cx = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cy = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>nx = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>ny = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>d = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>a = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lastCom = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lenC = c.length - 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = 0; j &lt; lenC; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var com = c[j][0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>xy = regex(getXY, com);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>switch (com[0]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>case "M":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>x = parseFloat(xy[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>y = parseFloat(xy[1][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path += "curContext.moveTo(" + x + "," + -y + ");";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>case "L":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>x = parseFloat(xy[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>y = parseFloat(xy[1][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path += "curContext.lineTo(" + x + "," + -y + ");";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>case "H":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>x = parseFloat(xy[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path += "curContext.lineTo(" + x + "," + -y + ");";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>case "V":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>y = parseFloat(xy[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path += "curContext.lineTo(" + x + "," + -y + ");";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>case "T":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>nx = parseFloat(xy[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ny = parseFloat(xy[1][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (lastCom === "Q" || lastCom === "T") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>d = Math.sqrt(Math.pow(x - cx, 2) + Math.pow(cy - y, 2));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>a = Math.PI + Math.atan2(cx - x, cy - y);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = x + Math.sin(a) * d;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = y + Math.cos(a) * d</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cx = x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>cy = y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path += "curContext.quadraticCurveTo(" + cx + "," + -cy + "," + nx + "," + -ny + ");";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>x = nx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>y = ny;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>case "Q":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cx = parseFloat(xy[0][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>cy = parseFloat(xy[1][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>nx = parseFloat(xy[2][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>ny = parseFloat(xy[3][0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path += "curContext.quadraticCurveTo(" + cx + "," + -cy + "," + nx + "," + -ny + ");";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>x = nx;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>y = ny;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>case "Z":</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path += "curContext.closePath();";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>lastCom = com[0]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>path += "afterPathDraw();";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>path += "curContext.translate(" + horiz_adv_x + ",0);";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>path += "}}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return (new Function("beforePathDraw", "afterPathDraw", path))(beforePathDraw, afterPathDraw)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var parseSVGFont = function(svg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var font = svg.getElementsByTagName("font");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.glyphTable[url].horiz_adv_x = font[0].getAttribute("horiz-adv-x");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var font_face = svg.getElementsByTagName("font-face")[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.glyphTable[url].units_per_em = parseFloat(font_face.getAttribute("units-per-em"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.glyphTable[url].ascent = parseFloat(font_face.getAttribute("ascent"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.glyphTable[url].descent = parseFloat(font_face.getAttribute("descent"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var glyph = svg.getElementsByTagName("glyph"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>len = glyph.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; len; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var unicode = glyph[i].getAttribute("unicode");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var name = glyph[i].getAttribute("glyph-name");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>horiz_adv_x = glyph[i].getAttribute("horiz-adv-x");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (horiz_adv_x === null) horiz_adv_x = p.glyphTable[url].horiz_adv_x;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>d = glyph[i].getAttribute("d");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (d !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>path = buildPath(d);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.glyphTable[url][name] = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>name: name,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>unicode: unicode,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>horiz_adv_x: horiz_adv_x,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>draw: path.draw</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var loadXML = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var xmlDoc;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlDoc = document.implementation.createDocument("", "", null)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e_fx_op) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>Processing.debug(e_fx_op.message);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlDoc.async = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>xmlDoc.load(url);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>parseSVGFont(xmlDoc.getElementsByTagName("svg")[0])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e_sf_ch) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>Processing.debug(e_sf_ch);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var xmlhttp = new window.XMLHttpRequest;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>xmlhttp.open("GET", url, false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>xmlhttp.send(null);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>parseSVGFont(xmlhttp.responseXML.documentElement)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} catch(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>Processing.debug(e_sf_ch)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.glyphTable[url] = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>loadXML(url);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return p.glyphTable[url]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>p.param = function(name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var attributeName = "data-processing-" + name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curElement.hasAttribute(attributeName)) return curElement.getAttribute(attributeName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, len = curElement.childNodes.length; i &lt; len; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var item = curElement.childNodes.item(i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (item.nodeType !== 1 || item.tagName.toLowerCase() !== "param") continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (item.getAttribute("name") === name) return item.getAttribute("value")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curSketch.params.hasOwnProperty(name)) return curSketch.params[name];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function wireDimensionalFunctions(mode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (mode === "3D") drawing = new Drawing3D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (mode === "2D") drawing = new Drawing2D;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else drawing = new DrawingPre;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i in DrawingPre.prototype) if (DrawingPre.prototype.hasOwnProperty(i) &amp;&amp; i.indexOf("$") &lt; 0) p[i] = drawing[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>drawing.$init()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function createDrawingPreFunction(name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>wireDimensionalFunctions("2D");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return drawing[name].apply(this, arguments)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.translate = createDrawingPreFunction("translate");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.transform = createDrawingPreFunction("transform");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.scale = createDrawingPreFunction("scale");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.pushMatrix = createDrawingPreFunction("pushMatrix");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.popMatrix = createDrawingPreFunction("popMatrix");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.resetMatrix = createDrawingPreFunction("resetMatrix");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.applyMatrix = createDrawingPreFunction("applyMatrix");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.rotate = createDrawingPreFunction("rotate");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.rotateZ = createDrawingPreFunction("rotateZ");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.shearX = createDrawingPreFunction("shearX");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.shearY = createDrawingPreFunction("shearY");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.redraw = createDrawingPreFunction("redraw");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.toImageData = createDrawingPreFunction("toImageData");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.ambientLight = createDrawingPreFunction("ambientLight");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.directionalLight = createDrawingPreFunction("directionalLight");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.lightFalloff = createDrawingPreFunction("lightFalloff");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.lightSpecular = createDrawingPreFunction("lightSpecular");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.pointLight = createDrawingPreFunction("pointLight");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.noLights = createDrawingPreFunction("noLights");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.spotLight = createDrawingPreFunction("spotLight");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.beginCamera = createDrawingPreFunction("beginCamera");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.endCamera = createDrawingPreFunction("endCamera");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.frustum = createDrawingPreFunction("frustum");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.box = createDrawingPreFunction("box");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.sphere = createDrawingPreFunction("sphere");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.ambient = createDrawingPreFunction("ambient");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.emissive = createDrawingPreFunction("emissive");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.shininess = createDrawingPreFunction("shininess");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.specular = createDrawingPreFunction("specular");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.fill = createDrawingPreFunction("fill");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.stroke = createDrawingPreFunction("stroke");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.strokeWeight = createDrawingPreFunction("strokeWeight");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.smooth = createDrawingPreFunction("smooth");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.noSmooth = createDrawingPreFunction("noSmooth");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.point = createDrawingPreFunction("point");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.vertex = createDrawingPreFunction("vertex");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.endShape = createDrawingPreFunction("endShape");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.bezierVertex = createDrawingPreFunction("bezierVertex");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.curveVertex = createDrawingPreFunction("curveVertex");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.curve = createDrawingPreFunction("curve");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.line = createDrawingPreFunction("line");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.bezier = createDrawingPreFunction("bezier");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.rect = createDrawingPreFunction("rect");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.ellipse = createDrawingPreFunction("ellipse");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.background = createDrawingPreFunction("background");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.image = createDrawingPreFunction("image");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.textWidth = createDrawingPreFunction("textWidth");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.text$line = createDrawingPreFunction("text$line");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.$ensureContext = createDrawingPreFunction("$ensureContext");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.$newPMatrix = createDrawingPreFunction("$newPMatrix");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.size = function(aWidth, aHeight, aMode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>wireDimensionalFunctions(aMode === 2 ? "3D" : "2D");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.size(aWidth, aHeight, aMode)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingPre.prototype.$init = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing2D.prototype.$init = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.size(p.width, p.height);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curContext.lineCap = "round";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.noSmooth();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.disableContextMenu()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Drawing3D.prototype.$init = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.use3DContext = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.disableContextMenu()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>DrawingShared.prototype.$ensureContext = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return curContext</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function calculateOffset(curElement, event) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var element = curElement,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>offsetX = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>offsetY = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseX = p.mouseX;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.pmouseY = p.mouseY;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (element.offsetParent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>do {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>offsetX += element.offsetLeft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>offsetY += element.offsetTop</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} while ( !! (element = element.offsetParent))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>element = curElement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>do {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>offsetX -= element.scrollLeft || 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>offsetY -= element.scrollTop || 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} while ( !! (element = element.parentNode));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>offsetX += stylePaddingLeft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>offsetY += stylePaddingTop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>offsetX += styleBorderLeft;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>offsetY += styleBorderTop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>offsetX += window.pageXOffset;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>offsetY += window.pageYOffset;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"X": offsetX,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"Y": offsetY</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateMousePosition(curElement, event) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var offset = calculateOffset(curElement, event);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.mouseX = event.pageX - offset.X;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.mouseY = event.pageY - offset.Y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function addTouchEventOffset(t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var offset = calculateOffset(t.changedTouches[0].target, t.changedTouches[0]),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; t.touches.length; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var touch = t.touches[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>touch.offsetX = touch.pageX - offset.X;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>touch.offsetY = touch.pageY - offset.Y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; t.targetTouches.length; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var targetTouch = t.targetTouches[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>targetTouch.offsetX = targetTouch.pageX - offset.X;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>targetTouch.offsetY = targetTouch.pageY - offset.Y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; t.changedTouches.length; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var changedTouch = t.changedTouches[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>changedTouch.offsetX = changedTouch.pageX - offset.X;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>changedTouch.offsetY = changedTouch.pageY - offset.Y</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return t</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(curElement, "touchstart", function(t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.setAttribute("style", "-webkit-user-select: none");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.setAttribute("onclick", "void(0)");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.setAttribute("style", "-webkit-tap-highlight-color:rgba(0,0,0,0)");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, ehl = eventHandlers.length; i &lt; ehl; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var type = eventHandlers[i].type;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (type === "mouseout" || type === "mousemove" || type === "mousedown" || type === "mouseup" || type === "DOMMouseScroll" || type === "mousewheel" || type === "touchstart") detachEventHandler(eventHandlers[i])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (p.touchStart !== undef || p.touchMove !== undef || p.touchEnd !== undef || p.touchCancel !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "touchstart", function(t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (p.touchStart !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>t = addTouchEventOffset(t);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.touchStart(t)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "touchmove", function(t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (p.touchMove !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>t.preventDefault();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>t = addTouchEventOffset(t);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.touchMove(t)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "touchend", function(t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (p.touchEnd !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>t = addTouchEventOffset(t);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.touchEnd(t)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "touchcancel", function(t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (p.touchCancel !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>t = addTouchEventOffset(t);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.touchCancel(t)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "touchstart", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>updateMousePosition(curElement, e.touches[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.__mousePressed = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.mouseDragging = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.mouseButton = 37;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof p.mousePressed === "function") p.mousePressed()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "touchmove", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>e.preventDefault();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>updateMousePosition(curElement, e.touches[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof p.mouseMoved === "function" &amp;&amp; !p.__mousePressed) p.mouseMoved();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof p.mouseDragged === "function" &amp;&amp; p.__mousePressed) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.mouseDragged();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.mouseDragging = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "touchend", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p.__mousePressed = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof p.mouseClicked === "function" &amp;&amp; !p.mouseDragging) p.mouseClicked();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (typeof p.mouseReleased === "function") p.mouseReleased()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.dispatchEvent(t)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>(function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var enabled = true,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>contextMenu = function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>e.preventDefault();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>e.stopPropagation()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.disableContextMenu = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!enabled) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(curElement, "contextmenu", contextMenu);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>enabled = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.enableContextMenu = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (enabled) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>detachEventHandler({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>elem: curElement,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>type: "contextmenu",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>fn: contextMenu</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>enabled = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>})();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(curElement, "mousemove", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updateMousePosition(curElement, e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof p.mouseMoved === "function" &amp;&amp; !p.__mousePressed) p.mouseMoved();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof p.mouseDragged === "function" &amp;&amp; p.__mousePressed) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.mouseDragged();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.mouseDragging = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(curElement, "mouseout", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof p.mouseOut === "function") p.mouseOut()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(curElement, "mouseover", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updateMousePosition(curElement, e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof p.mouseOver === "function") p.mouseOver()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>curElement.onmousedown = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.focus();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(curElement, "mousedown", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.__mousePressed = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.mouseDragging = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>switch (e.which) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 1:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.mouseButton = 37;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 2:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.mouseButton = 3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 3:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.mouseButton = 39;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof p.mousePressed === "function") p.mousePressed()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(curElement, "mouseup", function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.__mousePressed = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof p.mouseClicked === "function" &amp;&amp; !p.mouseDragging) p.mouseClicked();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof p.mouseReleased === "function") p.mouseReleased()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var mouseWheelHandler = function(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var delta = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (e.wheelDelta) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>delta = e.wheelDelta / 120;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (window.opera) delta = -delta</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else if (e.detail) delta = -e.detail / 3;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.mouseScroll = delta;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (delta &amp;&amp; typeof p.mouseScrolled === "function") p.mouseScrolled()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(document, "DOMMouseScroll", mouseWheelHandler);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>attachEventHandler(document, "mousewheel", mouseWheelHandler);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (!curElement.getAttribute("tabindex")) curElement.setAttribute("tabindex", 0);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function getKeyCode(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var code = e.which || e.keyCode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>switch (code) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 13:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return 10;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 91:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 93:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 224:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return 157;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 57392:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return 17;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 46:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return 127;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 45:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return 155</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return code</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function getKeyChar(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c = e.which || e.keyCode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var anyShiftPressed = e.shiftKey || e.ctrlKey || e.altKey || e.metaKey;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>switch (c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 13:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>c = anyShiftPressed ? 13 : 10;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>case 8:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>c = anyShiftPressed ? 127 : 8;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new Char(c)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function suppressKeyEvent(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof e.preventDefault === "function") e.preventDefault();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (typeof e.stopPropagation === "function") e.stopPropagation();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function updateKeyPressed() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var ch;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (ch in pressedKeysMap) if (pressedKeysMap.hasOwnProperty(ch)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.__keyPressed = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.__keyPressed = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function resetKeyPressed() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.__keyPressed = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pressedKeysMap = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lastPressedKeyCode = null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function simulateKeyTyped(code, c) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pressedKeysMap[code] = c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lastPressedKeyCode = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.key = c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyCode = code;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyPressed();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyCode = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyTyped();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updateKeyPressed()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function handleKeydown(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var code = getKeyCode(e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (code === 127) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>simulateKeyTyped(code, new Char(127));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (codedKeys.indexOf(code) &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lastPressedKeyCode = code;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var c = new Char(65535);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.key = c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyCode = code;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pressedKeysMap[code] = c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyPressed();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>lastPressedKeyCode = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updateKeyPressed();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return suppressKeyEvent(e)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function handleKeypress(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (lastPressedKeyCode === null) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var code = lastPressedKeyCode,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>c = getKeyChar(e);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>simulateKeyTyped(code, c);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return suppressKeyEvent(e)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function handleKeyup(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var code = getKeyCode(e),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>c = pressedKeysMap[code];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (c === undef) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.key = c;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyCode = code;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.keyReleased();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>delete pressedKeysMap[code];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updateKeyPressed()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (!pgraphicsMode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (aCode instanceof Processing.Sketch) curSketch = aCode;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (typeof aCode === "function") curSketch = new Processing.Sketch(aCode);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (!aCode) curSketch = new Processing.Sketch(function() {});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else curSketch = Processing.compile(aCode);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.externals.sketch = curSketch;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>wireDimensionalFunctions();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.onfocus = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.focused = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curElement.onblur = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.focused = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!curSketch.options.globalKeyEvents) resetKeyPressed()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (curSketch.options.pauseOnBlur) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(window, "focus", function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doLoop) p.loop()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>attachEventHandler(window, "blur", function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (doLoop &amp;&amp; loopStarted) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>p.noLoop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>doLoop = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resetKeyPressed()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var keyTrigger = curSketch.options.globalKeyEvents ? window : curElement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>attachEventHandler(keyTrigger, "keydown", handleKeydown);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>attachEventHandler(keyTrigger, "keypress", handleKeypress);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>attachEventHandler(keyTrigger, "keyup", handleKeyup);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i in Processing.lib) if (Processing.lib.hasOwnProperty(i)) if (Processing.lib[i].hasOwnProperty("attach")) Processing.lib[i].attach(p);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (Processing.lib[i] instanceof Function) Processing.lib[i].call(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var retryInterval = 100;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var executeSketch = function(processing) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (! (curSketch.imageCache.pending || PFont.preloading.pending(retryInterval))) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (window.opera) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var link, element, operaCache = curSketch.imageCache.operaCache;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (link in operaCache) if (operaCache.hasOwnProperty(link)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>element = operaCache[link];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>if (element !== null) document.body.removeChild(element);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>delete operaCache[link]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curSketch.attach(processing, defaultScope);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>curSketch.onLoad(processing);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (processing.setup) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>processing.setup();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>processing.resetMatrix();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>curSketch.onSetup()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resetContext();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (processing.draw) if (!doLoop) processing.redraw();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else processing.loop()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else window.setTimeout(function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>executeSketch(processing)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>retryInterval)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>addInstance(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>executeSketch(p)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>curSketch = new Processing.Sketch;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>wireDimensionalFunctions();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>p.size = function(w, h, render) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (render &amp;&amp; render === 2) wireDimensionalFunctions("3D");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else wireDimensionalFunctions("2D");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>p.size(w, h, render)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.debug = debug;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.prototype = defaultScope;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function getGlobalMembers() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var names = ["abs", "acos", "alpha", "ambient", "ambientLight", "append",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"applyMatrix", "arc", "arrayCopy", "asin", "atan", "atan2", "background", "beginCamera", "beginDraw", "beginShape", "bezier", "bezierDetail", "bezierPoint", "bezierTangent", "bezierVertex", "binary", "blend", "blendColor", "blit_resize", "blue", "box", "breakShape", "brightness", "camera", "ceil", "Character", "color", "colorMode", "concat", "constrain", "copy", "cos", "createFont", "createGraphics", "createImage", "cursor", "curve", "curveDetail", "curvePoint", "curveTangent", "curveTightness", "curveVertex", "day", "degrees", "directionalLight",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"disableContextMenu", "dist", "draw", "ellipse", "ellipseMode", "emissive", "enableContextMenu", "endCamera", "endDraw", "endShape", "exit", "exp", "expand", "externals", "fill", "filter", "floor", "focused", "frameCount", "frameRate", "frustum", "get", "glyphLook", "glyphTable", "green", "height", "hex", "hint", "hour", "hue", "image", "imageMode", "intersect", "join", "key", "keyCode", "keyPressed", "keyReleased", "keyTyped", "lerp", "lerpColor", "lightFalloff", "lights", "lightSpecular", "line", "link", "loadBytes", "loadFont", "loadGlyphs",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"loadImage", "loadPixels", "loadShape", "loadXML", "loadStrings", "log", "loop", "mag", "map", "match", "matchAll", "max", "millis", "min", "minute", "mix", "modelX", "modelY", "modelZ", "modes", "month", "mouseButton", "mouseClicked", "mouseDragged", "mouseMoved", "mouseOut", "mouseOver", "mousePressed", "mouseReleased", "mouseScroll", "mouseScrolled", "mouseX", "mouseY", "name", "nf", "nfc", "nfp", "nfs", "noCursor", "noFill", "noise", "noiseDetail", "noiseSeed", "noLights", "noLoop", "norm", "normal", "noSmooth", "noStroke", "noTint", "ortho",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"param", "parseBoolean", "parseByte", "parseChar", "parseFloat", "parseInt", "peg", "perspective", "PImage", "pixels", "PMatrix2D", "PMatrix3D", "PMatrixStack", "pmouseX", "pmouseY", "point", "pointLight", "popMatrix", "popStyle", "pow", "print", "printCamera", "println", "printMatrix", "printProjection", "PShape", "PShapeSVG", "pushMatrix", "pushStyle", "quad", "radians", "random", "Random", "randomSeed", "rect", "rectMode", "red", "redraw", "requestImage", "resetMatrix", "reverse", "rotate", "rotateX", "rotateY", "rotateZ", "round", "saturation",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"save", "saveFrame", "saveStrings", "scale", "screenX", "screenY", "screenZ", "second", "set", "setup", "shape", "shapeMode", "shared", "shearX", "shearY", "shininess", "shorten", "sin", "size", "smooth", "sort", "specular", "sphere", "sphereDetail", "splice", "split", "splitTokens", "spotLight", "sq", "sqrt", "status", "str", "stroke", "strokeCap", "strokeJoin", "strokeWeight", "subset", "tan", "text", "textAlign", "textAscent", "textDescent", "textFont", "textLeading", "textMode", "textSize", "texture", "textureMode", "textWidth", "tint", "toImageData",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>"touchCancel", "touchEnd", "touchMove", "touchStart", "translate", "transform", "triangle", "trim", "unbinary", "unhex", "updatePixels", "use3DContext", "vertex", "width", "XMLElement", "XML", "year", "__contains", "__equals", "__equalsIgnoreCase", "__frameRate", "__hashCode", "__int_cast", "__instanceof", "__keyPressed", "__mousePressed", "__printStackTrace", "__replace", "__replaceAll", "__replaceFirst", "__toCharArray", "__split", "__codePointAt", "__startsWith", "__endsWith", "__matches"];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var members = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var i, l;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (i = 0, l = names.length; i &lt; l; ++i) members[names[i]] = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (var lib in Processing.lib) if (Processing.lib.hasOwnProperty(lib)) if (Processing.lib[lib].exports) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var exportedNames = Processing.lib[lib].exports;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = exportedNames.length; i &lt; l; ++i) members[exportedNames[i]] = null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return members</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function parseProcessing(code) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var globalMembers = getGlobalMembers();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function splitToAtoms(code) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var atoms = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var items = code.split(/([\{\[\(\)\]\}])/);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = items[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var stack = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 1; i &lt; items.length; i += 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var item = items[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (item === "[" || item === "{" || item === "(") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>stack.push(result);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>result = item</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (item === "]" || item === "}" || item === ")") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var kind = item === "}" ? "A" : item === ")" ? "B" : "C";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var index = atoms.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>atoms.push(result + item);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>result = stack.pop() + '"' + kind + (index + 1) + '"'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result += items[i + 1]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>atoms.unshift(result);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return atoms</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function injectStrings(code, strings) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return code.replace(/'(\d+)'/g, function(all, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var val = strings[index];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (val.charAt(0) === "/") return val;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return /^'((?:[^'\\\n])|(?:\\.[0-9A-Fa-f]*))'$/.test(val) ? "(new $p.Character(" + val + "))" : val</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function trimSpaces(string) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m1 = /^\s*/.exec(string),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (m1[0].length === string.length) result = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>left: m1[0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>middle: "",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>right: ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var m2 = /\s*$/.exec(string);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>left: m1[0],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>middle: string.substring(m1[0].length, m2.index),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>right: m2[0]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>result.untrim = function(t) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return this.left + t + this.right</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function trim(string) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return string.replace(/^\s+/, "").replace(/\s+$/, "")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function appendToLookupTable(table, array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, l = array.length; i &lt; l; ++i) table[array[i]] = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return table</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function isLookupTableEmpty(table) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i in table) if (table.hasOwnProperty(i)) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function getAtomIndex(templ) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return templ.substring(2, templ.length - 1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var codeWoExtraCr = code.replace(/\r\n?|\n\r/g, "\n");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var strings = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var codeWoStrings = codeWoExtraCr.replace(/("(?:[^"\\\n]|\\.)*")|('(?:[^'\\\n]|\\.)*')|(([\[\(=|&amp;!\^:?]\s*)(\/(?![*\/])(?:[^\/\\\n]|\\.)*\/[gim]*)\b)|(\/\/[^\n]*\n)|(\/\*(?:(?!\*\/)(?:.|\n))*\*\/)/g, function(all, quoted, aposed, regexCtx, prefix, regex, singleComment, comment) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var index;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (quoted || aposed) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>index = strings.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>strings.push(all);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "'" + index + "'"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (regexCtx) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>index = strings.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>strings.push(regex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return prefix + "'" + index + "'"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return comment !== "" ? " " : "\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>codeWoStrings = codeWoStrings.replace(/__x([0-9A-F]{4})/g, function(all, hexCode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "__x005F_x" + hexCode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>codeWoStrings = codeWoStrings.replace(/\$/g, "__x0024");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var genericsWereRemoved;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var codeWoGenerics = codeWoStrings;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var replaceFunc = function(all, before, types, after) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if ( !! before || !!after) return all;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>genericsWereRemoved = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>do {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>genericsWereRemoved = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>codeWoGenerics = codeWoGenerics.replace(/([&lt;]?)&lt;\s*((?:\?|[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)(?:\[\])*(?:\s+(?:extends|super)\s+[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)?(?:\s*,\s*(?:\?|[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)(?:\[\])*(?:\s+(?:extends|super)\s+[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)?)*)\s*&gt;([=]?)/g, replaceFunc)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>} while (genericsWereRemoved);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var atoms = splitToAtoms(codeWoGenerics);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var declaredClasses = {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentClassId, classIdSeed = 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function addAtom(text, type) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lastIndex = atoms.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>atoms.push(text);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return '"' + type + lastIndex + '"'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function generateClassId() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "class" + ++classIdSeed</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function appendClass(class_, classId, scopeId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>class_.classId = classId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>class_.scopeId = scopeId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>declaredClasses[classId] = class_</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var transformClassBody, transformInterfaceBody, transformStatementsBlock, transformStatements, transformMain, transformExpression;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var classesRegex = /\b((?:(?:public|private|final|protected|static|abstract)\s+)*)(class|interface)\s+([A-Za-z_$][\w$]*\b)(\s+extends\s+[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*(?:\s*,\s*[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*\b)*)?(\s+implements\s+[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*(?:\s*,\s*[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*\b)*)?\s*("A\d+")/g;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var methodsRegex = /\b((?:(?:public|private|final|protected|static|abstract|synchronized)\s+)*)((?!(?:else|new|return|throw|function|public|private|protected)\b)[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*(?:\s*"C\d+")*)\s*([A-Za-z_$][\w$]*\b)\s*("B\d+")(\s*throws\s+[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*(?:\s*,\s*[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)*)?\s*("A\d+"|;)/g;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var fieldTest = /^((?:(?:public|private|final|protected|static)\s+)*)((?!(?:else|new|return|throw)\b)[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*(?:\s*"C\d+")*)\s*([A-Za-z_$][\w$]*\b)\s*(?:"C\d+"\s*)*([=,]|$)/;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var cstrsRegex = /\b((?:(?:public|private|final|protected|static|abstract)\s+)*)((?!(?:new|return|throw)\b)[A-Za-z_$][\w$]*\b)\s*("B\d+")(\s*throws\s+[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*(?:\s*,\s*[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)*)?\s*("A\d+")/g;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var attrAndTypeRegex = /^((?:(?:public|private|final|protected|static)\s+)*)((?!(?:new|return|throw)\b)[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*(?:\s*"C\d+")*)\s*/;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var functionsRegex = /\bfunction(?:\s+([A-Za-z_$][\w$]*))?\s*("B\d+")\s*("A\d+")/g;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function extractClassesAndMethods(code) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var s = code;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(classesRegex, function(all) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return addAtom(all, "E")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(methodsRegex, function(all) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return addAtom(all, "D")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(functionsRegex, function(all) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return addAtom(all, "H")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return s</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function extractConstructors(code, className) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = code.replace(cstrsRegex, function(all, attr, name, params, throws_, body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (name !== className) return all;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return addAtom(all, "G")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstParam(name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstParam.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstParams(params, methodArgsParam) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = params;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.methodArgsParam = methodArgsParam</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstParams.prototype.getNames = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var names = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, l = this.params.length; i &lt; l; ++i) names.push(this.params[i].name);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return names</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstParams.prototype.prependMethodArgs = function(body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!this.methodArgsParam) return body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "{\nvar " + this.methodArgsParam.name + " = Array.prototype.slice.call(arguments, " + this.params.length + ");\n" + body.substring(1)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstParams.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.params.length === 0) return "()";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "(";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, l = this.params.length; i &lt; l; ++i) result += this.params[i] + ", ";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result.substring(0, result.length - 2) + ")"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformParams(params) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var paramsWoPars = trim(params.substring(1, params.length - 1));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>methodArgsParam = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (paramsWoPars !== "") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var paramList = paramsWoPars.split(",");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; paramList.length; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var param = /\b([A-Za-z_$][\w$]*\b)(\s*"[ABC][\d]*")*\s*$/.exec(paramList[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (i === paramList.length - 1 &amp;&amp; paramList[i].indexOf("...") &gt;= 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>methodArgsParam = new AstParam(param[1]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>result.push(new AstParam(param[1]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstParams(result, methodArgsParam)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function preExpressionTransform(expr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var s = expr;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\bnew\s+([A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)(?:\s*"C\d+")+\s*("A\d+")/g, function(all, type, init) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return init</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\bnew\s+([A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)(?:\s*"B\d+")\s*("A\d+")/g, function(all, type, init) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return addAtom(all, "F")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(functionsRegex, function(all) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return addAtom(all, "H")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\bnew\s+([A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)\s*("C\d+"(?:\s*"C\d+")*)/g, function(all, type, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var args = index.replace(/"C(\d+)"/g, function(all, j) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return atoms[j]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}).replace(/\[\s*\]/g, "[null]").replace(/\s*\]\s*\[\s*/g, ", ");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var arrayInitializer = "{" + args.substring(1, args.length - 1) + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var createArrayArgs = "('" + type + "', " + addAtom(arrayInitializer, "A") + ")";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "$p.createJavaArray" + addAtom(createArrayArgs, "B")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/(\.\s*length)\s*"B\d+"/g, "$1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/#([0-9A-Fa-f]{6})\b/g, function(all, digits) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "0xFF" + digits</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/"B(\d+)"(\s*(?:[\w$']|"B))/g, function(all, index, next) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var atom = atoms[index];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!/^\(\s*[A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*\s*(?:"C\d+"\s*)*\)$/.test(atom)) return all;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (/^\(\s*int\s*\)$/.test(atom)) return "(int)" + next;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var indexParts = atom.split(/"C(\d+)"/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (indexParts.length &gt; 1) if (!/^\[\s*\]$/.test(atoms[indexParts[1]])) return all;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "" + next</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\(int\)([^,\]\)\}\?\:\*\+\-\/\^\|\%\&amp;\~&lt;\&gt;\=]+)/g, function(all, arg) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var trimmed = trimSpaces(arg);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return trimmed.untrim("__int_cast(" + trimmed.middle + ")")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\bsuper(\s*"B\d+")/g, "$$superCstr$1").replace(/\bsuper(\s*\.)/g, "$$super$1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\b0+((\d*)(?:\.[\d*])?(?:[eE][\-\+]?\d+)?[fF]?)\b/, function(all, numberWo0, intPart) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (numberWo0 === intPart) return all;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return intPart === "" ? "0" + numberWo0 : numberWo0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\b(\.?\d+\.?)[fF]\b/g, "$1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/([^\s])%([^=\s])/g, "$1 % $2");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\b(frameRate|keyPressed|mousePressed)\b(?!\s*"B)/g, "__$1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\b(boolean|byte|char|float|int)\s*"B/g, function(all, name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "parse" + name.substring(0, 1).toUpperCase() + name.substring(1) + '"B'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\bpixels\b\s*(("C(\d+)")|\.length)?(\s*=(?!=)([^,\]\)\}]+))?/g, function(all, indexOrLength, index, atomIndex, equalsPart, rightSide) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var atom = atoms[atomIndex];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (equalsPart) return "pixels.setPixel" + addAtom("(" + atom.substring(1, atom.length - 1) + "," + rightSide + ")", "B");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return "pixels.getPixel" + addAtom("(" + atom.substring(1, atom.length - 1) + ")", "B")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (indexOrLength) return "pixels.getLength" + addAtom("()", "B");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (equalsPart) return "pixels.set" + addAtom("(" + rightSide + ")", "B");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "pixels.toArray" + addAtom("()", "B")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var repeatJavaReplacement;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function replacePrototypeMethods(all, subject, method, atomIndex) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var atom = atoms[atomIndex];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>repeatJavaReplacement = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var trimmed = trimSpaces(atom.substring(1, atom.length - 1));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "__" + method + (trimmed.middle === "" ? addAtom("(" + subject.replace(/\.\s*$/, "") + ")", "B") : addAtom("(" + subject.replace(/\.\s*$/, "") + "," + trimmed.middle + ")", "B"))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>do {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>repeatJavaReplacement = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>s = s.replace(/((?:'\d+'|\b[A-Za-z_$][\w$]*\s*(?:"[BC]\d+")*)\s*\.\s*(?:[A-Za-z_$][\w$]*\s*(?:"[BC]\d+"\s*)*\.\s*)*)(replace|replaceAll|replaceFirst|contains|equals|equalsIgnoreCase|hashCode|toCharArray|printStackTrace|split|startsWith|endsWith|codePointAt|matches)\s*"B(\d+)"/g, replacePrototypeMethods)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} while (repeatJavaReplacement);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function replaceInstanceof(all, subject, type) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>repeatJavaReplacement = true;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "__instanceof" + addAtom("(" + subject + ", " + type + ")", "B")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>do {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>repeatJavaReplacement = false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>s = s.replace(/((?:'\d+'|\b[A-Za-z_$][\w$]*\s*(?:"[BC]\d+")*)\s*(?:\.\s*[A-Za-z_$][\w$]*\s*(?:"[BC]\d+"\s*)*)*)instanceof\s+([A-Za-z_$][\w$]*\s*(?:\.\s*[A-Za-z_$][\w$]*)*)/g, replaceInstanceof)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} while (repeatJavaReplacement);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\bthis(\s*"B\d+")/g, "$$constr$1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return s</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstInlineClass(baseInterfaceName, body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.baseInterfaceName = baseInterfaceName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>body.owner = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstInlineClass.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "new (" + this.body + ")"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformInlineClass(class_) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m = (new RegExp(/\bnew\s*([A-Za-z_$][\w$]*\s*(?:\.\s*[A-Za-z_$][\w$]*)*)\s*"B\d+"\s*"A(\d+)"/)).exec(class_);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldClassId = currentClassId,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>newClassId = generateClassId();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentClassId = newClassId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var uniqueClassName = m[1] + "$" + newClassId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var inlineClass = new AstInlineClass(uniqueClassName, transformClassBody(atoms[m[2]], uniqueClassName, "", "implements " + m[1]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>appendClass(inlineClass, newClassId, oldClassId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentClassId = oldClassId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return inlineClass</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstFunction(name, params, body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = params;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstFunction.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var names = appendToLookupTable({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>"this": null</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params.getNames());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return names.hasOwnProperty(subject.name) ? subject.name : oldContext(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "function";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.name) result += " " + this.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var body = this.params.prependMethodArgs(this.body.toString());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>result += this.params + " " + body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformFunction(class_) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m = (new RegExp(/\b([A-Za-z_$][\w$]*)\s*"B(\d+)"\s*"A(\d+)"/)).exec(class_);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstFunction(m[1] !== "function" ? m[1] : null, transformParams(atoms[m[2]]), transformStatementsBlock(atoms[m[3]]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstInlineObject(members) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.members = members</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstInlineObject.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return subject.name === "this" ? "this" : oldContext(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, l = this.members.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.members[i].label) result += this.members[i].label + ": ";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result += this.members[i].value.toString() + ", "</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result.substring(0, result.length - 2)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformInlineObject(obj) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var members = obj.split(",");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; members.length; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var label = members[i].indexOf(":");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (label &lt; 0) members[i] = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>value: transformExpression(members[i])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else members[i] = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>label: trim(members[i].substring(0, label)),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>value: transformExpression(trim(members[i].substring(label + 1)))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstInlineObject(members)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function expandExpression(expr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (expr.charAt(0) === "(" || expr.charAt(0) === "[") return expr.charAt(0) + expandExpression(expr.substring(1, expr.length - 1)) + expr.charAt(expr.length - 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (expr.charAt(0) === "{") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (/^\{\s*(?:[A-Za-z_$][\w$]*|'\d+')\s*:/.test(expr)) return "{" + addAtom(expr.substring(1, expr.length - 1), "I") + "}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return "[" + expandExpression(expr.substring(1, expr.length - 1)) + "]"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var trimmed = trimSpaces(expr);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = preExpressionTransform(trimmed.middle);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>result = result.replace(/"[ABC](\d+)"/g, function(all, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return expandExpression(atoms[index])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return trimmed.untrim(result)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function replaceContextInVars(expr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return expr.replace(/(\.\s*)?((?:\b[A-Za-z_]|\$)[\w$]*)(\s*\.\s*([A-Za-z_$][\w$]*)(\s*\()?)?/g, function(all, memberAccessSign, identifier, suffix, subMember, callSign) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (memberAccessSign) return all;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var subject = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>name: identifier,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>member: subMember,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>callSign: !!callSign</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return replaceContext(subject) + (suffix === undef ? "" : suffix)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstExpression(expr, transforms) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.expr = expr;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.transforms = transforms</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstExpression.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var transforms = this.transforms;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var expr = replaceContextInVars(this.expr);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return expr.replace(/"!(\d+)"/g, function(all, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return transforms[index].toString()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>transformExpression = function(expr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var transforms = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var s = expandExpression(expr);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/"H(\d+)"/g, function(all, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>transforms.push(transformFunction(atoms[index]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return '"!' + (transforms.length - 1) + '"'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/"F(\d+)"/g, function(all, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>transforms.push(transformInlineClass(atoms[index]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return '"!' + (transforms.length - 1) + '"'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/"I(\d+)"/g, function(all, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>transforms.push(transformInlineObject(atoms[index]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return '"!' + (transforms.length - 1) + '"'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstExpression(s, transforms)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstVarDefinition(name, value, isDefault) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.value = value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.isDefault = isDefault</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstVarDefinition.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.name + " = " + this.value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformVarDefinition(def, defaultTypeValue) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var eqIndex = def.indexOf("=");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var name, value, isDefault;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (eqIndex &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>name = def;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>value = defaultTypeValue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>isDefault = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>name = def.substring(0, eqIndex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>value = transformExpression(def.substring(eqIndex + 1));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>isDefault = false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstVarDefinition(trim(name.replace(/(\s*"C\d+")+/g, "")), value, isDefault)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function getDefaultValueForType(type) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (type === "int" || type === "float") return "0";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (type === "boolean") return "false";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (type === "color") return "0x00000000";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "null"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstVar(definitions, varType) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.definitions = definitions;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.varType = varType</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstVar.prototype.getNames = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var names = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, l = this.definitions.length; i &lt; l; ++i) names.push(this.definitions[i].name);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return names</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstVar.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "var " + this.definitions.join(",")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstStatement(expression) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.expression = expression</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstStatement.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.expression.toString()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformStatement(statement) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (fieldTest.test(statement)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var attrAndType = attrAndTypeRegex.exec(statement);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var definitions = statement.substring(attrAndType[0].length).split(",");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var defaultTypeValue = getDefaultValueForType(attrAndType[2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0; i &lt; definitions.length; ++i) definitions[i] = transformVarDefinition(definitions[i], defaultTypeValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new AstVar(definitions, attrAndType[2])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstStatement(transformExpression(statement))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstForExpression(initStatement, condition, step) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.initStatement = initStatement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.condition = condition;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.step = step</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstForExpression.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "(" + this.initStatement + "; " + this.condition + "; " + this.step + ")"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstForInExpression(initStatement, container) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.initStatement = initStatement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.container = container</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstForInExpression.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var init = this.initStatement.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (init.indexOf("=") &gt;= 0) init = init.substring(0, init.indexOf("="));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "(" + init + " in " + this.container + ")"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstForEachExpression(initStatement, container) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.initStatement = initStatement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.container = container</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstForEachExpression.iteratorId = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstForEachExpression.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var init = this.initStatement.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var iterator = "$it" + AstForEachExpression.iteratorId++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var variableName = init.replace(/^\s*var\s*/, "").split("=")[0];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var initIteratorAndVariable = "var " + iterator + " = new $p.ObjectIterator(" + this.container + "), " + variableName + " = void(0)";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var nextIterationCondition = iterator + ".hasNext() &amp;&amp; ((" + variableName + " = " + iterator + ".next()) || true)";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "(" + initIteratorAndVariable + "; " + nextIterationCondition + ";)"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformForExpression(expr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var content;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (/\bin\b/.test(expr)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>content = expr.substring(1, expr.length - 1).split(/\bin\b/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new AstForInExpression(transformStatement(trim(content[0])), transformExpression(content[1]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (expr.indexOf(":") &gt;= 0 &amp;&amp; expr.indexOf(";") &lt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>content = expr.substring(1, expr.length - 1).split(":");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return new AstForEachExpression(transformStatement(trim(content[0])), transformExpression(content[1]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>content = expr.substring(1, expr.length - 1).split(";");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstForExpression(transformStatement(trim(content[0])), transformExpression(content[1]), transformExpression(content[2]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function sortByWeight(array) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>array.sort(function(a, b) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return b.weight - a.weight</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstInnerInterface(name, body, isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.isStatic = isStatic;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>body.owner = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstInnerInterface.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "" + this.body</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstInnerClass(name, body, isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.isStatic = isStatic;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>body.owner = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstInnerClass.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "" + this.body</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformInnerClass(class_) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m = classesRegex.exec(class_);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>classesRegex.lastIndex = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var isStatic = m[1].indexOf("static") &gt;= 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var body = atoms[getAtomIndex(m[6])],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>innerClass;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldClassId = currentClassId,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>newClassId = generateClassId();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentClassId = newClassId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (m[2] === "interface") innerClass = new AstInnerInterface(m[3], transformInterfaceBody(body, m[3], m[4]), isStatic);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else innerClass = new AstInnerClass(m[3], transformClassBody(body, m[3], m[4], m[5]), isStatic);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>appendClass(innerClass, newClassId, oldClassId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentClassId = oldClassId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return innerClass</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstClassMethod(name, params, body, isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = params;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.isStatic = isStatic</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstClassMethod.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var paramNames = appendToLookupTable({},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params.getNames());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return paramNames.hasOwnProperty(subject.name) ? subject.name : oldContext(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var body = this.params.prependMethodArgs(this.body.toString());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "function " + this.methodId + this.params + " " + body + "\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformClassMethod(method) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m = methodsRegex.exec(method);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>methodsRegex.lastIndex = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var isStatic = m[1].indexOf("static") &gt;= 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var body = m[6] !== ";" ? atoms[getAtomIndex(m[6])] : "{}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstClassMethod(m[3], transformParams(atoms[getAtomIndex(m[4])]), transformStatementsBlock(body), isStatic)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstClassField(definitions, fieldType, isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.definitions = definitions;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fieldType = fieldType;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.isStatic = isStatic</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstClassField.prototype.getNames = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var names = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, l = this.definitions.length; i &lt; l; ++i) names.push(this.definitions[i].name);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return names</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstClassField.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var thisPrefix = replaceContext({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>name: "[this]"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var className = this.owner.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var staticDeclarations = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 0, l = this.definitions.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var definition = this.definitions[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var name = definition.name,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>staticName = className + "." + name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var declaration = "if(" + staticName + " === void(0)) {\n" + " " + staticName + " = " + definition.value + "; }\n" + "$p.defineProperty(" + thisPrefix + ", " + "'" + name + "', { get: function(){return " + staticName + ";}, " + "set: function(val){" + staticName + " = val;} });\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>staticDeclarations.push(declaration)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return staticDeclarations.join("")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return thisPrefix + "." + this.definitions.join("; " + thisPrefix + ".")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformClassField(statement) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var attrAndType = attrAndTypeRegex.exec(statement);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var isStatic = attrAndType[1].indexOf("static") &gt;= 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var definitions = statement.substring(attrAndType[0].length).split(/,\s*/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var defaultTypeValue = getDefaultValueForType(attrAndType[2]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0; i &lt; definitions.length; ++i) definitions[i] = transformVarDefinition(definitions[i], defaultTypeValue);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstClassField(definitions, attrAndType[2], isStatic)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstConstructor(params, body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = params;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstConstructor.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var paramNames = appendToLookupTable({},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params.getNames());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return paramNames.hasOwnProperty(subject.name) ? subject.name : oldContext(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var prefix = "function $constr_" + this.params.params.length + this.params.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var body = this.params.prependMethodArgs(this.body.toString());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!/\$(superCstr|constr)\b/.test(body)) body = "{\n$superCstr();\n" + body.substring(1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return prefix + body + "\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformConstructor(cstr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m = (new RegExp(/"B(\d+)"\s*"A(\d+)"/)).exec(cstr);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var params = transformParams(atoms[m[1]]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstConstructor(params, transformStatementsBlock(atoms[m[2]]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstInterfaceBody(name, interfacesNames, methodsNames, fields, innerClasses, misc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, l;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.interfacesNames = interfacesNames;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.methodsNames = methodsNames;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fields = fields;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.innerClasses = innerClasses;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.misc = misc;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = fields.length; i &lt; l; ++i) fields[i].owner = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstInterfaceBody.prototype.getMembers = function(classFields, classMethods, classInners) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.owner.base) this.owner.base.body.getMembers(classFields, classMethods, classInners);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, j, l, m;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.fields.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fieldNames = this.fields[i].getNames();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 0, m = fieldNames.length; j &lt; m; ++j) classFields[fieldNames[j]] = this.fields[i]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.methodsNames.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var methodName = this.methodsNames[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>classMethods[methodName] = true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.innerClasses.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var innerClass = this.innerClasses[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>classInners[innerClass.name] = innerClass</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstInterfaceBody.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function getScopeLevel(p) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (p) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>++i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p = p.scope</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return i</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var scopeLevel = getScopeLevel(this.owner);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var className = this.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var staticDefinitions = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var metadata = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var thisClassFields = {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>thisClassMethods = {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>thisClassInners = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.getMembers(thisClassFields, thisClassMethods, thisClassInners);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, l, j, m;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.owner.interfaces) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var resolvedInterfaces = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resolvedInterface;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0, l = this.interfacesNames.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!this.owner.interfaces[i]) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resolvedInterface = replaceContext({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>name: this.interfacesNames[i]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resolvedInterfaces.push(resolvedInterface);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>staticDefinitions += "$p.extendInterfaceMembers(" + className + ", " + resolvedInterface + ");\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>metadata += className + ".$interfaces = [" + resolvedInterfaces.join(", ") + "];\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>metadata += className + ".$isInterface = true;\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>metadata += className + ".$methods = ['" + this.methodsNames.join("', '") + "'];\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sortByWeight(this.innerClasses);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.innerClasses.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var innerClass = this.innerClasses[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (innerClass.isStatic) staticDefinitions += className + "." + innerClass.name + " = " + innerClass + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.fields.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var field = this.fields[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (field.isStatic) staticDefinitions += className + "." + field.definitions.join(";\n" + className + ".") + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "(function() {\n" + "function " + className + "() { throw 'Unable to create the interface'; }\n" + staticDefinitions + metadata + "return " + className + ";\n" + "})()"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>transformInterfaceBody = function(body, name, baseInterfaces) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var declarations = body.substring(1, body.length - 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>declarations = extractClassesAndMethods(declarations);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>declarations = extractConstructors(declarations, name);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var methodsNames = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>classes = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>declarations = declarations.replace(/"([DE])(\d+)"/g, function(all, type, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (type === "D") methodsNames.push(index);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (type === "E") classes.push(index);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fields = declarations.split(/;(?:\s*;)*/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var baseInterfaceNames;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, l;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (baseInterfaces !== undef) baseInterfaceNames = baseInterfaces.replace(/^\s*extends\s+(.+?)\s*$/g, "$1").split(/\s*,\s*/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = methodsNames.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var method = transformClassMethod(atoms[methodsNames[i]]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>methodsNames[i] = method.name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = fields.length - 1; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var field = trimSpaces(fields[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fields[i] = transformClassField(field.middle)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tail = fields.pop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = classes.length; i &lt; l; ++i) classes[i] = transformInnerClass(atoms[classes[i]]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstInterfaceBody(name, baseInterfaceNames, methodsNames, fields, classes, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tail: tail</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstClassBody(name, baseClassName, interfacesNames, functions, methods, fields, cstrs, innerClasses, misc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, l;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.baseClassName = baseClassName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.interfacesNames = interfacesNames;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.functions = functions;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.methods = methods;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.fields = fields;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.cstrs = cstrs;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.innerClasses = innerClasses;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.misc = misc;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = fields.length; i &lt; l; ++i) fields[i].owner = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstClassBody.prototype.getMembers = function(classFields, classMethods, classInners) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.owner.base) this.owner.base.body.getMembers(classFields, classMethods, classInners);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, j, l, m;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.fields.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var fieldNames = this.fields[i].getNames();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (j = 0, m = fieldNames.length; j &lt; m; ++j) classFields[fieldNames[j]] = this.fields[i]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.methods.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var method = this.methods[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>classMethods[method.name] = method</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.innerClasses.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var innerClass = this.innerClasses[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>classInners[innerClass.name] = innerClass</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstClassBody.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function getScopeLevel(p) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (p) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>++i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>p = p.scope</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return i</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var scopeLevel = getScopeLevel(this.owner);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var selfId = "$this_" + scopeLevel;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var className = this.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "var " + selfId + " = this;\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var staticDefinitions = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var metadata = "";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var thisClassFields = {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>thisClassMethods = {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>thisClassInners = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.getMembers(thisClassFields, thisClassMethods, thisClassInners);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var name = subject.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (name === "this") return subject.callSign || !subject.member ? selfId + ".$self" : selfId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (thisClassFields.hasOwnProperty(name)) return thisClassFields[name].isStatic ? className + "." + name : selfId + "." + name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (thisClassInners.hasOwnProperty(name)) return selfId + "." + name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (thisClassMethods.hasOwnProperty(name)) return thisClassMethods[name].isStatic ? className + "." + name : selfId + ".$self." + name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return oldContext(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var resolvedBaseClassName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.baseClassName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>resolvedBaseClassName = oldContext({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>name: this.baseClassName</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result += "var $super = { $upcast: " + selfId + " };\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>result += "function $superCstr(){" + resolvedBaseClassName + ".apply($super,arguments);if(!('$self' in $super)) $p.extendClassChain($super)}\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>metadata += className + ".$base = " + resolvedBaseClassName + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else result += "function $superCstr(){$p.extendClassChain(" + selfId + ")}\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.owner.base) staticDefinitions += "$p.extendStaticMembers(" + className + ", " + resolvedBaseClassName + ");\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i, l, j, m;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.owner.interfaces) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var resolvedInterfaces = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resolvedInterface;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (i = 0, l = this.interfacesNames.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!this.owner.interfaces[i]) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resolvedInterface = oldContext({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>name: this.interfacesNames[i]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resolvedInterfaces.push(resolvedInterface);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>staticDefinitions += "$p.extendInterfaceMembers(" + className + ", " + resolvedInterface + ");\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>metadata += className + ".$interfaces = [" + resolvedInterfaces.join(", ") + "];\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.functions.length &gt; 0) result += this.functions.join("\n") + "\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sortByWeight(this.innerClasses);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.innerClasses.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var innerClass = this.innerClasses[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (innerClass.isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>staticDefinitions += className + "." + innerClass.name + " = " + innerClass + ";\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>result += selfId + "." + innerClass.name + " = " + className + "." + innerClass.name + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else result += selfId + "." + innerClass.name + " = " + innerClass + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.fields.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var field = this.fields[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (field.isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>staticDefinitions += className + "." + field.definitions.join(";\n" + className + ".") + ";\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (j = 0, m = field.definitions.length; j &lt; m; ++j) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var fieldName = field.definitions[j].name,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>staticName = className + "." + fieldName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>result += "$p.defineProperty(" + selfId + ", '" + fieldName + "', {" + "get: function(){return " + staticName + "}, " + "set: function(val){" + staticName + " = val}});\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else result += selfId + "." + field.definitions.join(";\n" + selfId + ".") + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var methodOverloads = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.methods.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var method = this.methods[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var overload = methodOverloads[method.name];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var methodId = method.name + "$" + method.params.params.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var hasMethodArgs = !!method.params.methodArgsParam;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (overload) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>++overload;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>methodId += "_" + overload</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else overload = 1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>method.methodId = methodId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>methodOverloads[method.name] = overload;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (method.isStatic) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>staticDefinitions += method;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>staticDefinitions += "$p.addMethod(" + className + ", '" + method.name + "', " + methodId + ", " + hasMethodArgs + ");\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>result += "$p.addMethod(" + selfId + ", '" + method.name + "', " + methodId + ", " + hasMethodArgs + ");\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>result += method;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>result += "$p.addMethod(" + selfId + ", '" + method.name + "', " + methodId + ", " + hasMethodArgs + ");\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>result += trim(this.misc.tail);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.cstrs.length &gt; 0) result += this.cstrs.join("\n") + "\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>result += "function $constr() {\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var cstrsIfs = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0, l = this.cstrs.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var paramsLength = this.cstrs[i].params.params.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var methodArgsPresent = !!this.cstrs[i].params.methodArgsParam;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cstrsIfs.push("if(arguments.length " + (methodArgsPresent ? "&gt;=" : "===") + " " + paramsLength + ") { " + "$constr_" + paramsLength + ".apply(" + selfId + ", arguments); }")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (cstrsIfs.length &gt; 0) result += cstrsIfs.join(" else ") + " else ";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>result += "$superCstr();\n}\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>result += "$constr.apply(null, arguments);\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "(function() {\n" + "function " + className + "() {\n" + result + "}\n" + staticDefinitions + metadata + "return " + className + ";\n" + "})()"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>transformClassBody = function(body, name, baseName, interfaces) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var declarations = body.substring(1, body.length - 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>declarations = extractClassesAndMethods(declarations);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>declarations = extractConstructors(declarations, name);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var methods = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>classes = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cstrs = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>functions = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>declarations = declarations.replace(/"([DEGH])(\d+)"/g, function(all, type, index) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (type === "D") methods.push(index);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (type === "E") classes.push(index);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (type === "H") functions.push(index);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else cstrs.push(index);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return ""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var fields = declarations.replace(/^(?:\s*;)+/, "").split(/;(?:\s*;)*/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var baseClassName, interfacesNames;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (baseName !== undef) baseClassName = baseName.replace(/^\s*extends\s+([A-Za-z_$][\w$]*\b(?:\s*\.\s*[A-Za-z_$][\w$]*\b)*)\s*$/g, "$1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (interfaces !== undef) interfacesNames = interfaces.replace(/^\s*implements\s+(.+?)\s*$/g, "$1").split(/\s*,\s*/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; functions.length; ++i) functions[i] = transformFunction(atoms[functions[i]]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; methods.length; ++i) methods[i] = transformClassMethod(atoms[methods[i]]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; fields.length - 1; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var field = trimSpaces(fields[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fields[i] = transformClassField(field.middle)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var tail = fields.pop();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; cstrs.length; ++i) cstrs[i] = transformConstructor(atoms[cstrs[i]]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i = 0; i &lt; classes.length; ++i) classes[i] = transformInnerClass(atoms[classes[i]]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstClassBody(name, baseClassName, interfacesNames, functions, methods, fields, cstrs, classes, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tail: tail</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstInterface(name, body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>body.owner = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstInterface.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "var " + this.name + " = " + this.body + ";\n" + "$p." + this.name + " = " + this.name + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstClass(name, body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>body.owner = this</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstClass.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "var " + this.name + " = " + this.body + ";\n" + "$p." + this.name + " = " + this.name + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformGlobalClass(class_) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m = classesRegex.exec(class_);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>classesRegex.lastIndex = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var body = atoms[getAtomIndex(m[6])];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldClassId = currentClassId,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>newClassId = generateClassId();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentClassId = newClassId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var globalClass;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (m[2] === "interface") globalClass = new AstInterface(m[3], transformInterfaceBody(body, m[3], m[4]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else globalClass = new AstClass(m[3], transformClassBody(body, m[3], m[4], m[5]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>appendClass(globalClass, newClassId, oldClassId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>currentClassId = oldClassId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return globalClass</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstMethod(name, params, body) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params = params;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.body = body</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstMethod.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var paramNames = appendToLookupTable({},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.params.getNames());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return paramNames.hasOwnProperty(subject.name) ? subject.name : oldContext(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var body = this.params.prependMethodArgs(this.body.toString());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "function " + this.name + this.params + " " + body + "\n" + "$p." + this.name + " = " + this.name + ";";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function transformGlobalMethod(method) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var m = methodsRegex.exec(method);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = methodsRegex.lastIndex = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstMethod(m[3], transformParams(atoms[getAtomIndex(m[4])]), transformStatementsBlock(atoms[getAtomIndex(m[6])]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function preStatementsTransform(statements) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var s = statements;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>s = s.replace(/\b(catch\s*"B\d+"\s*"A\d+")(\s*catch\s*"B\d+"\s*"A\d+")+/g, "$1");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return s</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstForStatement(argument, misc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.argument = argument;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.misc = misc</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstForStatement.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.misc.prefix + this.argument.toString()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstCatchStatement(argument, misc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.argument = argument;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.misc = misc</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstCatchStatement.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.misc.prefix + this.argument.toString()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstPrefixStatement(name, argument, misc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.name = name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.argument = argument;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.misc = misc</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstPrefixStatement.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = this.misc.prefix;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (this.argument !== undef) result += this.argument.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstSwitchCase(expr) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.expr = expr</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstSwitchCase.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return "case " + this.expr + ":"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstLabel(label) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.label = label</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstLabel.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return this.label</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>transformStatements = function(statements, transformMethod, transformClass) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var nextStatement = new RegExp(/\b(catch|for|if|switch|while|with)\s*"B(\d+)"|\b(do|else|finally|return|throw|try|break|continue)\b|("[ADEH](\d+)")|\b(case)\s+([^:]+):|\b([A-Za-z_$][\w$]*\s*:)|(;)/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var res = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>statements = preStatementsTransform(statements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var lastIndex = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>m, space;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while ((m = nextStatement.exec(statements)) !== null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (m[1] !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var i = statements.lastIndexOf('"B', nextStatement.lastIndex);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var statementsPrefix = statements.substring(lastIndex, i);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (m[1] === "for") res.push(new AstForStatement(transformForExpression(atoms[m[2]]), {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>prefix: statementsPrefix</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (m[1] === "catch") res.push(new AstCatchStatement(transformParams(atoms[m[2]]), {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>prefix: statementsPrefix</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else res.push(new AstPrefixStatement(m[1], transformExpression(atoms[m[2]]), {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>prefix: statementsPrefix</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (m[3] !== undef) res.push(new AstPrefixStatement(m[3], undef, {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>prefix: statements.substring(lastIndex, nextStatement.lastIndex)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (m[4] !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>space = statements.substring(lastIndex, nextStatement.lastIndex - m[4].length);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (trim(space).length !== 0) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>res.push(space);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var kind = m[4].charAt(1),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>atomIndex = m[5];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (kind === "D") res.push(transformMethod(atoms[atomIndex]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (kind === "E") res.push(transformClass(atoms[atomIndex]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (kind === "H") res.push(transformFunction(atoms[atomIndex]));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else res.push(transformStatementsBlock(atoms[atomIndex]))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else if (m[6] !== undef) res.push(new AstSwitchCase(transformExpression(trim(m[7]))));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (m[8] !== undef) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>space = statements.substring(lastIndex, nextStatement.lastIndex - m[8].length);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (trim(space).length !== 0) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>res.push(new AstLabel(statements.substring(lastIndex, nextStatement.lastIndex)))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var statement = trimSpaces(statements.substring(lastIndex, nextStatement.lastIndex - 1));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>res.push(statement.left);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>res.push(transformStatement(statement.middle));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>res.push(statement.right + ";")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>lastIndex = nextStatement.lastIndex</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var statementsTail = trimSpaces(statements.substring(lastIndex));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>res.push(statementsTail.left);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (statementsTail.middle !== "") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>res.push(transformStatement(statementsTail.middle));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>res.push(";" + statementsTail.right)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return res</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function getLocalNames(statements) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var localNames = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, l = statements.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var statement = statements[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (statement instanceof AstVar) localNames = localNames.concat(statement.getNames());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (statement instanceof AstForStatement &amp;&amp; statement.argument.initStatement instanceof AstVar) localNames = localNames.concat(statement.argument.initStatement.getNames());</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (statement instanceof AstInnerInterface || statement instanceof AstInnerClass || statement instanceof AstInterface || statement instanceof AstClass || statement instanceof AstMethod || statement instanceof AstFunction) localNames.push(statement.name)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return appendToLookupTable({},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>localNames)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstStatementsBlock(statements) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.statements = statements</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstStatementsBlock.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var localNames = getLocalNames(this.statements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var oldContext = replaceContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!isLookupTableEmpty(localNames)) replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return localNames.hasOwnProperty(subject.name) ? subject.name : oldContext(subject)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "{\n" + this.statements.join("") + "\n}";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = oldContext;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>transformStatementsBlock = function(block) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var content = trimSpaces(block.substring(1, block.length - 1));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstStatementsBlock(transformStatements(content.middle))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function AstRoot(statements) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>this.statements = statements</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>AstRoot.prototype.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var classes = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>otherStatements = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>statement;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, len = this.statements.length; i &lt; len; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>statement = this.statements[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (statement instanceof AstClass || statement instanceof AstInterface) classes.push(statement);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else otherStatements.push(statement)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sortByWeight(classes);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var localNames = getLocalNames(this.statements);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = function(subject) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var name = subject.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (localNames.hasOwnProperty(name)) return name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (globalMembers.hasOwnProperty(name) || PConstants.hasOwnProperty(name) || defaultScope.hasOwnProperty(name)) return "$p." + name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return name</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var result = "// this code was autogenerated from PJS\n" + "(function($p) {\n" + classes.join("") + "\n" + otherStatements.join("") + "\n})";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>replaceContext = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return result</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>transformMain = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var statements = extractClassesAndMethods(atoms[0]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>statements = statements.replace(/\bimport\s+[^;]+;/g, "");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return new AstRoot(transformStatements(statements, transformGlobalMethod, transformGlobalClass))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function generateMetadata(ast) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var globalScope = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var id, class_;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (id in declaredClasses) if (declaredClasses.hasOwnProperty(id)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>class_ = declaredClasses[id];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var scopeId = class_.scopeId,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>name = class_.name;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (scopeId) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var scope = declaredClasses[scopeId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>class_.scope = scope;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (scope.inScope === undef) scope.inScope = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>scope.inScope[name] = class_</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else globalScope[name] = class_</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function findInScopes(class_, name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var parts = name.split(".");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var currentScope = class_.scope,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>found;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (currentScope) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (currentScope.hasOwnProperty(parts[0])) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>found = currentScope[parts[0]];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>break</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>currentScope = currentScope.scope</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (found === undef) found = globalScope[parts[0]];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var i = 1, l = parts.length; i &lt; l &amp;&amp; found; ++i) found = found.inScope[parts[i]];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return found</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (id in declaredClasses) if (declaredClasses.hasOwnProperty(id)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>class_ = declaredClasses[id];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var baseClassName = class_.body.baseClassName;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (baseClassName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var parent = findInScopes(class_, baseClassName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (parent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>class_.base = parent;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!parent.derived) parent.derived = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>parent.derived.push(class_)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var interfacesNames = class_.body.interfacesNames,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>interfaces = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>i, l;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (interfacesNames &amp;&amp; interfacesNames.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0, l = interfacesNames.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>var interface_ = findInScopes(class_, interfacesNames[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>interfaces.push(interface_);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!interface_) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!interface_.derived) interface_.derived = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>interface_.derived.push(class_)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (interfaces.length &gt; 0) class_.interfaces = interfaces</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function setWeight(ast) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var queue = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tocheck = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var id, scopeId, class_;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (id in declaredClasses) if (declaredClasses.hasOwnProperty(id)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>class_ = declaredClasses[id];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!class_.inScope &amp;&amp; !class_.derived) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>queue.push(id);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>class_.weight = 0</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var dependsOn = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (class_.inScope) for (scopeId in class_.inScope) if (class_.inScope.hasOwnProperty(scopeId)) dependsOn.push(class_.inScope[scopeId]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (class_.derived) dependsOn = dependsOn.concat(class_.derived);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>tocheck[id] = dependsOn</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function removeDependentAndCheck(targetId, from) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var dependsOn = tocheck[targetId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!dependsOn) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i = dependsOn.indexOf(from);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (i &lt; 0) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>dependsOn.splice(i, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (dependsOn.length &gt; 0) return false;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>delete tocheck[targetId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return true</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>while (queue.length &gt; 0) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>id = queue.shift();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>class_ = declaredClasses[id];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (class_.scopeId &amp;&amp; removeDependentAndCheck(class_.scopeId, class_)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>queue.push(class_.scopeId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>declaredClasses[class_.scopeId].weight = class_.weight + 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (class_.base &amp;&amp; removeDependentAndCheck(class_.base.classId, class_)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>queue.push(class_.base.classId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>class_.base.weight = class_.weight + 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (class_.interfaces) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var i, l;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (i = 0, l = class_.interfaces.length; i &lt; l; ++i) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>if (!class_.interfaces[i] || !removeDependentAndCheck(class_.interfaces[i].classId, class_)) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>queue.push(class_.interfaces[i].classId);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>class_.interfaces[i].weight = class_.weight + 1</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var transformed = transformMain();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>generateMetadata(transformed);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>setWeight(transformed);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var redendered = transformed.toString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>redendered = redendered.replace(/\s*\n(?:[\t ]*\n)+/g, "\n\n");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>redendered = redendered.replace(/__x([0-9A-F]{4})/g, function(all, hexCode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return String.fromCharCode(parseInt(hexCode, 16))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>});</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return injectStrings(redendered, strings)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>function preprocessCode(aCode, sketch) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var dm = (new RegExp(/\/\*\s*@pjs\s+((?:[^\*]|\*+[^\*\/])*)\*\//g)).exec(aCode);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (dm &amp;&amp; dm.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var jsonItems = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>directives = dm.splice(1, 2)[0].replace(/\{([\s\S]*?)\}/g, function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return function(all, item) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>jsonItems.push(item);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return "{" + (jsonItems.length - 1) + "}"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}()).replace("\n", "").replace("\r", "").split(";");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var clean = function(s) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return s.replace(/^\s*["']?/, "").replace(/["']?\s*$/, "")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (var i = 0, dl = directives.length; i &lt; dl; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var pair = directives[i].split("=");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (pair &amp;&amp; pair.length === 2) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var key = clean(pair[0]),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>value = clean(pair[1]),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>list = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (key === "preload") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>list = value.split(",");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (var j = 0, jl = list.length; j &lt; jl; j++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>var imageName = clean(list[j]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>sketch.imageCache.add(imageName)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (key === "font") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>list = value.split(",");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>for (var x = 0, xl = list.length; x &lt; xl; x++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>var fontName = clean(list[x]),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>index = /^\{(\d*?)\}$/.exec(fontName);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>PFont.preloading.add(index ? JSON.parse("{" + jsonItems[index[1]] + "}") : fontName)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else if (key === "pauseOnBlur") sketch.options.pauseOnBlur = value === "true";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (key === "globalKeyEvents") sketch.options.globalKeyEvents = value === "true";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (key.substring(0, 6) === "param-") sketch.params[key.substring(6)] = value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else sketch.options[key] = value</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return aCode</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.compile = function(pdeCode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var sketch = new Processing.Sketch;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var code = preprocessCode(pdeCode, sketch);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var compiledPde = parseProcessing(code);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>sketch.sourceCode = compiledPde;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return sketch</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var tinylogLite = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var tinylogLite = {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>undef = "undefined",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>func = "function",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>False = !1,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>True = !0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>logLimit = 512,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>log = "log";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (typeof tinylog !== undef &amp;&amp; typeof tinylog[log] === func) tinylogLite[log] = tinylog[log];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>else if (typeof document !== undef &amp;&amp; !document.fake)(function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var doc = document,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>$div = "div",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>$style = "style",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>$title = "title",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>containerStyles = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>zIndex: 1E4,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>position: "fixed",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>bottom: "0px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>width: "100%",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height: "15%",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fontFamily: "sans-serif",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>color: "#ccc",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>backgroundColor: "black"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>outputStyles = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>position: "relative",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fontFamily: "monospace",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>overflow: "auto",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height: "100%",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>paddingTop: "5px"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>resizerStyles = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>height: "5px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>marginTop: "-5px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cursor: "n-resize",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>backgroundColor: "darkgrey"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>closeButtonStyles = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>position: "absolute",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>top: "5px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>right: "20px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>color: "#111",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>MozBorderRadius: "4px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>webkitBorderRadius: "4px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>borderRadius: "4px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>cursor: "pointer",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fontWeight: "normal",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>textAlign: "center",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>padding: "3px 5px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>backgroundColor: "#333",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fontSize: "12px"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>entryStyles = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>minHeight: "16px"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>entryTextStyles = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fontSize: "12px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>margin: "0 8px 0 8px",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>maxWidth: "100%",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>whiteSpace: "pre-wrap",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>overflow: "auto"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>view = doc.defaultView,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>docElem = doc.documentElement,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>docElemStyle = docElem[$style],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>setStyles = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var i = arguments.length,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>elemStyle, styles, style;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (i--) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>styles = arguments[i--];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>elemStyle = arguments[i][$style];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>for (style in styles) if (styles.hasOwnProperty(style)) elemStyle[style] = styles[style]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>observer = function(obj, event, handler) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (obj.addEventListener) obj.addEventListener(event, handler, False);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (obj.attachEvent) obj.attachEvent("on" + event, handler);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return [obj, event, handler]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>unobserve = function(obj, event, handler) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (obj.removeEventListener) obj.removeEventListener(event, handler, False);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else if (obj.detachEvent) obj.detachEvent("on" + event, handler)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>clearChildren = function(node) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var children = node.childNodes,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>child = children.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>while (child--) node.removeChild(children.item(0))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>append = function(to, elem) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return to.appendChild(elem)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>createElement = function(localName) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return doc.createElement(localName)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>createTextNode = function(text) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return doc.createTextNode(text)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>createLog = tinylogLite[log] = function(message) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var uninit, originalPadding = docElemStyle.paddingBottom,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>container = createElement($div),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>containerStyle = container[$style],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resizer = append(container, createElement($div)),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>output = append(container, createElement($div)),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>closeButton = append(container, createElement($div)),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resizingLog = False,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>previousHeight = False,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>previousScrollTop = False,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>messages = 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>updateSafetyMargin = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>docElemStyle.paddingBottom = container.clientHeight + "px"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>setContainerHeight = function(height) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var viewHeight = view.innerHeight,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>resizerHeight = resizer.clientHeight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (height &lt; 0) height = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (height + resizerHeight &gt; viewHeight) height = viewHeight - resizerHeight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>containerStyle.height = height / viewHeight * 100 + "%";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>updateSafetyMargin()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>observers = [observer(doc, "mousemove", function(evt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (resizingLog) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>setContainerHeight(view.innerHeight - evt.clientY);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>output.scrollTop = previousScrollTop</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}), observer(doc, "mouseup", function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (resizingLog) resizingLog = previousScrollTop = False</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}), observer(resizer, "dblclick", function(evt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>evt.preventDefault();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (previousHeight) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>setContainerHeight(previousHeight);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>previousHeight = False</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>previousHeight = container.clientHeight;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>containerStyle.height = "0px"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}), observer(resizer, "mousedown", function(evt) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>evt.preventDefault();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resizingLog = True;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>previousScrollTop = output.scrollTop</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}), observer(resizer, "contextmenu", function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>resizingLog = False</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}), observer(closeButton, "click", function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>uninit()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>})];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>uninit = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var i = observers.length;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (i--) unobserve.apply(tinylogLite, observers[i]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>docElem.removeChild(container);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>docElemStyle.paddingBottom = originalPadding;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>clearChildren(output);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>clearChildren(container);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>tinylogLite[log] = createLog</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>setStyles(container, containerStyles, output, outputStyles, resizer, resizerStyles, closeButton, closeButtonStyles);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>closeButton[$title] = "Close Log";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>append(closeButton, createTextNode("\u2716"));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>resizer[$title] = "Double-click to toggle log minimization";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>docElem.insertBefore(container, docElem.firstChild);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tinylogLite[log] = function(message) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (messages === logLimit) output.removeChild(output.firstChild);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else messages++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var entry = append(output, createElement($div)),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>entryText = append(entry, createElement($div));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>entry[$title] = (new Date).toLocaleTimeString();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>setStyles(entry, entryStyles, entryText, entryTextStyles);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>append(entryText, createTextNode(message));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>output.scrollTop = output.scrollHeight</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>tinylogLite[log](message);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateSafetyMargin()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>})();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>else if (typeof print === func) tinylogLite[log] = print;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return tinylogLite</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.logger = tinylogLite;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.version = "1.4.1";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.lib = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.registerLibrary = function(name, desc) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Processing.lib[name] = desc;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (desc.hasOwnProperty("init")) desc.init(defaultScope)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.instances = processingInstances;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.getInstanceById = function(name) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return processingInstances[processingInstanceIds[name]]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.Sketch = function(attachFunction) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.attachFunction = attachFunction;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.options = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pauseOnBlur: false,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>globalKeyEvents: false</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.onLoad = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.onSetup = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.onPause = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.onLoop = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.onFrameStart = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.onFrameEnd = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.onExit = nop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.params = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.imageCache = {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>pending: 0,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>images: {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>operaCache: {},</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>add: function(href, img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (this.images[href]) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!isDOMPresent) this.images[href] = null;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (!img) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>img = new Image;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>img.onload = function(owner) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>owner.pending--</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}(this);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>this.pending++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>img.src = href</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.images[href] = img;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (window.opera) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var div = document.createElement("div");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>div.appendChild(img);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>div.style.position = "absolute";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>div.style.opacity = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>div.style.width = "1px";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>div.style.height = "1px";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!this.operaCache[href]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>document.body.appendChild(div);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>this.operaCache[href] = div</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.sourceCode = undefined;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.attach = function(processing) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (typeof this.attachFunction === "function") this.attachFunction(processing);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>else if (this.sourceCode) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var func = (new Function("return (" + this.sourceCode + ");"))();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>func(processing);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>this.attachFunction = func</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} else throw "Unable to attach sketch to the processing instance";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>this.toString = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var i;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var code = "((function(Sketch) {\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>code += "var sketch = new Sketch(\n" + this.sourceCode + ");\n";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i in this.options) if (this.options.hasOwnProperty(i)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var value = this.options[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>code += "sketch.options." + i + " = " + (typeof value === "string" ? '"' + value + '"' : "" + value) + ";\n"</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>for (i in this.imageCache) if (this.options.hasOwnProperty(i)) code += 'sketch.imageCache.add("' + i + '");\n';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>code += "return sketch;\n})(Processing.Sketch))";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>return code</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var loadSketchFromSources = function(canvas, sources) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var code = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>errors = [],</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>sourcesCount = sources.length,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>loaded = 0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function ajaxAsync(url, callback) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var xhr = new XMLHttpRequest;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>xhr.onreadystatechange = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (xhr.readyState === 4) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var error;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (xhr.status !== 200 &amp;&amp; xhr.status !== 0) error = "Invalid XHR status " + xhr.status;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else if (xhr.responseText === "") if ("withCredentials" in new XMLHttpRequest &amp;&amp; (new XMLHttpRequest).withCredentials === false &amp;&amp; window.location.protocol === "file:") error = "XMLHttpRequest failure, possibly due to a same-origin policy violation. You can try loading this page in another browser, or load it from http://localhost using a local webserver. See the Processing.js README for a more detailed explanation of this problem and solutions.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>else error = "File is empty.";</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>callback(xhr.responseText, error)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>xhr.open("GET", url, true);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (xhr.overrideMimeType) xhr.overrideMimeType("application/json");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>xhr.setRequestHeader("If-Modified-Since", "Fri, 01 Jan 1960 00:00:00 GMT");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>xhr.send(null)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function loadBlock(index, filename) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>function callback(block, error) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>code[index] = block;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>++loaded;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (error) errors.push(filename + " ==&gt; " + error);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (loaded === sourcesCount) if (errors.length === 0) try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>return new Processing(canvas, code.join("\n"))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} catch(e) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>throw "Processing.js: Unable to execute pjs sketch: " + e;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>} else throw "Processing.js: Unable to load pjs sketch files: " + errors.join("\n");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (filename.charAt(0) === "#") {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var scriptElement = document.getElementById(filename.substring(1));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (scriptElement) callback(scriptElement.text || scriptElement.textContent);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else callback("", "Unable to load pjs sketch: element with id '" + filename.substring(1) + "' was not found");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>ajaxAsync(filename, callback)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (var i = 0; i &lt; sourcesCount; ++i) loadBlock(i, sources[i])</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>var init = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>document.removeEventListener("DOMContentLoaded", init, false);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>processingInstances = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var canvas = document.getElementsByTagName("canvas"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>filenames;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (var i = 0, l = canvas.length; i &lt; l; i++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var processingSources = canvas[i].getAttribute("data-processing-sources");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (processingSources === null) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>processingSources = canvas[i].getAttribute("data-src");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (processingSources === null) processingSources = canvas[i].getAttribute("datasrc")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (processingSources) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>filenames = processingSources.split(/\s+/g);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (var j = 0; j &lt; filenames.length;) if (filenames[j]) j++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else filenames.splice(j, 1);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>loadSketchFromSources(canvas[i], filenames)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>var s, last, source, instance, nodelist = document.getElementsByTagName("script"),</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>scripts = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (s = nodelist.length - 1; s &gt;= 0; s--) scripts.push(nodelist[s]);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>for (s = 0, last = scripts.length; s &lt; last; s++) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var script = scripts[s];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (!script.getAttribute) continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>var type = script.getAttribute("type");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>if (type &amp;&amp; (type.toLowerCase() === "text/processing" || type.toLowerCase() === "application/processing")) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>var target = script.getAttribute("data-processing-target");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>canvas = undef;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (target) canvas = document.getElementById(target);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>var nextSibling = script.nextSibling;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>while (nextSibling &amp;&amp; nextSibling.nodeType !== 1) nextSibling = nextSibling.nextSibling;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (nextSibling &amp;&amp; nextSibling.nodeName.toLowerCase() === "canvas") canvas = nextSibling</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if (canvas) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (script.getAttribute("src")) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>filenames = script.getAttribute("src").split(/\s+/);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>loadSketchFromSources(canvas, filenames);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>continue</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>source = script.textContent || script.text;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>instance = new Processing(canvas, source)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.reload = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (processingInstances.length &gt; 0) for (var i = processingInstances.length - 1; i &gt;= 0; i--) if (processingInstances[i]) processingInstances[i].exit();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>init()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.loadSketchFromSources = loadSketchFromSources;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>Processing.disableInit = function() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if (isDOMPresent) document.removeEventListener("DOMContentLoaded", init, false)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if (isDOMPresent) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>window["Processing"] = Processing;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>document.addEventListener("DOMContentLoaded", init, false)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>} else this.Processing = Processing</span></p>
<p class="p1"><span class="s1">})(window, window.document, Math);</span></p>
</body>
</html>
